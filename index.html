<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>yuzi chat</title>

<!-- æ–°å¢ï¼šä»Google Fontså¼•å…¥åœ¨çº¿å­—ä½“ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
  
    <!-- CSSæ ·å¼å°†å†™åœ¨è¿™é‡Œ -->
    <style>
        /* è®©æ•´ä¸ªé¡µé¢æ²¡æœ‰å¤šä½™çš„è¾¹è·ï¼Œå¹¶è®¾ç½®ä¸€ä¸ªèƒŒæ™¯è‰²ï¼Œæ–¹ä¾¿æˆ‘ä»¬çœ‹æ¸…æ‰‹æœºå±å¹•çš„è¾¹ç•Œ */
        body {
    margin: 0;
    padding: 0;
    background-color: #f0f0f0; /* é¡µé¢èƒŒæ™¯è‰² */
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh; /* é¡µé¢é«˜åº¦å æ»¡æ•´ä¸ªæµè§ˆå™¨çª—å£ */
    /* --- æ–°å¢ï¼šä½¿ç”¨ç³»ç»Ÿé»˜è®¤å­—ä½“ --- */
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
}

        /* è¿™æ˜¯æˆ‘ä»¬çš„æ‰‹æœºä¸»å±å¹• */
        #phone-screen {
    /* å®šä¹‰é¢œè‰²â€œå¤–å·â€çš„é»˜è®¤å€¼ */
    --theme-default-bg: #eeeeee; /* é»˜è®¤èƒŒæ™¯è‰² */
    --theme-accent-color: #eeeeee; /* é»˜è®¤å¼ºè°ƒè‰²ï¼ˆç”¨äºå›¾æ ‡å’Œé¡¶æ ï¼‰ */

    width: 375px;
    height: 667px;
    background-color: var(--theme-default-bg); /* ä½¿ç”¨â€œå¤–å·â€ */
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

        /* å±å¹•é¡¶éƒ¨çš„çŠ¶æ€æ  */
        #status-bar {
            display: flex;
            justify-content: space-between; /* è®©å·¦å³ä¸¤è¾¹çš„å…ƒç´ åˆ†å¼€ */
            align-items: center;
            padding: 5px 10px; /* å†…éƒ¨ç•™ç™½ï¼Œä¸Šä¸‹5pxï¼Œå·¦å³10px */
            color: #333; /* æ—¶é—´çš„æ·±è‰²å­—ä½“ */
            font-family: sans-serif; /* ä½¿ç”¨ä¸€ä¸ªç®€æ´çš„æ— è¡¬çº¿å­—ä½“ */
            font-size: 14px;
        }
        
        /* æ—¶é—´æ˜¾ç¤ºåŒºåŸŸ */
        #time-display {
            font-weight: bold;
        }

        /* ç”µæ± å›¾æ ‡çš„å®¹å™¨ */
        #battery-icon {
            width: 24px;
            height: 12px;
            border: 1.5px solid white; /* ç™½è‰²è¾¹æ¡† */
            border-radius: 3px; /* è½»å¾®çš„åœ†è§’ */
            position: relative; /* ç”¨äºå®šä½ç”µæ± æ­£æå¤´ */
            padding: 1px;
            box-sizing: border-box;
        }

        /* ç”µæ± çš„æ­£æå°å¤´ */
        #battery-icon::after {
            content: '';
            position: absolute;
            right: -4px;
            top: 2px;
            width: 2px;
            height: 6px;
            background-color: white;
            border-radius: 0 1px 1px 0;
        }

        /* æ˜¾ç¤ºç”µé‡çš„éƒ¨åˆ† */
        #battery-level {
            width: 50%; /* æš‚æ—¶å…ˆæ˜¾ç¤º50%ç”µé‡ */
            height: 100%;
            background-color: grey; /* ç”µé‡çš„é»˜è®¤é¢œè‰² */
            border-radius: 1px;
        }
        
        /* --- å…¨æ–°ç¾åŒ–çš„ä¸»å±å¹•æ ·å¼ --- */
#main-content {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px; /* è°ƒæ•´å†…è¾¹è·ï¼Œè®©å†…å®¹æ›´èˆ’å±• */
    gap: 25px; /* å¢å¤§å¤´åƒåŒºåŸŸå’Œå›¾æ ‡åŒºåŸŸçš„é—´è· */
    box-sizing: border-box;
}

#avatar-container {
    position: relative;
    width: 90%; /* å®½åº¦å å±å¹•çš„90%ï¼Œçœ‹èµ·æ¥æ›´åè°ƒ */
    height: 25%; /* é«˜åº¦å å±å¹•çš„25%ï¼Œä¹Ÿå°±æ˜¯å››åˆ†ä¹‹ä¸€ */
    display: flex;
    justify-content: center;
    align-items: center;
    flex-shrink: 0;
    margin-bottom: 20px; /* å’Œä¸‹é¢çš„å›¾æ ‡ç•™å‡ºä¸€äº›è·ç¦» */
}

/* --- æ–°å¢ï¼šå¤´åƒåé¢çš„è£…é¥°èƒŒæ™¯ --- */
#avatar-container::before {
    content: ''; /* è¿™æ˜¯è®©è¿™ä¸ªâ€œå¹½çµâ€å…ƒç´ æ˜¾ç¤ºå‡ºæ¥çš„å’’è¯­ */
    position: absolute;
    width: 100%; /* å®½åº¦å’Œå¤´åƒå®¹å™¨ä¸€æ ·å®½ */
    height: 100%; /* é«˜åº¦å’Œå¤´åƒå®¹å™¨ä¸€æ ·é«˜ */
    background-color: rgba(255, 255, 255, 0.4); /* åŠé€æ˜ç™½è‰²ï¼Œå’Œå›¾æ ‡é£æ ¼ç»Ÿä¸€ */
    backdrop-filter: blur(10px); /* æ¯›ç»ç’ƒæ•ˆæœï¼Œè®©å®ƒæ›´æ¢¦å¹» */
    border-radius: 20px; /* æ‚¨è¦çš„åœ†è§’ */
    z-index: 1; /* æŠŠå®ƒæ”¾åœ¨å¤´åƒçš„åé¢ (å¤´åƒæ˜¯2ï¼Œå®ƒå°±æ˜¯1) */
}

#avatar-img {
    width: 70px;
    height: 70px;
    background-color: #a0a0a0;
    border-radius: 50%;
    position: relative;
    z-index: 2;
    cursor: pointer;
    object-fit: cover;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    transition: transform 0.2s ease;
}
#avatar-img:hover {
    transform: scale(1.1); /* é¼ æ ‡æ‚¬åœæ—¶æ”¾å¤§ä¸€ç‚¹ */
}

#app-drawer {
    width: 100%;
    padding: 0 10px;
    box-sizing: border-box;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    gap: 20px; /* æŠŠå›¾æ ‡é—´çš„è·ç¦»ä» 25px è°ƒå°åˆ° 20pxï¼Œæ›´åè°ƒ */
    flex-wrap: wrap;
}

.app-icon {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 60px;
    gap: 6px; /* å›¾æ ‡å’Œæ–‡å­—çš„é—´è·ä¹Ÿè°ƒå°ä¸€ç‚¹ */
    cursor: pointer;
    text-align: center;
}

.app-icon svg {
    width: 20px; /* å…³é”®æ”¹åŠ¨1ï¼šæŠŠå°ºå¯¸ä» 55px ç¼©å°åˆ° 50px */
    height: 20px; /* å…³é”®æ”¹åŠ¨1ï¼šæŠŠå°ºå¯¸ä» 55px ç¼©å°åˆ° 50px */
    background-color: rgba(255, 255, 255, 0.5); /* å…³é”®æ”¹åŠ¨2ï¼šæŠŠèƒŒæ™¯ä»çº¯ç™½å˜æˆå¸¦50%é€æ˜åº¦çš„ç™½è‰² */
    backdrop-filter: blur(8px); /* å…³é”®æ”¹åŠ¨3ï¼šè¿™å°±æ˜¯â€œæ¯›ç»ç’ƒâ€æ•ˆæœçš„é­”æ³•ï¼è®©èƒŒæ™¯å˜æ¨¡ç³Š */
    border-radius: 16px;
    padding: 8px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.07);
    fill: #555; /* æŠŠå›¾æ ‡æœ¬èº«çš„é¢œè‰²è°ƒæ·±ä¸€ç‚¹ï¼Œåœ¨åŠé€æ˜èƒŒæ™¯ä¸Šæ›´æ¸…æ™° */
    transition: all 0.2s ease-in-out;
    border: 1px solid rgba(255, 255, 255, 0.2); /* é”¦ä¸Šæ·»èŠ±ï¼šåŠ ä¸€ä¸ªæ·¡æ·¡çš„ç™½è‰²è¾¹æ¡†ï¼Œè´¨æ„Ÿæ›´å¥½ */
}
.app-icon:hover svg {
    transform: translateY(-4px); /* é¼ æ ‡æ‚¬åœæ—¶å‘ä¸Šæµ®åŠ¨ */
    box-shadow: 0 6px 15px rgba(0,0,0,0.1);
    fill: #555;
}

.app-icon span {
    font-size: 12px;
    color: #555; /* å­—ä½“é¢œè‰²å˜æ·±ä¸€ç‚¹ */
    font-weight: 500;
}
        
        /* --- æ–°å¢çš„åº”ç”¨é¡µé¢æ ·å¼ --- */
        .app-page {
            position: absolute; /* ç»å¯¹å®šä½ï¼Œè¦†ç›–åœ¨ä¸»å±å¹•ä¸Š */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #ffffff; /* é¡µé¢èƒŒæ™¯ä¸ºç™½è‰² */
            z-index: 10; /* ç¡®ä¿å®ƒåœ¨æœ€ä¸Šå±‚ */
            display: none; /* å…³é”®ï¼šé»˜è®¤éšè— */
            flex-direction: column; /* å†…éƒ¨å…ƒç´ å‚ç›´æ’åˆ— */
        }

        .page-header {
    display: flex;
    align-items: center;
    padding: 10px 15px;
    background-color: var(--theme-accent-color);
    flex-shrink: 0; /* é˜²æ­¢é¡¶æ è¢«å‹ç¼© */
    position: relative;
    border-bottom: 1px solid rgba(0,0,0,0.05);
}
        
        .page-header h2 {
            margin: 0 auto; /* è®©æ ‡é¢˜å±…ä¸­ */
            font-size: 16px;
            color: #333;
        }

        .back-button, .add-button {
            font-size: 24px;
            font-weight: bold;
            color: #555;
            cursor: pointer;
            position: absolute; /* ç»å¯¹å®šä½ä»¥æ”¾ç½®åœ¨è§’è½ */
        }
        
        .back-button {
            left: 15px;
        }

        .add-button {
            right: 15px;
        }
        
        .refresh-button {
    font-size: 20px; /* è°ƒæ•´ä¸€ä¸ªåˆé€‚çš„å¤§å° */
    color: #555;
    cursor: pointer;
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%); /* è¿™æ˜¯è®©å®ƒåœ¨å‚ç›´æ–¹å‘ä¸Šå±…ä¸­çš„å°æŠ€å·§ */
}

        .page-content {
            flex-grow: 1; /* å æ®é™¤äº†é¡¶æ å’Œè¾“å…¥æ¡†å¤–çš„æ‰€æœ‰ç©ºé—´ */
            overflow-y: auto; /* å¦‚æœå†…å®¹è¶…é•¿ï¼Œå¯ä»¥æ»šåŠ¨ */
            padding: 15px;
        }

        #chat-room-page .page-content {
            padding: 0; /* èŠå¤©åŒºåŸŸçš„å†…è¾¹è·ç‰¹æ®Šå¤„ç† */
        }

        .chat-input-area {
            flex-shrink: 0; /* é˜²æ­¢è¾“å…¥åŒºåŸŸè¢«å‹ç¼© */
            background-color: #eeeeee; /* è¾“å…¥åŒºåŸŸä¸ºæµ…ç°è‰² */
            padding: 10px;
        }

/* --- API è®¾ç½®é¡µé¢ä¸“å±æ ·å¼ --- */
        .settings-form {
            display: flex;
            flex-direction: column;
            gap: 15px; /* è¡¨å•å…ƒç´ ä¹‹é—´çš„å‚ç›´é—´è· */
        }

        .settings-form label {
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        /* è¿™æ˜¯æ›¿æ¢åçš„ç‰ˆæœ¬ï¼Œç¾åŒ–æ‰€æœ‰è¡¨å•è¾“å…¥æ¡† */
.settings-form input[type="text"],
.settings-form input[type="password"],
.settings-form input[type="number"], /* æ–°å¢ï¼šç¾åŒ–æ•°å­—è¾“å…¥æ¡† */
.settings-form textarea {             /* æ–°å¢ï¼šç¾åŒ–å¤šè¡Œæ–‡æœ¬æ¡† */
    width: 100%;
    padding: 10px;
    border: 1px solid #eeeeee; /* ææµ…çš„ç°è‰²è¾¹æ¡† */
    border-radius: 8px;
    background-color: #f9f9f9; /* æ¯”ç™½è‰²ç¨æ·±ä¸€ç‚¹çš„èƒŒæ™¯ï¼Œçªå‡ºè¾“å…¥æ¡† */
    box-sizing: border-box; /* ç¡®ä¿paddingä¸ä¼šæ’‘å¤§å®½åº¦ */
    font-size: 14px;
    font-family: inherit; /* ç»§æ‰¿é¡µé¢å­—ä½“ */
    resize: vertical; /* åªå…è®¸æ–‡æœ¬æ¡†å‚ç›´æ‹‰ä¼¸ */
}

        .settings-btn {
    padding: 12px;
    background-color: var(--theme-accent-color); /* å…³é”®æ”¹åŠ¨ï¼šé¢œè‰²å¬ä»ä¸»é¢˜â€œå¤–å·â€çš„æŒ‡æŒ¥ï¼ */
    color: #333;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.2s, filter 0.2s; /* å¢åŠ äº†æ»¤é•œçš„è¿‡æ¸¡æ•ˆæœ */
}
        
        /* é¼ æ ‡æ‚¬åœæ—¶æŒ‰é’®é¢œè‰²å˜äº®ä¸€ç‚¹ï¼Œæä¾›åé¦ˆ */
        .settings-btn:hover {
            filter: brightness(1.1); /* å…³é”®æ”¹åŠ¨ï¼šæ— è®ºåº•ä¸‹æ˜¯ä»€ä¹ˆé¢œè‰²ï¼Œéƒ½è®©å®ƒå˜äº®10% */
        }

        .divider {
            border: none;
            border-top: 1px solid #eeeeee;
            margin: 10px 0;
        }

        #model-list-container {
            min-height: 100px;
            border: 1px dashed #e0e0e0; /* ç”¨è™šçº¿æ¡†è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå¾…å¡«å……åŒºåŸŸ */
            border-radius: 8px;
            padding: 10px;
            background-color: #fdfdfd;
        }
        
        .placeholder-text {
            color: #999;
            text-align: center;
            margin-top: 30px;
            font-size: 13px;
        }
        
        /* --- API è®¾ç½®é¡µé¢ - æ¨¡å‹åˆ—è¡¨æ ·å¼ --- */
        .model-item {
            display: flex;
            align-items: center;
            padding: 10px 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid #f0f0f0; /* ç»™æ¯ä¸€é¡¹åŠ ä¸€ä¸ªæµ…æµ…çš„ä¸‹åˆ’çº¿ */
        }

        .model-item:last-child {
            border-bottom: none; /* æœ€åä¸€é¡¹ä¸éœ€è¦ä¸‹åˆ’çº¿ */
        }

        .model-item:hover {
            background-color: #f5f5f5; /* é¼ æ ‡æ”¾ä¸Šå»æœ‰æ·¡æ·¡çš„ç°è‰²èƒŒæ™¯ */
        }

        .model-item input[type="radio"] {
            margin-right: 10px;
            /* è®©å•é€‰æŒ‰é’®å˜å¾—å¥½çœ‹ä¸€ç‚¹ */
            appearance: none;
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid #ccc;
            border-radius: 50%;
            outline: none;
            cursor: pointer;
            position: relative;
        }

        .model-item input[type="radio"]:checked {
            border-color: #666;
        }
        
        /* è¢«é€‰ä¸­æ—¶ï¼Œåœ¨ä¸­é—´ç”»ä¸€ä¸ªå°åœ†ç‚¹ */
        .model-item input[type="radio"]:checked::before {
            content: '';
            display: block;
            width: 10px;
            height: 10px;
            background-color: #666;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .model-item label {
            flex-grow: 1;
            font-weight: normal; /* è¦†ç›–æ‰ä¹‹å‰labelçš„åŠ ç²— */
            font-size: 14px;
            color: #333;
        }
        
        /* --- Chat åˆ—è¡¨é¡µé¢ä¸“å±æ ·å¼ --- */
        #chat-list-page .page-content {
            padding: 0 15px; /* æˆ‘ä»¬ç»™åˆ—è¡¨é¡¹çš„å·¦å³ç•™å‡ºä¸€äº›ç©ºé—´ */
        }
        
        #no-chats-placeholder {
            text-align: center;
            margin-top: 50px;
            color: #999;
            font-size: 14px;
        }

        .chat-list-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #eeeeee; /* ç”¨ææµ…çš„ç°è‰²åšåˆ†å‰²çº¿ */
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .chat-list-item:hover {
            background-color: #f9f9f9; /* é¼ æ ‡æ‚¬åœæ—¶æœ‰æ·¡æ·¡çš„åé¦ˆ */
        }
        
        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 8px; /* ä¿®æ”¹è¿™é‡Œï¼šä»50%å˜æˆ8pxçš„å°åœ†è§’ */
            object-fit: cover; /* ä¿è¯å›¾ç‰‡ä¸å˜å½¢ */
            margin-right: 15px;
            flex-shrink: 0; /* é˜²æ­¢å¤´åƒè¢«å‹ç¼© */
        }

        .chat-info {
            flex-grow: 1;
            overflow: hidden; /* é˜²æ­¢æ–‡å­—è¿‡é•¿æ—¶æ’‘ç ´å¸ƒå±€ */
        }
        
        .chat-name {
            font-size: 16px;
            font-weight: 500; /* æ¯” bold ç¨ç»†ä¸€ç‚¹çš„å­—é‡ */
            color: #333;
        }
        
        .chat-last-message {
            font-size: 14px;
            color: #888;
            margin-top: 4px;
            white-space: nowrap; /* è®©æ¶ˆæ¯ä¿æŒåœ¨ä¸€è¡Œ */
            overflow: hidden; /* éšè—è¶…å‡ºéƒ¨åˆ† */
            text-overflow: ellipsis; /* è¶…å‡ºéƒ¨åˆ†æ˜¾ç¤ºä¸º ... */
        }
        
        /* --- æ·»åŠ è”ç³»äººé¡µé¢ä¸“å±æ ·å¼ --- */
        .contact-form {
            display: flex;
            flex-direction: column;
            gap: 20px; /* å¢å¤§é—´è·ï¼Œè®©é¡µé¢ä¸æ‹¥æŒ¤ */
        }

        .contact-avatar-picker {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 10px 0;
        }

        #contact-avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #eeeeee;
        }
        
        .contact-avatar-picker span {
            font-size: 14px;
            color: #666;
        }

        .contact-form label {
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        /* å¤ç”¨APIè®¾ç½®é¡µçš„è¾“å…¥æ¡†æ ·å¼ */
        .contact-form input[type="text"],
        .contact-form textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #eeeeee;
            border-radius: 8px;
            background-color: #f9f9f9;
            box-sizing: border-box;
            font-size: 14px;
            font-family: inherit; /* ç»§æ‰¿é¡µé¢å­—ä½“ */
            resize: vertical; /* åªå…è®¸å‚ç›´æ–¹å‘æ‹‰ä¼¸textarea */
        }
        
        .gender-selection {
            display: flex;
            gap: 15px;
        }

        /* éšè—åŸå§‹çš„å•é€‰æŒ‰é’® */
        .gender-selection input[type="radio"] {
            display: none;
        }

        /* è‡ªå®šä¹‰å•é€‰æŒ‰é’®çš„å¤–è§‚ */
        .gender-selection label {
            padding: 8px 16px;
            border-radius: 20px; /* è¯ä¸¸å½¢çŠ¶ */
            background-color: #eeeeee;
            color: #555;
            font-weight: normal;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        /* å½“å•é€‰æŒ‰é’®è¢«é€‰ä¸­æ—¶ï¼Œæ”¹å˜å®ƒåé¢labelçš„æ ·å¼ */
        .gender-selection input[type="radio"]:checked + label {
            background-color: #333;
            color: #ffffff;
            font-weight: bold;
        }

        /* å¤ç”¨ settings-btn æ ·å¼ï¼Œä½†ç»™å®ƒä¸€ä¸ªæ–°idæ–¹ä¾¿æœªæ¥å•ç‹¬æ“ä½œ */
        #add-contact-btn {
            margin-top: 10px; /* å’Œä¸Šé¢çš„å…ƒç´ ç•™å‡ºæ›´å¤šç©ºé—´ */
        }
        
        /* --- æ–°å¢ï¼šé™„åŠ åŠŸèƒ½å¼¹çª—æ ·å¼ --- */
#action-popup-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.4);
    z-index: 150;
    display: flex;
    justify-content: center;
    align-items: flex-end; /* è®©å¼¹çª—åœ¨åº•éƒ¨ */
}

#action-popup {
    width: 100%;
    background-color: #ffffff; /* å…³é”®æ”¹åŠ¨1ï¼šèƒŒæ™¯å˜æˆçº¯ç™½è‰² */
    border-radius: 20px 20px 0 0; /* å…³é”®æ”¹åŠ¨2ï¼šé¡¶éƒ¨åœ†è§’å˜å¾—æ›´åœ†æ¶¦ */
    padding: 15px 15px 30px; /* å…³é”®æ”¹åŠ¨3ï¼šè°ƒæ•´å†…è¾¹è·ï¼Œåº•éƒ¨ç•™å¤šä¸€ç‚¹ç©ºé—´æ›´å¥½çœ‹ */
    box-sizing: border-box;
    display: flex;
    flex-direction: column; /* å…³é”®æ”¹åŠ¨4ï¼šè®©é‡Œé¢çš„å…ƒç´ å‚ç›´æ’åˆ— */
    gap: 15px; /* è°ƒæ•´å…ƒç´ ä¹‹é—´çš„é—´è· */
    transform: translateY(100%);
    transition: transform 0.3s ease-out;
    box-shadow: 0 -5px 20px rgba(0,0,0,0.1); /* é”¦ä¸Šæ·»èŠ±ï¼šåŠ ä¸€ä¸ªå‘ä¸Šçš„é˜´å½±ï¼Œæ›´æœ‰ç«‹ä½“æ„Ÿ */
}

.action-btn {
    display: flex;
    align-items: center; /* å…³é”®æ”¹åŠ¨1ï¼šè®©å›¾æ ‡å’Œæ–‡å­—æ°´å¹³å¯¹é½ */
    gap: 15px; /* å…³é”®æ”¹åŠ¨2ï¼šè°ƒæ•´å›¾æ ‡å’Œæ–‡å­—çš„é—´è· */
    cursor: pointer;
    background-color: #f5f5f5; /* å…³é”®æ”¹åŠ¨3ï¼šç»™æŒ‰é’®ä¸€ä¸ªæµ…ç°è‰²èƒŒæ™¯ */
    padding: 12px 15px; /* å…³é”®æ”¹åŠ¨4ï¼šå¢åŠ å†…è¾¹è·ï¼Œè®©æŒ‰é’®å˜å¤§å˜é¥±æ»¡ */
    border-radius: 12px; /* å…³é”®æ”¹åŠ¨5ï¼šè¿™å°±æ˜¯æ‚¨è¦çš„åœ†è§’ï¼ */
    transition: background-color 0.2s; /* æ·»åŠ ç‚¹å‡»æ•ˆæœ */
}
/* é¡ºä¾¿åŠ ä¸€ä¸ªæ‚¬åœæ•ˆæœ */
.action-btn:hover {
    background-color: #e9e9e9;
}

.action-btn svg {
    width: 28px; /* å›¾æ ‡å°ºå¯¸å˜å°ï¼Œæ›´ç²¾è‡´ */
    height: 28px;
    padding: 0; /* ç§»é™¤å¤šä½™çš„è®¾ç½® */
    background-color: transparent; /* èƒŒæ™¯å˜é€æ˜ */
    border-radius: 0;
    fill: #333; /* å›¾æ ‡é¢œè‰²å˜æ·± */
    flex-shrink: 0; /* é˜²æ­¢å›¾æ ‡è¢«å‹ç¼© */
}

.action-btn span {
    font-size: 15px; /* å­—ä½“å˜å¤§ï¼Œæ›´æ¸…æ™° */
    color: #333; /* å­—ä½“é¢œè‰²å˜æ·± */
    font-weight: 500; /* å­—ä½“ç¨å¾®åŠ ç²—ä¸€ç‚¹ç‚¹ */
}
      
/* --- æ–°å¢ï¼šå›¾ç‰‡æ¶ˆæ¯æ¡æ ·å¼ --- */
.message-bubble.image {
    width: 200px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
}
.image-icon {
    width: 32px;
    height: 32px;
    fill: #888;
    align-self: center; /* å›¾æ ‡å±…ä¸­ */
}
.image-description {
    font-size: 12px;
    color: #333;
    line-height: 1.5;
    text-align: left;
}

      /* --- æ–°å¢ï¼šè½¬è´¦åŠç³»ç»Ÿæ¶ˆæ¯æ ·å¼ (å¾®å…‰ç»ç’ƒé‡åˆ¶ç‰ˆ) --- */
.message-bubble.transfer, .message-bubble.system {
    background-color: transparent !important;
    padding: 0 !important;
}

/* æ•´ä¸ªå¡ç‰‡çš„å®¹å™¨ï¼Œè´Ÿè´£åˆ›å»ºå…‰æ™•èƒŒæ™¯ */
.transfer-card-wrapper {
    position: relative;
    width: 200px; /* å¡ç‰‡å°ºå¯¸ */
    height: 90px;
    border-radius: 16px;
    overflow: hidden; /* éšè—è¶…å‡ºè¾¹ç•Œçš„å…‰æ™• */
    background-color: #f0f2f5; /* ä¸€ä¸ªåŸºç¡€åº•è‰² */
}
/* è¿™å°±æ˜¯æµåŠ¨çš„â€œå¾®å…‰â€æœ¬ä½“ */
.transfer-card-wrapper::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: conic-gradient(
        transparent,
        rgba(255, 120, 180, 0.5), /* ç²‰è‰²å…‰ */
        rgba(120, 180, 255, 0.5), /* è“è‰²å…‰ */
        transparent 30%
    );
    animation: rotate 4s linear infinite; /* è®©å…‰æ™•åŠ¨èµ·æ¥ */
}
/* è¿™æ˜¯è¦†ç›–åœ¨å…‰æ™•ä¸Šå±‚çš„â€œç£¨ç ‚ç»ç’ƒâ€ */
.transfer-message-card {
    position: absolute;
    inset: 1px; /* ç•™å‡º1åƒç´ çš„è¾¹æ¡†ç»™å…‰æ™•é€å‡ºæ¥ */
    background-color: rgba(255, 255, 255, 0.7); /* åŠé€æ˜ç™½è‰²ï¼Œç£¨ç ‚ç»ç’ƒæ„Ÿ */
    backdrop-filter: blur(10px); /* æ¨¡ç³ŠèƒŒæ™¯å…‰æ™• */
    border-radius: 15px;
    padding: 12px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    color: #333;
}
/* æˆ‘å‘å‡ºå»çš„è½¬è´¦å¡ç‰‡ï¼Œç”¨ç²‰è‰²ç³»å…‰æ™• */
.transfer-card-wrapper.sent::before {
     background: conic-gradient(transparent, #FF85B3, #FFC7D9, transparent 30%);
}
/* å¯¹æ–¹æ”¶åˆ°çš„è½¬è´¦å¡ç‰‡ï¼Œç”¨è“è‰²ç³»å…‰æ™• */
.transfer-card-wrapper.received::before {
    background: conic-gradient(transparent, #85B3FF, #C7D9FF, transparent 30%);
}

.transfer-header {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    font-weight: 500;
}
.transfer-header svg {
    width: 20px;
    height: 20px;
    fill: #333;
}
.transfer-body {
    text-align: right;
    font-size: 26px;
    font-weight: bold;
}
.transfer-body::before {
    content: 'Â¥';
    font-size: 14px;
    font-weight: normal;
    margin-right: 2px;
}

/* å®šä¹‰å…‰æ™•æ—‹è½¬çš„åŠ¨ç”» */
@keyframes rotate {
    100% {
        transform: rotate(360deg);
    }
}

.system-message-text {
    background-color: #e0e0e0;
    color: #666;
    font-size: 12px;
    padding: 4px 10px;
    border-radius: 12px;
    margin: 0 auto;
}
        
        /* --- æ–°å¢ï¼šè¯­éŸ³æ¶ˆæ¯æ¡æ ·å¼ --- */
.message-bubble.voice {
    width: 80px; /* å›ºå®šå®½åº¦ */
    display: flex;
    align-items: center;
    justify-content: space-between; /* å›¾æ ‡å’Œç§’æ•°ä¸¤ç«¯å¯¹é½ */
}

/* 
   --- è¿™é‡Œæ˜¯å…³é”®ä¿®æ­£ï¼ ---
   æˆ‘æŠŠé”™è¯¯çš„ .voice-icon svg æ”¹æˆäº†æ­£ç¡®çš„ svg.voice-icon 
   æ„æ€æ˜¯ä»â€œvoice-iconé‡Œé¢çš„svgâ€ å˜æˆäº† â€œé‚£ä¸ªåå­—å«voice-iconçš„svgæœ¬èº«â€
*/
svg.voice-icon {
    width: 20px;
    height: 20px;
}

.voice-bar-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%; /* å æ»¡80pxçš„å®½åº¦ */
}

.voice-transcript {
    margin-top: 8px; /* å’Œä¸Šé¢çš„å£°æ³¢æ¡ç•™å‡ºä¸€ç‚¹è·ç¦» */
    font-size: 12px;  /* æ–‡å­—ç¨¿çš„å­—å·å°ä¸€ç‚¹ */
    color: #666;      /* é¢œè‰²æµ…ä¸€ç‚¹ï¼Œä½œä¸ºæ¬¡è¦ä¿¡æ¯ */
    word-break: break-word; /* ä¿è¯æ–‡å­—ä¼šè‡ªåŠ¨æ¢è¡Œ */
    text-align: left; /* æ–‡å­—é å·¦å¯¹é½ */
}

.voice-duration {
    font-size: 12px;
    color: #666;
}

/* å¯¹æ–¹çš„è¯­éŸ³æ¡å›¾æ ‡é¢œè‰² */
.chat-message.received svg.voice-icon {
    fill: #333;
}
/* æˆ‘æ–¹çš„è¯­éŸ³æ¡å›¾æ ‡é¢œè‰²ï¼Œå¹¶æŠŠå®ƒç¿»è½¬ä¸€ä¸‹ï¼Œåƒéº¦å…‹é£ä¸€æ · */
.chat-message.sent svg.voice-icon {
    fill: #333;
    transform: scaleX(-1);
}
        
        /* --- æ–°å¢ï¼šé•¿æŒ‰æ¶ˆæ¯çš„å¼¹å‡ºèœå•æ ·å¼ --- */
#message-context-menu {
    position: absolute; /* ç»å¯¹å®šä½ï¼Œè®©å®ƒèƒ½æµ®åŠ¨ */
    display: none; /* é»˜è®¤éšè— */
    background-color: #333; /* æ·±è‰²èƒŒæ™¯ï¼Œé…·ä¸€ç‚¹ */
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 100; /* ç¡®ä¿åœ¨æœ€é¡¶å±‚ */
    overflow: hidden; /* è®©å†…éƒ¨æŒ‰é’®ä¹Ÿä¿æŒåœ†è§’ */
    padding: 5px;
}

.context-menu-btn {
    background-color: transparent;
    border: none;
    color: white;
    padding: 10px 15px;
    font-size: 14px;
    cursor: pointer;
    display: block; /* æ¯ä¸ªæŒ‰é’®å ä¸€è¡Œ */
    width: 100%;
    text-align: left;
}

.context-menu-btn:hover {
    background-color: #555; /* é¼ æ ‡æ‚¬åœæ—¶å˜è‰² */
}

/* --- æ–°å¢ï¼šè®¾ç½®é¡µé¢åˆ—è¡¨æ ·å¼ --- */
.settings-list {
    display: flex;
    flex-direction: column;
    gap: 1px; /* åˆ¶é€ åˆ†å‰²çº¿çš„æ•ˆæœ */
    background-color: #eeeeee;
    border-radius: 10px;
    overflow: hidden;
    margin: 15px;
}

.settings-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background-color: #ffffff;
    cursor: pointer;
    transition: background-color 0.2s;
    font-size: 15px;
}

.settings-item:hover {
    background-color: #f9f9f9;
}

.settings-item span:last-child {
    color: #cccccc;
    font-weight: bold;
}

/* --- æ–°å¢ï¼šç¾åŒ–è®¾ç½®é¡¹çš„ç»„åˆæ ·å¼ --- */
.settings-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 20px;
}

/* --- æ–°å¢ï¼šç¾åŒ–æ»‘å—(range input)æ ·å¼ --- */
/* --- æ–°å¢ï¼šç¾åŒ–å·¦å³æ»‘åŠ¨å¼€å…³(toggle switch)æ ·å¼ --- */
.toggle-switch-container {
    display: flex;
    align-items: center;
    gap: 12px;
}
.toggle-switch-checkbox {
    display: none; /* éšè—åŸå§‹çš„å¤é€‰æ¡† */
}
.toggle-switch-label {
    width: 44px;
    height: 24px;
    background-color: #ccc;
    border-radius: 12px;
    position: relative;
    cursor: pointer;
    transition: background-color 0.2s ease;
}
.toggle-switch-label::after {
    content: '';
    width: 20px;
    height: 20px;
    background-color: white;
    border-radius: 50%;
    position: absolute;
    top: 2px;
    left: 2px;
    transition: left 0.2s ease;
}
.toggle-switch-checkbox:checked + .toggle-switch-label {
    background-color: #4CAF50; /* å¼€å¯æ—¶çš„ç»¿è‰² */
}
.toggle-switch-checkbox:checked + .toggle-switch-label::after {
    left: 22px; /* å°åœ†ç‚¹ç§»åŠ¨åˆ°å³è¾¹ */
}
.toggle-switch-description {
    font-size: 12px;
    color: #888;
}


.slider-container {
    display: flex;
    align-items: center;
    gap: 15px;
}
#memory-slider {
    flex-grow: 1;
}
#memory-slider-value {
    font-weight: bold;
    color: #333;
    min-width: 20px;
    text-align: center;
}
        
        /* --- èŠå¤©å®¤é¡µé¢ç¾åŒ– v2.0 --- */
#chat-room-page .page-content {
    padding: 10px;
    display: flex;
    flex-direction: column;
    background-color: #ffffff; /* ä»»åŠ¡2ï¼šæ˜ç¡®èŠå¤©èƒŒæ™¯ä¸ºçº¯ç™½è‰² */
}
        
        .chat-message {
            display: flex;
            align-items: flex-start; /* å¤´åƒå’Œæ°”æ³¡é¡¶éƒ¨å¯¹é½ */
            margin-bottom: 15px;
            max-width: 85%;
        }

        /* æ•´ä½“ç»“æ„å¸ƒå±€ï¼šæˆ‘æ–¹åœ¨å³ï¼Œå¯¹æ–¹åœ¨å·¦ */
        .chat-message.sent {
            align-self: flex-end;
            flex-direction: row-reverse; /* æ ¸å¿ƒï¼šå¤´åƒå’Œå†…å®¹åŒºåŸŸåå‘æ’åˆ— */
        }
        .chat-message.received {
            align-self: flex-start;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 6px; /* å°åœ†è§’æ–¹å½¢å¤´åƒ */
            flex-shrink: 0;
            object-fit: cover;
        }
        
        .avatar-and-time {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px; /* å¤´åƒå’Œæ—¶é—´çš„é—´è· */
    width: 48px; /* ç»™ä¸€ä¸ªå›ºå®šå®½åº¦ï¼Œé˜²æ­¢æ—¶é—´è¿‡é•¿å½±å“å¸ƒå±€ */
    flex-shrink: 0;
}

.message-time {
    font-size: 10px;
    color: #aaa;
    /* margin-top: 4px; <- è¿™è¡Œæ²¡ç”¨äº†ï¼Œå¯ä»¥åˆ æ‰ï¼Œä¸è¿‡ä¸ºäº†å®‰å…¨æˆ‘å¸®ä½ æ³¨é‡Šæ‰ */
}

.chat-message.sent .avatar-and-time {
    margin-right: 8px;
}

.chat-message.received .avatar-and-time {
    margin-left: 8px;
}

.message-content {
    margin-top: 0; /* ä¿®æ­£å¯¹é½ */
}
        
        .message-content {
            display: flex;
            flex-direction: column;
        }

        .chat-message.sent .message-content {
            align-items: flex-end; /* æˆ‘çš„æ—¶é—´å’Œæ°”æ³¡é å³ */
            margin-right: 8px;
        }
        .chat-message.received .message-content {
            align-items: flex-start; /* å¯¹æ–¹çš„æ—¶é—´å’Œæ°”æ³¡é å·¦ */
            margin-left: 8px;
        }

        .message-bubble {
    padding: var(--bubble-padding-y, 8px) var(--bubble-padding-x, 10px); /* ä½¿ç”¨å˜é‡ */
    border-radius: 16px; 
    font-size: var(--bubble-font-size, 15px); /* ä½¿ç”¨å˜é‡ */
    line-height: 1.6;
    word-break: break-word;
}

        /* æˆ‘æ–¹æ°”æ³¡ï¼šæ¸…çˆ½çš„æ·¡è“è‰² */
.chat-message.sent .message-bubble {
    background-color: var(--user-bubble-bg, #e1f5fe); /* å˜é‡ï¼Œé»˜è®¤æ·¡æ·¡çš„è“è‰² */
    color: #333;
}
/* å¯¹æ–¹æ°”æ³¡ï¼šå¹²å‡€çš„æµ…ç°è‰² */
.chat-message.received .message-bubble {
    background-color: var(--assistant-bubble-bg, #ffffff); /* å˜é‡ï¼Œé»˜è®¤ç™½è‰² */
    color: #333;
}
        
        .message-time {
            font-size: 10px;
            color: #aaa;
            margin-top: 4px;
        }

        /* --- è¾“å…¥æ¡†ç¾åŒ– v2.0 (å·²ä¿®æ­£) --- */
.chat-input-area {
    display: flex;
    background-color: #ffffff; /* ä»»åŠ¡4ï¼šæ”¹æˆçº¯ç™½è‰² */
    padding: 10px 12px;
    align-items: flex-end;
    gap: 10px;
    border-top: 1px solid #f0f0f0; /* æ–°å¢ï¼šå¢åŠ ä¸€æ¡æç»†çš„é¡¶éƒ¨åˆ†å‰²çº¿ */
}

#message-input {
    flex-grow: 1; /* æ–°å¢ï¼šè®©è¾“å…¥æ¡†å æ®æ‰€æœ‰å‰©ä½™ç©ºé—´ */
    background-color: #fff; /* ç™½è‰²åœ†è§’é•¿æ¡ */
    border: 1px solid #e0e0e0; /* æ–°å¢ï¼šå’ŒæŒ‰é’®ç»Ÿä¸€çš„è¾¹æ¡† */
    border-radius: 18px;
    padding: 8px 15px;
    font-size: 13px;
    line-height: 1.5;
    color: #333;
    resize: none; /* ç¦æ­¢ç”¨æˆ·æ‰‹åŠ¨æ‹‰ä¼¸ */
}

.chat-btn {
    flex-shrink: 0;
    width: 36px;
    height: 36px;
    border-radius: 8px;
    background-color: transparent; /* æ”¹ä¸ºé€æ˜èƒŒæ™¯ */
    border: none; /* ç§»é™¤è¾¹æ¡† */
    color: #888; /* å›¾æ ‡é¢œè‰²è®¾ä¸ºä¸­ç°è‰² */
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color 0.2s; /* è¿‡æ¸¡æ•ˆæœæ”¹ä¸ºé¢œè‰² */
}
.chat-btn:hover {
    color: #333; /* æ‚¬åœæ—¶å›¾æ ‡é¢œè‰²å˜æ·± */
}



/* --- æ–°å¢ï¼šä¸»é¢˜ç¾åŒ–é¡µé¢çš„é¢„è§ˆçª—å£æ ·å¼ --- */
#wallpaper-preview-container {
    width: 100%;
    height: 300px; /* ç»™ä¸€ä¸ªå›ºå®šçš„é¢„è§ˆé«˜åº¦ */
    background-color: #eeeeee; /* é»˜è®¤å£çº¸é¢œè‰² */
    border-radius: 10px;
    border: 1px solid #ddd;
    position: relative;
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: center;
    background-size: cover;
    background-position: center;
    margin-bottom: 15px; /* å’Œä¸‹é¢çš„æŒ‰é’®ç•™ç‚¹è·ç¦» */
}



#avatar-img-preview {
    width: 25px;  /* æŒ‰æ¯”ä¾‹ç¼©å° */
    height: 25px; /* æŒ‰æ¯”ä¾‹ç¼©å° */
    background-color: #a0a0a0;
    border-radius: 50%;
    position: relative;
    z-index: 2;
    object-fit: cover;
}

/* --- æ–°å¢ï¼šä¸»é¢˜åˆ‡æ¢çš„æ ¸å¿ƒé­”æ³• (è‰²å½©å‡çº§ç‰ˆ) --- */
#phone-screen.theme-pink {
    --theme-default-bg: #FFECF2; /* èƒŒæ™¯ï¼šæ·¡æ·¡çš„ç²‰è‰² */
    --theme-accent-color: #FFDDE8; /* æŒ‰é’®/é¡¶æ ï¼šç¨æ·±ä¸€ç‚¹çš„ç²‰è‰² */
}
#phone-screen.theme-blue {
    --theme-default-bg: #E6F0F6; /* èƒŒæ™¯ï¼šæ·¡æ·¡çš„è“è‰² */
    --theme-accent-color: #D0E0EC; /* æŒ‰é’®/é¡¶æ ï¼šç¨æ·±ä¸€ç‚¹çš„è“è‰² */
}
#phone-screen.theme-yellow {
    --theme-default-bg: #FFF9E6; /* èƒŒæ™¯ï¼šæ·¡æ·¡çš„é»„è‰² */
    --theme-accent-color: #FFF0C2; /* æŒ‰é’®/é¡¶æ ï¼šç¨æ·±ä¸€ç‚¹çš„é»„è‰² */
}
#phone-screen.theme-green {
    --theme-default-bg: #F0F8E8; /* èƒŒæ™¯ï¼šæ·¡æ·¡çš„ç»¿è‰² */
    --theme-accent-color: #E0EECB; /* æŒ‰é’®/é¡¶æ ï¼šç¨æ·±ä¸€ç‚¹çš„ç»¿è‰² */
}
      
/* --- æ–°å¢ï¼šä¸»é¢˜é€‰æ‹©å™¨æ ·å¼ --- */
#theme-selector {
    display: flex;
    gap: 15px;
    justify-content: center;
    padding: 10px 0;
}
.theme-swatch {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid #ccc;
    transition: transform 0.2s, border-color 0.2s;
}
.theme-swatch:hover {
    transform: scale(1.1);
}
.theme-swatch.selected {
    border-color: #333; /* é€‰ä¸­æ—¶è¾¹æ¡†å˜é»‘ */
    transform: scale(1.1);
}

/* --- æ–°å¢ï¼šæŸ¥æ‰‹æœº & å¤‡å¿˜å½•é¡µé¢æ ·å¼ --- */
.memo-item {
    background-color: #fff;
    border-bottom: 1px solid #f0f0f0;
}

.memo-title {
    display: flex;
    align-items: center;
    padding: 15px;
    cursor: pointer;
    font-size: 15px;
    font-weight: 500;
}

.memo-title::before {
    content: 'â—'; /* ä¸€ä¸ªå°åœ†ç‚¹ä½œä¸ºè£…é¥° */
    color: var(--theme-accent-color); /* æ ¸å¿ƒï¼šä½¿ç”¨ä¸»é¢˜çš„å‰¯é…è‰²ï¼ */
    margin-right: 12px;
    font-size: 12px;
}

.memo-content {
    max-height: 0; /* å…³é”®ï¼šé»˜è®¤æŠŠå†…å®¹è—èµ·æ¥ */
    overflow: hidden;
    padding: 0 15px;
    font-size: 14px;
    color: #666;
    line-height: 1.7;
    transition: max-height 0.3s ease-out, padding 0.3s ease-out; /* å…³é”®ï¼šå±•å¼€/æ”¶èµ·çš„åŠ¨ç”» */
}

.memo-item.active .memo-content {
    max-height: 200px; /* å±•å¼€æ—¶çš„é«˜åº¦ï¼Œç»™ä¸ªè¶³å¤Ÿå¤§çš„å€¼ */
    padding: 0 15px 15px; /* å±•å¼€æ—¶æ¢å¤ä¸‹å†…è¾¹è· */
}

#memo-list-container {
    padding: 0; /* ç§»é™¤é»˜è®¤çš„å†…è¾¹è·ï¼Œè®©åˆ—è¡¨æ’‘æ»¡ */
}

/* --- æ–°å¢ï¼šæ—¥è®°é¡µé¢æ ·å¼ --- */
#diary-content-container {
    padding: 20px;
    background-color: #fdfaf5; /* æ¸©é¦¨çš„ç±³ç™½è‰²èƒŒæ™¯ */
    font-family: 'KaiTi', 'STKaiti', serif; /* ä½¿ç”¨æ›´æœ‰æ‰‹å†™æ„Ÿçš„å­—ä½“ */
    color: #4a4a4a;
}

.diary-entry {
    border: 1px solid #eaddcc;
    border-radius: 8px;
    padding: 15px;
    background-color: #ffffff;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

.diary-date {
    font-size: 14px;
    font-weight: bold;
    color: #a08c7d;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px dashed #eaddcc;
}

.diary-text {
    font-size: 16px;
    line-height: 2; /* æ›´å¤§çš„è¡Œé«˜ï¼Œé˜…è¯»æ›´èˆ’é€‚ */
    white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œå’Œç©ºæ ¼ï¼Œè®©AIçš„æ ¼å¼ç”Ÿæ•ˆ */
}

/* --- æ–°å¢ï¼šä¸»é¢˜ç¾åŒ–é¡µé¢çš„å°ºå¯¸è¾“å…¥æ ·å¼ --- */
.dimension-inputs {
    display: flex;
    align-items: center;
    gap: 10px;
}
.dimension-inputs input[type="number"] {
    width: 100px; /* ç»™è¾“å…¥æ¡†ä¸€ä¸ªå›ºå®šå®½åº¦ */
    padding: 8px;
    text-align: center;
    border: 1px solid #eeeeee;
    border-radius: 8px;
    background-color: #f9f9f9;
}
.dimension-inputs span {
    font-size: 18px;
    color: #999;
}

/* --- æ–°å¢ï¼šåº”ç”¨è¾¹æ¡†åœ†è§’æ¨¡å¼çš„æ ·å¼ --- */
#phone-screen.rounded-corners {
    border-radius: 25px; /* åº”ç”¨åœ†è§’ï¼ */
}

/* --- æ–°å¢ï¼šæ°”æ³¡è®¾ç½®é¡µé¢æ ·å¼ --- */
.color-input-wrapper {
    display: flex;
    align-items: center;
    gap: 10px;
    background-color: #f9f9f9;
    padding: 5px 10px;
    border-radius: 8px;
    border: 1px solid #eeeeee;
}
.color-input-wrapper input[type="color"] {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    width: 30px;
    height: 30px;
    background-color: transparent;
    border: none;
    cursor: pointer;
}
.color-input-wrapper input[type="color"]::-webkit-color-swatch {
    border-radius: 5px;
    border: 1px solid #ddd;
}
.color-input-wrapper input[type="color"]::-moz-color-swatch {
    border-radius: 5px;
    border: 1px solid #ddd;
}
.color-input-wrapper span {
    font-family: monospace;
    font-size: 14px;
    color: #555;
}
/* ç¾åŒ– range slider */
input[type="range"] {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: 6px;
    background: #eee;
    border-radius: 3px;
    outline: none;
}
input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 18px;
    height: 18px;
    background: #fff;
    border: 2px solid #ccc;
    border-radius: 50%;
    cursor: pointer;
}
input[type="range"]::-moz-range-thumb {
    width: 15px;
    height: 15px;
    background: #fff;
    border: 2px solid #ccc;
    border-radius: 50%;
    cursor: pointer;
}

/* --- æ–°å¢ï¼šè¡Œç¨‹é¡µé¢æ ·å¼ --- */
#itinerary-list-container {
    padding: 20px 15px;
    background-color: #f7f8fa; /* ä¸€ä¸ªå¹²å‡€çš„æµ…ç°è‰²èƒŒæ™¯ */
}

.itinerary-item {
    display: flex;
    position: relative;
    padding-bottom: 25px; /* ä¸ºéšç¬”å’Œé—´è·ç•™å‡ºç©ºé—´ */
}

/* æ—¶é—´çº¿å’Œæ—¶é—´ç‚¹çš„æ ·å¼ */
.itinerary-time-column {
    flex-shrink: 0;
    width: 70px; /* æ—¶é—´åˆ—çš„å®½åº¦ */
    position: relative;
}

/* ä¸­é—´çš„ç«–çº¿ */
.itinerary-time-column::before {
    content: '';
    position: absolute;
    top: 5px;
    left: 20px;
    height: 100%;
    width: 2px;
    background-color: #e0e4e8;
}

/* æœ€åä¸€ä¸ªè¡Œç¨‹é¡¹ï¼Œç«–çº¿ä¸éœ€è¦é‚£ä¹ˆé•¿ */
.itinerary-item:last-child .itinerary-time-column::before {
    display: none;
}

/* æ—¶é—´ç‚¹çš„å°åœ†åœˆ */
.itinerary-time {
    font-size: 13px;
    font-weight: bold;
    color: #333;
    background-color: #fff;
    padding-left: 15px;
    position: relative;
}
.itinerary-time::before {
    content: '';
    position: absolute;
    top: 5px;
    left: -5px; /* è°ƒæ•´ä½ç½®ï¼Œè®©å®ƒæŒ‚åœ¨çº¿ä¸Š */
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background-color: #5b99e2; /* ä¸€ä¸ªé†’ç›®çš„è“è‰² */
    border: 2px solid #fff;
    z-index: 1;
    transform: translateX(12.5px); /* å¾®è°ƒä½¿ä¹‹å±…ä¸­ */
}

/* è¡Œç¨‹å†…å®¹åŒºåŸŸ */
.itinerary-content-column {
    flex-grow: 1;
    padding-left: 15px;
}

.itinerary-description {
    font-size: 15px;
    color: #333;
    font-weight: 500;
    background-color: #fff;
    padding: 12px;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    border: 1px solid #f0f0f0;
}

/* éšç¬”éƒ¨åˆ†çš„ç‰¹æ®Šæ ·å¼ */
.itinerary-scribble {
    margin-top: 10px;
    padding: 10px 12px;
    background-color: #fffef2; /* åƒä¾¿åˆ©è´´ä¸€æ ·çš„æ·¡é»„è‰² */
    border-left: 3px solid #ffd966; /* å·¦ä¾§æœ‰ä¸€ä¸ªæ ‡è®°æ¡ */
    font-size: 14px;
    color: #665c3e;
    line-height: 1.8;
    white-space: pre-wrap; /* ä¿ç•™AIç”Ÿæˆçš„æ¢è¡Œ */
}
.itinerary-scribble::before {
    content: 'ğŸ“Œ éšç¬”:';
    font-weight: bold;
    display: block;
    margin-bottom: 5px;
    font-size: 12px;
    color: #c7a84d;
}

/* --- æ–°å¢ï¼šæµè§ˆè®°å½•é¡µé¢æ ·å¼ --- */
#history-list-container {
    padding: 0; /* ç§»é™¤å†…è¾¹è·ï¼Œè®©åˆ—è¡¨é¡¹æ’‘æ»¡ */
}

.history-item {
    display: flex;
    align-items: center;
    padding: 15px;
    border-bottom: 1px solid #f0f0f0; /* æµ…è‰²åˆ†å‰²çº¿ */
    font-size: 15px;
    color: #333;
}

.history-item:hover {
    background-color: #f9f9f9; /* é¼ æ ‡æ‚¬åœæ—¶æœ‰åé¦ˆ */
}

.history-item svg {
    width: 18px;
    height: 18px;
    fill: #aaa; /* å›¾æ ‡é¢œè‰² */
    margin-right: 15px;
    flex-shrink: 0;
}

/* --- æ–°å¢ï¼šè´­ç‰©è½¦é¡µé¢æ ·å¼ --- */
#cart-list-container {
    padding: 15px;
    background-color: #f7f8fa; /* å’Œè¡Œç¨‹é¡µä¸€æ ·çš„å¹²å‡€èƒŒæ™¯ */
}

.cart-item {
    background-color: #ffffff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    padding: 15px;
    margin-bottom: 15px;
    display: flex;
    gap: 15px; /* å›¾æ ‡å’Œå†…å®¹çš„é—´è· */
}

.cart-item-icon {
    flex-shrink: 0;
    width: 40px;
    height: 40px;
    border-radius: 8px;
    background-color: var(--theme-accent-color, #f0f0f0); /* ä½¿ç”¨ä¸»é¢˜è‰²ï¼Œæ›´ç»Ÿä¸€ */
    display: flex;
    align-items: center;
    justify-content: center;
}
.cart-item-icon svg {
    width: 24px;
    height: 24px;
    fill: #888;
}

.cart-item-details {
    flex-grow: 1;
}

.cart-item-name {
    font-size: 14px;
    font-weight: 500;
    color: #333;
    line-height: 1.6;
    margin-bottom: 8px;
}

.cart-item-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 10px;
}

.cart-item-tag {
    font-size: 10px;
    background-color: #ffefe5; /* æ¸©é¦¨çš„æ©˜è‰² */
    color: #d95e26;
    padding: 2px 6px;
    border-radius: 4px;
}
/* ç»™ç¬¬äºŒä¸ªæ ‡ç­¾æ¢ä¸ªé¢œè‰²ï¼Œå¢åŠ è¶£å‘³æ€§ */
.cart-item-tag:nth-child(2) {
    background-color: #e6f7ff;
    color: #1890ff;
}

.cart-item-price {
    font-size: 16px;
    font-weight: bold;
    color: #fa5252; /* é†’ç›®çš„çº¢è‰²ä»·æ ¼ */
    margin-bottom: 12px;
}
.cart-item-price::before {
    content: 'Â¥';
    font-size: 12px;
    margin-right: 2px;
}

.cart-item-remark {
    background-color: #f1f3f5; /* å¤‡æ³¨ä½¿ç”¨å†·é™çš„æµ…ç°è‰² */
    border-left: 3px solid #acb5bd;
    padding: 10px;
    font-size: 13px;
    color: #495057;
    line-height: 1.7;
    white-space: pre-wrap;
}
.cart-item-remark::before {
    content: 'âœï¸ å¤‡æ³¨ï¼š';
    font-weight: bold;
    display: block;
    margin-bottom: 5px;
    font-size: 12px;
    color: #495057;
}

/* --- æ–°å¢ï¼šæ¢¦å¢ƒé¡µé¢æ ·å¼ --- */
#dream-content-container {
    padding: 15px;
    background-color: #f0f2f5; /* ä¸€ä¸ªæ›´æ·±é‚ƒçš„èƒŒæ™¯è‰² */
}

.dream-container {
    background-color: #ffffff;
    border-radius: 12px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    overflow: hidden; /* ä¿è¯å†…éƒ¨å…ƒç´ ä¸å‡ºç•Œ */
}

.dream-header {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    background-color: #e3e8f2; /* æ·¡æ·¡çš„ã€åƒé»æ˜çš„å¤©è“è‰² */
    border-bottom: 1px solid #d8dde6;
}
.dream-header svg {
    width: 20px;
    height: 20px;
    fill: #6b7a99;
    margin-right: 10px;
}
.dream-header span {
    font-size: 14px;
    font-weight: bold;
    color: #4a5671;
}

.dream-narration {
    padding: 15px;
    font-size: 15px;
    color: #333;
    line-height: 1.8;
    white-space: pre-wrap; /* ä¿æŒAIçš„æ¢è¡Œ */
}

.dream-reflection {
    background-color: #f8f9fa; /* æ¢¦åæ„Ÿç”¨ä¸€ä¸ªæœ´ç´ çš„èƒŒæ™¯ */
    padding: 15px;
    border-top: 1px dashed #dee2e6; /* ç”¨è™šçº¿ä¸æ¢¦å¢ƒåˆ†å‰² */
}
.dream-reflection::before {
    content: 'ğŸ§  é†’æ¥åç¢ç£¨äº†ä¸€ä¸‹...';
    font-weight: bold;
    font-size: 13px;
    color: #6c757d;
    display: block;
    margin-bottom: 10px;
}
.dream-reflection p {
    margin: 0;
    font-size: 14px;
    color: #495057;
    line-height: 1.7;
    white-space: pre-wrap;
}

      /* --- æ–°å¢ï¼šé€šè®¯äº’åŠ¨é¡µé¢æ ·å¼ --- */
#interaction-page .page-content {
    background-color: #fdfdfd;
    font-size: 16px;
    line-height: 1.8;
    color: #444;
    padding: 20px;
    white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œ */
}

/* åŒºåˆ†â€œæˆ‘â€å’Œâ€œTAâ€çš„æ–‡å­—é¢œè‰² */
.interaction-my-text {
    color: #6a5acd; /* æˆ‘çš„æ–‡å­—ç”¨ç´«è‰² */
    font-weight: bold;
}

.interaction-assistant-text {
    color: #555; /* TAçš„æ–‡å­—ç”¨æ·±ç°è‰² */
}

#interaction-input-area {
    /* ç§»é™¤äº†ç®€å•çš„ä¸Šè¾¹çº¿ */
    display: flex; /* å¼€å¯flexå¸ƒå±€ï¼Œè®©è¾“å…¥æ¡†å’ŒæŒ‰é’®èƒ½çµæ´»å¯¹é½ */
    align-items: flex-end; /* åº•éƒ¨å¯¹é½ï¼Œå¤„ç†å¤šè¡Œè¾“å…¥æ—¶æŒ‰é’®ä¸ä¼šä¹±è·‘ */
    gap: 10px; /* è¾“å…¥æ¡†å’ŒæŒ‰é’®ä¹‹é—´çš„é—´è· */
    padding: 10px 12px; /* å¢åŠ å†…è¾¹è·ï¼Œè®©åŒºåŸŸæ›´é¥±æ»¡ */
    background-color: #ffffff; /* ç»™äºˆä¸€ä¸ªå¹²å‡€çš„ç™½è‰²èƒŒæ™¯ */
    box-shadow: 0 -2px 10px rgba(0,0,0,0.05); /* åœ¨é¡¶éƒ¨åŠ ä¸€ä¸ªå¾®å¦™çš„é˜´å½±ï¼Œè¥é€ ç«‹ä½“æ„Ÿ */
}

  #interaction-input {
    flex-grow: 1; /* å…³é”®ï¼šè®©è¾“å…¥æ¡†å æ®æ‰€æœ‰å‰©ä½™ç©ºé—´ */
    border: none; /* ç§»é™¤é»˜è®¤è¾¹æ¡† */
    outline: none; /* ç§»é™¤ç‚¹å‡»æ—¶çš„è“è‰²è¾‰å…‰ */
    padding: 10px 15px; /* èˆ’é€‚çš„å†…è¾¹è· */
    font-size: 15px; /* å­—ä½“å¤§å°é€‚ä¸­ */
    line-height: 1.6;
    background-color: #f5f5f5; /* ä¸€ä¸ªéå¸¸æµ…çš„ç°è‰²èƒŒæ™¯ï¼Œçªå‡ºè¾“å…¥åŒºåŸŸ */
    border-radius: 20px; /* å¯çˆ±çš„â€œè¯ä¸¸â€åœ†è§’ */
    resize: none; /* ç¦æ­¢ç”¨æˆ·æ‰‹åŠ¨æ‹–æ‹½å¤§å° */
    max-height: 120px; /* é™åˆ¶ä¸€ä¸ªæœ€å¤§é«˜åº¦ï¼Œé˜²æ­¢è¾“å…¥å¤ªå¤šå¯¼è‡´é¡µé¢æ— é™æ‹‰é•¿ */
    overflow-y: auto; /* å†…å®¹è¶…å‡ºæœ€å¤§é«˜åº¦æ—¶ï¼Œå†…éƒ¨å¯ä»¥æ»šåŠ¨ */
    font-family: inherit; /* ç»§æ‰¿æˆ‘ä»¬è®¾ç½®çš„å…¨å±€å­—ä½“ */
}

  #send-interaction-btn {
    flex-shrink: 0; /* é˜²æ­¢æŒ‰é’®è¢«å‹ç¼©å˜å½¢ */
    width: 40px;
    height: 40px;
    border-radius: 50%; /* å˜æˆä¸€ä¸ªå®Œç¾çš„åœ†å½¢ */
    background-color: #333; /* ä¸€ä¸ªé…·é…·çš„æ·±ç°è‰²/é»‘è‰² */
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background-color 0.2s;
}

#send-interaction-btn:hover {
    background-color: #555;
}

#send-interaction-btn svg {
    width: 24px;
    height: 24px;
    fill: white;
}

      /* --- æ–°å¢ï¼šå¯¹æ–¹çŠ¶æ€æµ®çª—æ ·å¼ --- */
#status-modal-content {
    gap: 12px; /* è°ƒæ•´å†…éƒ¨å…ƒç´ é—´è· */
    text-align: center; /* æ–‡å­—å±…ä¸­ */
}

.status-item {
    background-color: #f9f9f9;
    border-radius: 12px;
    padding: 12px 15px;
    width: 100%;
    box-sizing: border-box;
}

.status-title {
    font-size: 12px;
    font-weight: bold;
    color: #888;
    margin-bottom: 8px;
}

.status-content {
    font-size: 15px;
    color: #333;
}

/* å¯¹â€œå¿ƒæƒ…â€çš„é¢œæ–‡å­—è¿›è¡Œç‰¹æ®Šæ”¾å¤§å’Œç¾åŒ– */
.status-item.mood .status-content {
    font-size: 32px;
    font-weight: bold;
    color: #555;
    padding: 10px 0;
}

/* å¯¹â€œå¿ƒå£°â€è¿›è¡Œç‰¹æ®Šå¤„ç†ï¼Œè®©å®ƒçœ‹èµ·æ¥æ›´åƒå†…å¿ƒç‹¬ç™½ */
.status-item.inner-voice .status-content {
    font-style: italic;
    color: #666;
}

      /* --- æ–°å¢ï¼šè½¬è´¦é¡µé¢æ ·å¼ --- */
#transfer-container {
    padding: 20px;
    background-color: #f7f8fa;
    display: flex;
    justify-content: center;
    align-items: flex-start;
}

.transfer-card {
    width: 100%;
    max-width: 300px;
    background-color: #fff;
    border-radius: 16px;
    padding: 25px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.transfer-to-info {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 15px;
    color: #555;
}

.transfer-to-info img {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    object-fit: cover;
}

.transfer-to-info span:last-child {
    font-weight: 500;
}

.transfer-amount-area {
    display: flex;
    align-items: baseline; /* è®© Â¥ å’Œ æ•°å­—åº•éƒ¨å¯¹é½ */
    border-bottom: 2px solid #f0f0f0;
    padding-bottom: 10px;
}

.currency-symbol {
    font-size: 32px;
    font-weight: bold;
    color: #333;
    margin-right: 10px;
}

#transfer-amount-input {
    flex-grow: 1;
    border: none;
    outline: none;
    font-size: 48px;
    font-weight: bold;
    color: #333;
    background-color: transparent;
    width: 100%; /* é˜²æ­¢è¾“å…¥æ¡†è¿‡é•¿ */
}
/* éšè—number inputè‡ªå¸¦çš„ä¸Šä¸‹ç®­å¤´ */
#transfer-amount-input::-webkit-outer-spin-button,
#transfer-amount-input::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

#transfer-remark-input {
    width: 100%;
    border: none;
    outline: none;
    background-color: #f5f5f5;
    padding: 10px;
    border-radius: 8px;
    font-size: 14px;
    box-sizing: border-box;
}

#confirm-transfer-btn:disabled {
    background-color: #e0e0e0 !important; /* ç¦ç”¨æ—¶é¢œè‰²å˜ç° */
    cursor: not-allowed;
    filter: none; /* ç¦ç”¨æ—¶æ²¡æœ‰æ‚¬åœæ•ˆæœ */
}
      
      /* --- æ–°å¢ï¼šç›¸å†Œé¡µé¢æ ·å¼ --- */
#gallery-container {
    padding: 8px;
    background-color: #f7f8fa;
    /* æ ¸å¿ƒï¼šä½¿ç”¨columnå¸ƒå±€å®ç°ç€‘å¸ƒæµ */
    column-count: 2; /* åˆ†æˆä¸¤åˆ— */
    column-gap: 8px; /* ä¸¤åˆ—ä¹‹é—´çš„é—´è· */
}

.gallery-item {
    background-color: #fff;
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 8px; /* å›¾ç‰‡å¡ç‰‡ä¹‹é—´çš„å‚ç›´é—´è· */
    break-inside: avoid; /* é˜²æ­¢å¡ç‰‡åœ¨ä¸€åŠè¢«æˆªæ–­ */
    box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    display: flex;
    flex-direction: column;
}

.gallery-item-photo {
    width: 100%;
    height: auto; /* é«˜åº¦è‡ªé€‚åº”ï¼Œè¿™æ˜¯ç€‘å¸ƒæµçš„å…³é”® */
    object-fit: cover;
    background-color: #eee;
}

.gallery-item-info {
    padding: 10px;
}

.gallery-item-caption {
    font-size: 13px;
    color: #444;
    line-height: 1.6;
    margin-bottom: 8px;
    white-space: pre-wrap; /* ä¿ç•™AIç”Ÿæˆçš„æ¢è¡Œ */
}

.gallery-item-date {
    font-size: 11px;
    color: #aaa;
    text-align: right;
}

/* --- æ–°å¢ï¼šç‚¹èµä¸æ”¶è—é¡µé¢æ ·å¼ --- */
#likes-list-container {
    padding: 8px;
    background-color: #f7f8fa;
    display: grid; /* ä½¿ç”¨ç½‘æ ¼å¸ƒå±€ï¼Œæ¯è¡Œ2ä¸ª */
    grid-template-columns: 1fr 1fr;
    gap: 8px;
}

.like-item {
    background-color: #fff;
    border-radius: 8px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.like-item-cover {
    width: 100%;
    height: 200px; /* ç»™å›¾ç‰‡ä¸€ä¸ªå›ºå®šçš„é«˜åº¦ */
    object-fit: cover;
    background-color: #eee;
}

.like-item-title {
    font-size: 14px;
    font-weight: 500;
    color: #333;
    padding: 8px 10px;
    line-height: 1.5;
}

.like-item-comments {
    padding: 0 10px 8px;
    background-color: #fdfdfd;
    border-top: 1px solid #f5f5f5;
    font-size: 12px;
}
.comment-line {
    margin-top: 5px;
    color: #666;
}
.comment-line.my-comment {
    background-color: #fffbe6; /* é«˜äº®æˆ‘æ–¹è¯„è®º */
    padding: 2px 4px;
    border-radius: 3px;
}
.commenter-name {
    font-weight: bold;
    color: #555;
}

.like-item-author {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 0 10px 8px;
}
.like-item-author-avatar {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    object-fit: cover;
}
.like-item-author-name {
    font-size: 12px;
    color: #888;
}

.like-item-actions {
    display: flex;
    justify-content: flex-end; /* è®©å›¾æ ‡é å³ */
    align-items: center;
    gap: 12px;
    padding: 0 10px 8px;
    margin-top: auto; /* å…³é”®ï¼šæŠŠè¿™è¡Œæ¨åˆ°åº•éƒ¨ */
}

.like-item-actions svg {
    width: 20px;
    height: 20px;
    fill: #999; /* é»˜è®¤ç°è‰² */
    transition: all 0.2s ease;
}

/* ç‚¹èµå’Œæ”¶è—åçš„æ¿€æ´»æ ·å¼ */
.like-item-actions .like-btn.liked svg {
    fill: #ff4364; /* å°çº¢ä¹¦çš„çº¢è‰² */
    transform: scale(1.1);
}
.like-item-actions .collect-btn.collected svg {
    fill: #ffc400; /* æ ‡å¿—æ€§çš„é»„è‰² */
    transform: scale(1.1);
}

/* --- æ–°å¢ï¼šä¸ºåˆ é™¤æŒ‰é’®æ·»åŠ çº¢è‰²è­¦å‘Šæ ·å¼ --- */
.settings-item-danger span {
    color: #fa5252; /* è¿™æ˜¯ä¸€ä¸ªé†’ç›®çš„çº¢è‰² */
    font-weight: bold;
}
.settings-item-danger:hover {
    background-color: #fff5f5; /* é¼ æ ‡æ‚¬åœæ—¶èƒŒæ™¯ä¹Ÿå˜æ·¡çº¢è‰² */
}

/* --- æ–°å¢ï¼šæœ‹å‹åœˆAppä¸“å±æ ·å¼ (ä»™æ°”é‡åˆ¶ç‰ˆ) --- */

      #moments-page .page-header {
    background-color: transparent;
    border-bottom: none;
    position: absolute; /* è®©å®ƒæµ®åŠ¨åœ¨èƒŒæ™¯å›¾ä¸Šå±‚ */
    width: 100%;
    box-sizing: border-box; /* ç¡®ä¿paddingä¸ä¼šè®©å®ƒè¶…å‡ºå±å¹• */
    z-index: 5; /* ç¡®ä¿å®ƒåœ¨æœ€é¡¶å±‚ */
}
      
#moments-page .page-content {
    background: linear-gradient(to bottom, #f7f8fa, #ffffff); /* èƒŒæ™¯ï¼šä»ææµ…ç°åˆ°çº¯ç™½çš„æ¸å˜ï¼Œæ›´æŸ”å’Œ */
    padding: 0; /* ç§»é™¤å†…è¾¹è·ï¼Œè®©å†…å®¹æ’‘æ»¡ */
}

/* --- é¡¶éƒ¨èƒŒæ™¯ä¸å¤´åƒåŒºåŸŸ --- */
#moments-profile-header {
    position: relative;
    margin-bottom: 50px; /* å¢åŠ ä¸ä¸‹æ–¹åŠ¨æ€çš„è·ç¦»ï¼Œå‘¼å¸æ„Ÿæ›´å¼º */
}

#moments-bg {
    width: 100%;
    height: 220px; /* èƒŒæ™¯å›¾é«˜åº¦å¢åŠ  */
    background-color: #e0e0e0;
    background-size: cover;
    background-position: center;
    transition: height 0.3s ease;
    position: relative;
    border-bottom: 1px solid rgba(0,0,0,0.05); /* åŠ ä¸€æ¡æç»†çš„ä¸‹è¾¹çº¿ */
}

#moments-bg::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 80%;
    background: linear-gradient(to top, rgba(255,255,255,0.8), transparent); /* æ¸å˜é®ç½©æ›´æ˜æ˜¾ï¼Œä»™æ°” */
}

#moments-my-avatar {
    width: 70px; /* å¤´åƒå°ºå¯¸å¾®è°ƒ */
    height: 70px;
    border-radius: 12px; /* åœ†è§’æ–¹å½¢å¤´åƒï¼Œæ›´æŸ”å’Œ */
    /* å…³é”®æ”¹åŠ¨ï¼šå»é™¤äº†ç™½è‰²è¾¹æ¡† */
    box-shadow: 0 4px 15px rgba(0,0,0,0.1); /* é˜´å½±æ›´æŸ”å’Œã€æ›´æ·±è¿œ */
    position: absolute;
    right: 20px;
    bottom: -35px; /* ä¿æŒä¸€åŠåœ¨å¤–çš„å¸ƒå±€ */
    object-fit: cover; /* ä¿è¯å›¾ç‰‡ä¸å˜å½¢ */
}

#moments-bg-controls {
    position: absolute;
    bottom: 10px;
    left: 15px; /* å…³é”®æ”¹åŠ¨ï¼šä» right: 10px æ”¹ä¸º left: 15px */
    display: flex;
    gap: 8px;
}

#moments-bg-controls button {
    padding: 5px 10px;
    font-size: 10px;
    background-color: rgba(255, 255, 255, 0.5); /* æŒ‰é’®ä¹Ÿç”¨åŠé€æ˜æ•ˆæœ */
    backdrop-filter: blur(5px);
    color: #333; /* å­—ä½“é¢œè‰²å˜æ·±ï¼Œåœ¨äº®èƒŒæ™¯ä¸‹æ›´æ¸…æ™° */
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 12px;
    cursor: pointer;
}

/* --- åœˆå­é€‰æ‹©åŒºåŸŸ --- */
#moments-circle-selector-area {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 15px 20px;
}

#moments-circle-selector-area select,
#moments-circle-selector-area button {
    padding: 8px 14px;
    border-radius: 18px; /* æ›´åœ†æ¶¦çš„â€œè¯ä¸¸â€å½¢çŠ¶ */
    border: 1px solid #e8e8e8;
    background-color: #fff;
    font-size: 12px;
    cursor: pointer;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04); /* å¢åŠ å¾®å¼±çš„ç«‹ä½“æ„Ÿ */
}

/* --- åŠ¨æ€å¡ç‰‡åŒºåŸŸ --- */
#moments-feed-container {
    padding: 0 12px 20px; /* å·¦å³å†…è¾¹è·è°ƒå°ï¼Œè®©å¡ç‰‡æ›´å¤§æ°” */
}

.moment-card {
    /* åˆ é™¤äº†æ‰€æœ‰èƒŒæ™¯ã€è¾¹æ¡†ã€é˜´å½±å’Œåœ†è§’ */
    padding: 20px 0; /* ä¸Šä¸‹ç•™å‡ºé—´è·ï¼Œå·¦å³ä¸ç•™ */
    margin-bottom: 0;
    border-bottom: 1px solid #e8e8e8; /* ç”¨ä¸€æ¡æç»†çš„åˆ†å‰²çº¿ä»£æ›¿å¡ç‰‡ */
}
#moments-feed-container {
    padding: 0 18px 20px; /* å·¦å³å†…è¾¹è·æ”¹å›ç¨å¤§ä¸€ç‚¹ï¼Œè®©å†…å®¹åŒºæ›´èˆ’é€‚ */
}

.moment-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px; /* ç¼©å°äº†ä¸ä¸‹æ–¹æ–‡å­—çš„è·ç¦» */
}
.moment-author-info { /* æ–°å¢ä¸€ä¸ªå®¹å™¨åŒ…è£¹å¤´åƒå’Œåå­— */
    display: flex;
    align-items: center;
    gap: 12px;
}
.moment-author-info img { /* å¤´åƒæ ·å¼ */
    width: 44px;
    height: 44px;
    border-radius: 8px;
    object-fit: cover;
}
.moment-author-name {
    font-weight: 500;
    color: #333;
    font-size: 15px;
}

.moment-text {
    font-size: 15px;
    line-height: 1.7; /* å…³é”®æ”¹åŠ¨ï¼šè¡Œé«˜å¾®è°ƒï¼Œè®©æ–‡å­—æ›´ç´§å‡‘ç²¾è‡´ */
    color: #333; /* å­—ä½“é¢œè‰²åŠ æ·±ä¸€ç‚¹ï¼Œå¯¹æ¯”æ›´æ¸…æ™° */
    white-space: pre-wrap;
    padding: 0; /* å…³é”®æ”¹åŠ¨ï¼šç§»é™¤äº†ä¸Šä¸‹çš„å†…è¾¹è· */
    margin-top: 5px; /* ç”¨å¤–è¾¹è·æ¥æ§åˆ¶ä¸ä¸Šæ–¹ä½œè€…ä¿¡æ¯çš„è·ç¦» */
}

.moment-image-desc {
    background-color: rgba(0,0,0,0.03); /* å›¾ç‰‡æè¿°ç”¨æ›´æ·¡çš„èƒŒæ™¯ */
    border: none;
    border-radius: 12px;
    padding: 12px;
    margin-top: 12px;
    font-size: 13px;
    color: #666;
    display: flex;
    align-items: center;
    gap: 10px;
}
.moment-image-desc::before {
    content: 'ğŸ–¼ï¸';
    font-size: 16px;
}

.moment-footer { /* æ–°å¢ä¸€ä¸ªå®¹å™¨åŒ…è£¹æ—¶é—´å’Œäº¤äº’ */
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 15px;
    color: #aaa;
    font-size: 12px;
}

.moment-interactions {
    border-top: 1px solid rgba(0,0,0,0.05);
    margin-top: 15px;
    padding-top: 15px;
}

.moment-likes {
    font-size: 14px;
    color: #555;
    padding: 5px 0;
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap; /* ç‚¹èµäººå¤šæ—¶å¯ä»¥æ¢è¡Œ */
}
.moment-likes svg {
    width: 18px;
    height: 18px;
    fill: #ff4364;
    flex-shrink: 0; /* é˜²æ­¢å›¾æ ‡è¢«å‹ç¼© */
}

.moment-comment {
    font-size: 14px;
    margin-top: 8px;
    line-height: 1.7;
}
.moment-comment .commenter-name {
    font-weight: 500;
    color: #555;
}

/* å¼¹çª—é€šç”¨æ ·å¼ */
.moments-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 200;
}
.moments-modal-content {
    background-color: white;
    padding: 20px;
    border-radius: 16px;
    width: 85%;
    max-width: 320px;
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.moments-modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 10px;
}

/* åœˆå­ç®¡ç†å¼¹çª—å†…çš„è”ç³»äººåˆ—è¡¨ */
#circle-contacts-list {
    max-height: 150px;
    overflow-y: auto;
    border: 1px solid #eee;
    border-radius: 8px;
    padding: 5px;
}
.circle-contact-item {
    display: flex;
    align-items: center;
    padding: 5px;
}
.circle-contact-item input {
    margin-right: 10px;
}
#existing-circles-list .circle-item {
    display: flex;
    justify-content: space-between;
    font-size: 14px;
    padding: 5px 0;
}
#existing-circles-list .delete-circle-btn {
    cursor: pointer;
    color: red;
}

/* --- æ–°å¢ï¼šç¾åŒ–æœ‹å‹åœˆå‘å¸ƒå¼¹çª—å†…çš„è¾“å…¥æ¡† --- */
.moments-modal-content textarea,
.moments-modal-content input[type="text"],
.moments-modal-content select {
    width: 100%; /* å®½åº¦æ’‘æ»¡ */
    padding: 10px;
    border: 1px solid #eeeeee; /* å’Œå…¶ä»–è¾“å…¥æ¡†ç»Ÿä¸€çš„ææµ…ç°è‰²è¾¹æ¡† */
    border-radius: 8px; /* åœ†è§’ */
    background-color: #f9f9f9; /* æ¯”ç™½è‰²ç¨æ·±çš„èƒŒæ™¯ */
    box-sizing: border-box; /* ç¡®ä¿paddingä¸ä¼šæ’‘å¤§å®½åº¦ */
    font-size: 14px;
    font-family: inherit; /* ç»§æ‰¿é¡µé¢å­—ä½“ï¼Œä¿æŒé£æ ¼ç»Ÿä¸€ */
    resize: vertical; /* åªå…è®¸æ–‡æœ¬æ¡†å‚ç›´æ‹‰ä¼¸ */
}

/* å¼¹çª—å†…çš„æ–‡å­—æ ‡ç­¾æ ·å¼ */
.moments-modal-content label {
    font-size: 12px;
    font-weight: bold;
    color: #555;
    margin-top: 5px; /* å’Œä¸Šé¢çš„å…ƒç´ ç•™å‡ºä¸€ç‚¹è·ç¦» */
}

/* --- æ–°å¢ï¼šæœ‹å‹åœˆâ€œæˆ‘çš„è¯„è®ºåŒºâ€æ ·å¼ --- */
.moment-my-comment-area {
    display: flex;
    gap: 8px;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid #f5f5f5;
}
.moment-my-comment-area input {
    flex-grow: 1; /* å æ®æ‰€æœ‰å‰©ä½™ç©ºé—´ */
    border: 1px solid #e0e0e0;
    background-color: #f7f8fa;
    border-radius: 16px;
    padding: 6px 12px;
    font-size: 13px;
}
.moment-my-comment-area button {
    flex-shrink: 0;
    padding: 6px 12px;
    border: none;
    background-color: #333;
    color: white;
    border-radius: 16px;
    font-size: 13px;
    font-weight: bold;
    cursor: pointer;
}

/* --- æ–°å¢ï¼šæœ‹å‹åœˆåˆ é™¤æŒ‰é’®æ ·å¼ --- */
.moment-header {
    /* è®©å¤´åƒå’Œåˆ é™¤æŒ‰é’®å·¦å³å¯¹é½çš„å…³é”® */
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.moment-delete-btn {
    cursor: pointer; /* é¼ æ ‡æ”¾ä¸Šå»æ—¶æ˜¾ç¤ºå°æ‰‹å›¾æ ‡ */
}
.moment-delete-btn svg {
    fill: #cccccc; /* é»˜è®¤ç»™ä¸€ä¸ªæµ…ç°è‰² */
    transition: all 0.2s ease; /* æ·»åŠ ä¸€ä¸ªå¹³æ»‘çš„è¿‡æ¸¡æ•ˆæœ */
}
.moment-delete-btn:hover svg {
    fill: #fa5252; /* é¼ æ ‡æ‚¬åœæ—¶å˜ä¸ºé†’ç›®çš„çº¢è‰² */
    transform: scale(1.1); /* è½»å¾®æ”¾å¤§ï¼Œæä¾›åé¦ˆ */
}

/* --- æ–°å¢ï¼šæœ‹å‹åœˆå›å¤åŠŸèƒ½æ ·å¼ --- */
    .moment-comment-content {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }
    
    .moment-reply-btn {
        font-size: 12px;
        color: #888;
        cursor: pointer;
        font-weight: bold;
        flex-shrink: 0;
        margin-left: 10px;
    }
    .moment-reply-btn:hover {
        color: #333;
    }

    /* ç›–æ¥¼çš„æ ¸å¿ƒï¼šå›å¤çš„è¯„è®ºä¼šæœ‰å·¦è¾¹è·ï¼Œå½¢æˆç¼©è¿› */
    .moment-comment.is-reply {
        margin-left: 20px;
        margin-top: 8px;
        padding-left: 10px;
        border-left: 2px solid #f0f0f0;
    }
    
    /* --- æ–°å¢ï¼šæœ‹å‹åœˆâ€œå±•å¼€æ›´å¤šâ€æŒ‰é’®æ ·å¼ --- */
#load-more-moments-btn {
    display: block; /* è®©æŒ‰é’®ç‹¬å ä¸€è¡Œ */
    width: 80%;
    max-width: 200px;
    margin: 20px auto; /* ä¸Šä¸‹20pxé—´è·ï¼Œå¹¶æ°´å¹³å±…ä¸­ */
    padding: 10px;
    font-size: 14px;
    font-weight: bold;
    color: #555;
    background-color: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 20px; /* å¯çˆ±çš„åœ†è§’ */
    cursor: pointer;
    transition: all 0.2s ease;
}
#load-more-moments-btn:hover {
    background-color: #f5f5f5;
    border-color: #ccc;
}
    </style>
</head>
<body>

    <!-- è¿™æ˜¯æˆ‘ä»¬æ‰‹æœºå±å¹•çš„HTMLç»“æ„ -->
    <div id="phone-screen">
        
        <!-- 1. é¡¶éƒ¨çš„çŠ¶æ€æ  -->
        <div id="status-bar">
            <div id="time-display">10:08</div>
            <div id="battery-icon">
                <div id="battery-level"></div>
            </div>
        </div>
        <!-- // end #status-bar -->

        <!-- 2. ä¸­é—´çš„ä¸»è¦å†…å®¹ -->
        <div id="main-content">
            <div id="avatar-container">
                
                <img id="avatar-img" src="" alt="avatar">
                <input type="file" id="avatar-input" accept="image/*" style="display: none;">
                
            </div>
            <!-- // end #avatar-container -->
            <div id="app-drawer">
                <div class="app-icon" id="app-settings-icon">
                    <svg viewBox="0 0 24 24" fill="#ffffff"><path d="M19.4,12c0-0.2,0-0.4,0-0.6c0-0.2,0-0.4,0-0.6l2.1-1.7c0.2-0.1,0.2-0.4,0.1-0.6l-2-3.5C19.5,4.8,19.2,4.8,19,4.9l-2.5,1 c-0.5-0.4-1.1-0.7-1.7-1l-0.4-2.7C14.4,2.1,14.2,2,14,2h-4c-0.2,0-0.4,0.1-0.4,0.3l-0.4,2.7c-0.6,0.2-1.2,0.6-1.7,1L5,4.9 C4.8,4.8,4.5,4.8,4.4,5.1l-2,3.5C2.3,8.8,2.4,9.1,2.6,9.2l2.1,1.7c0,0.2,0,0.4,0,0.6c0,0.2,0,0.4,0,0.6l-2.1,1.7 C2.4,14.9,2.3,15.2,2.4,15.4l2,3.5C4.5,19.2,4.8,19.2,5,19.1l2.5-1c0.5,0.4,1.1,0.7,1.7,1l0.4,2.7C9.6,21.9,9.8,22,10,22h4 c0.2,0,0.4-0.1,0.4-0.3l0.4-2.7c0.6-0.2,1.2-0.6,1.7-1l2.5,1c0.2,0.1,0.5,0.1,0.6-0.1l2-3.5c0.1-0.2,0.1-0.5-0.1-0.6L19.4,12z M12,15.5c-1.9,0-3.5-1.6-3.5-3.5s1.6-3.5,3.5-3.5s3.5,1.6,3.5,3.5S13.9,15.5,12,15.5z"/></svg>
                    <span>APIè®¾ç½®</span>
                </div>
                <div class="app-icon" id="app-chat-icon">
                    <svg viewBox="0 0 24 24" fill="#ffffff"><path d="M20,2H4C2.9,2,2,2.9,2,4v18l4-4h14c1.1,0,2-0.9,2-2V4C22,2.9,21.1,2,20,2z M18,12h-2v-2h2V12z M14,12h-2v-2h2V12z M10,12H8v-2h2V12z"/></svg>
                    <span>Chat</span>
                </div>
                <div class="app-icon" id="app-theme-icon">
                    <svg viewBox="0 0 24 24" fill="#ffffff"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8zm-5.5 9c-.83 0-1.5.67-1.5 1.5S5.67 15 6.5 15 8 14.33 8 13.5 7.33 12 6.5 12zm3-4c-.83 0-1.5.67-1.5 1.5S8.67 11 9.5 11s1.5-.67 1.5-1.5S10.33 8 9.5 8zm5 0c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5S15.33 8 14.5 8zm3 4c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5z"/></svg>
                    <span>ä¸»é¢˜ç¾åŒ–</span>
                </div>
                <div class="app-icon" id="app-check-phone-icon">
                    <svg viewBox="0 0 24 24" fill="#ffffff"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                    <span>æŸ¥æ‰‹æœº</span>
                </div>
                <!-- æ–°å¢ï¼šæœ‹å‹åœˆAppå›¾æ ‡ -->
<div class="app-icon" id="app-moments-icon">
    <svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M512 1024a512 512 0 1 1 512-512 512 512 0 0 1-512 512z m0-960a448 448 0 1 0 448 448A448 448 0 0 0 512 64z m-32 480a32 32 0 1 1-64 0 32 32 0 0 1 64 0z m128 0a32 32 0 1 1-64 0 32 32 0 0 1 64 0z" fill="#707070"></path></svg>
    <span>æœ‹å‹åœˆ</span>
</div>
                
            </div>
            <!-- // end #app-drawer -->
        </div>
        <!-- // end #main-content -->


        <!-- åº”ç”¨é¡µé¢å…¨éƒ¨åœ¨è¿™é‡Œ -->

        <!-- é¡µé¢1: API è®¾ç½®é¡µé¢ -->
        <div class="app-page" id="api-settings-page">
            <div class="page-header">
                <span class="back-button">â†</span>
                <h2>API è®¾ç½®</h2>
            </div>
            <div class="page-content">
                <div class="settings-form">
                    <label for="api-base-input">API Base URL</label>
                    <input type="text" id="api-base-input" placeholder="ä¾‹å¦‚ï¼šhttp://localhost:1234/v1">
                    <label for="api-key-input">API Key</label>
                    <input type="password" id="api-key-input" placeholder="è¯·è¾“å…¥æ‚¨çš„ API å¯†é’¥">
                    <button id="fetch-models-btn" class="settings-btn">æ‹‰å–æ¨¡å‹</button>
                    <hr class="divider">
                    <label>å¯ç”¨æ¨¡å‹</label>
                    <div id="model-list-container">
                        <p class="placeholder-text">ç‚¹å‡»â€œæ‹‰å–æ¨¡å‹â€åï¼Œå¯ç”¨çš„æ¨¡å‹ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œã€‚</p>
                    </div>
                    <button id="save-settings-btn" class="settings-btn">ä¿å­˜æ¨¡å‹è®¾ç½®</button>
                </div>
            </div>
        </div>
        <!-- // end #api-settings-page -->

        <!-- é¡µé¢2: Chat åˆ—è¡¨é¡µé¢ -->
        <div class="app-page" id="chat-list-page">
             <div class="page-header">
                <span class="back-button">â†</span>
                <h2>Chat</h2>
                <span class="add-button">+</span>
            </div>
            <div class="page-content">
                <div id="chat-list-container">
                    <div class="chat-list-item">
                        <img class="chat-avatar" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23e0e0e0'/%3E%3C/svg%3E" alt="avatar">
                        <div class="chat-info">
                            <div class="chat-name">ç¤ºä¾‹è”ç³»äºº</div>
                            <div class="chat-last-message">è¿™æ˜¯æˆ‘ä»¬ä¹‹é—´çš„ç¬¬ä¸€æ¡æ¶ˆæ¯...</div>
                        </div>
                    </div>
                    <p id="no-chats-placeholder" style="display: none;">è¿˜æ²¡æœ‰è”ç³»äººï¼Œç‚¹å‡»å³ä¸Šè§’çš„ '+' æ·»åŠ ä¸€ä¸ªå§ï¼</p>
                </div>
            </div>
        </div>
        <!-- // end #chat-list-page -->

        <!-- é¡µé¢3: æ·»åŠ è”ç³»äººé¡µé¢ -->
        <div class="app-page" id="add-contact-page">
             <div class="page-header">
                <span class="back-button">â†</span>
                <h2>æ·»åŠ è”ç³»äºº</h2>
            </div>
            <div class="page-content">
                <div class="contact-form">
                    <div class="contact-avatar-picker">
                        <img id="contact-avatar-preview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23e0e0e0'/%3E%3C/svg%3E" alt="avatar preview">
                        <input type="file" id="contact-avatar-input" accept="image/*" style="display: none;">
                        <span>ç‚¹å‡»è®¾ç½®å¤´åƒ</span>
                    </div>
                    <label for="contact-name-input">æ˜µç§°</label>
                    <input type="text" id="contact-name-input" placeholder="å†™ä¸‹ä»–çš„åå­—å§ï½">
                    <label>æ€§åˆ«</label>
                    <div class="gender-selection">
                        <input type="radio" id="gender-male" name="gender" value="male" checked>
                        <label for="gender-male">ç”·</label>
                        <input type="radio" id="gender-female" name="gender" value="female">
                        <label for="gender-female">å¥³</label>
                        <input type="radio" id="gender-other" name="gender" value="other">
                        <label for="gender-other">å…¶ä»–</label>
                    </div>
                    <label for="contact-persona-input">äººè®¾ (Persona)</label>
                    <textarea id="contact-persona-input" rows="4" placeholder="å†™ä¸‹ä»–çš„äººè®¾å§ï½"></textarea>
                    <label for="contact-style-input">è¯´è¯é£æ ¼</label>
                    <textarea id="contact-style-input" rows="4" placeholder="ä¾‹å¦‚ï¼šå–œæ¬¢ç”¨äº²æ˜µçš„ç§°å‘¼ï¼Œè¯­æ°”æ¸©æŸ”ï¼Œå¶å°”ä¼šåˆ†äº«ä¸€äº›æœ‰è¶£çš„å°çŸ¥è¯†..."></textarea>
                    <button id="add-contact-btn" class="settings-btn">ç¡®è®¤æ·»åŠ </button>
                </div>
            </div>
        </div>
        <!-- // end #add-contact-page -->

        <!-- é¡µé¢4: èŠå¤©å®¤é¡µé¢ (è¿™æ˜¯æ›¿æ¢åçš„å®Œæ•´ä»£ç å—) -->
        <div class="app-page" id="chat-room-page">
        <!-- æ–°å¢ï¼šè¿™æ˜¯é•¿æŒ‰æ¶ˆæ¯åå¼¹å‡ºçš„ä¸Šä¸‹æ–‡èœå• -->
<div id="message-context-menu">
    <button class="context-menu-btn" id="edit-msg-btn">ç¼–è¾‘</button>
    <button class="context-menu-btn" id="delete-msg-btn">åˆ é™¤</button>
</div>
             <div class="page-header">
             
                <span class="back-button">â†</span>
                <h2 id="chat-room-title">ä¸...èŠå¤©</h2>
                <!-- æ–°å¢ï¼šèŠå¤©å®¤å³ä¸Šè§’èœå•æŒ‰é’® -->
<div id="chat-menu-btn" class="chat-btn" style="position: absolute; right: 15px;">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
</div>
            </div>
            
            <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
            <div class="page-content chat-area" id="chat-area">
                <!-- è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹æ¶ˆæ¯ï¼Œç”¨æ¥é¢„è§ˆæ ·å¼ -->
                <div class="chat-message received">
                    <div class="message-bubble">ä½ å¥½å‘€ï¼Œä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿ</div>
                </div>
                <div class="chat-message sent">
                    <div class="message-bubble">æˆ‘å¾ˆå¥½ï¼Œä½ å‘¢ï¼Ÿ</div>
                </div>
                <div class="chat-message received">
                    <div class="message-bubble">æˆ‘ä¹Ÿå¾ˆå¥½ï¼Œä»Šå¤©å¤©æ°”çœŸä¸é”™ï¼æˆ‘ä»¬èŠç‚¹ä»€ä¹ˆå¼€å¿ƒçš„äº‹æƒ…å§ï¼Ÿ</div>
                </div>
            </div>

            <!-- èŠå¤©è¾“å…¥æ¡†åŒºåŸŸ (å·²å‡çº§æ”¯æŒæ¨¡å¼åˆ‡æ¢) -->
<div class="chat-input-area">
    <!-- æ–°å¢ï¼šå·¦ä¾§çš„æ¨¡å¼åˆ‡æ¢æŒ‰é’® -->
    <button id="input-mode-btn" class="chat-btn">
        <!-- é»˜è®¤æ˜¯åŠ å· -->
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
    </button>

    <textarea id="message-input" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1"></textarea>
    
    <!-- å³ä¾§çš„å‘é€æŒ‰é’®ä»¬ (é»˜è®¤éšè—è¯­éŸ³å‘é€) -->
    <button id="send-btn" class="chat-btn">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
    </button>
    <button id="send-voice-btn" class="chat-btn" style="display: none;">
        <!-- è¿™æ˜¯ä¸€ä¸ªéº¦å…‹é£å›¾æ ‡ -->
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.49 6-3.31 6-6.72h-1.7z"/></svg>
    </button>

    <button id="receive-btn" class="chat-btn">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-12h2v4h-2v-4zm0 6h2v2h-2v-2z"/></svg>
    </button>
</div>
        </div>
        <!-- // end #chat-room-page -->
        
        <!-- æ–°å¢ï¼šé™„åŠ åŠŸèƒ½å¼¹çª— -->
<div id="action-popup-overlay" style="display: none;">
    <div id="action-popup">
        <div class="action-btn" id="action-voice-btn">
            <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.49 6-3.31 6-6.72h-1.7z"/></svg>
            <span>å‘é€è¯­éŸ³</span>
        </div>
        <div class="action-btn" id="action-image-btn">
            <svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
            <span>å‘é€å›¾ç‰‡</span>
        </div>
      <div class="action-btn" id="action-transfer-btn">
            <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zM4 18V6h16v12H4zm8-7H9.5v1.25c0 .41-.34.75-.75.75s-.75-.34-.75-.75V11H6.75c-.41 0-.75-.34-.75-.75s.34-.75.75-.75h1.25V8.25c0-.41.34-.75.75-.75s.75.34.75.75V9.5H12c1.66 0 3 1.34 3 3s-1.34 3-3 3h-1.5v-1.25c0-.41.34-.75.75-.75s.75.34.75.75V15h1.25c.41 0 .75.34.75.75s-.34.75-.75.75h-1.25v1.25c0 .41-.34.75-.75.75s-.75-.34-.75-.75V16.5H8c-1.66 0-3-1.34-3-3s1.34-3 3-3z"/></svg>
            <span>è½¬è´¦</span>
        </div>
     <div class="action-btn" id="action-status-btn">
            <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg>
            <span>æŸ¥çœ‹çŠ¶æ€</span>
        </div> 
      <div class="action-btn" id="action-interaction-btn">
            <svg viewBox="0 0 24 24"><path d="M21.99 4c0-1.1-.89-2-1.99-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4-.01-18zM18 14H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"></path></svg>
            <span>é€šè®¯äº’åŠ¨</span>
        </div>
    </div>
</div>
        
        <!-- é¡µé¢5: èŠå¤©è®¾ç½®ä¸»èœå• -->
<div class="app-page" id="chat-settings-menu-page">
    <div class="page-header">
        <span class="back-button">â†</span>
        <h2>èŠå¤©è®¾ç½®</h2>
    </div>
    <div class="page-content">
        <div class="settings-list">
    <div class="settings-item" id="goto-contact-info">
        <span>è”ç³»äººä¿¡æ¯</span>
        <span>&gt;</span>
    </div>
    <div class="settings-item" id="goto-chat-settings">
        <span>èŠå¤©è®¾ç½®</span>
        <span>&gt;</span>
    </div>
    <div class="settings-item" id="goto-my-info">
        <span>æˆ‘çš„ä¿¡æ¯</span>
        <span>&gt;</span>
    </div>
    <div class="settings-item" id="goto-bubble-settings">
        <span>æ°”æ³¡æ ·å¼</span>
        <span>&gt;</span>
    </div>
</div>

<!-- æ–°å¢ï¼šåˆ é™¤è”ç³»äººæŒ‰é’® -->
<div class="settings-list" style="margin-top: 20px;">
    <div class="settings-item settings-item-danger" id="delete-contact-btn">
        <span>åˆ é™¤è¯¥è”ç³»äºº</span>
        <span>&gt;</span>
    </div>
</div>
    </div>
</div>
<!-- // end #chat-settings-menu-page -->

<!-- é¡µé¢6: å…·ä½“çš„èŠå¤©è®¾ç½®é¡µé¢ (è®°å¿†å’ŒèƒŒæ™¯) -->
<div class="app-page" id="chat-specific-settings-page">
    <div class="page-header">
        <span class="back-button">â†</span>
        <h2>èŠå¤©è®¾ç½®</h2>
    </div>
    <div class="page-content">
        <div class="settings-form">
            <div class="settings-group">
    <label for="memory-count-input">èŠå¤©è®°å¿† (æœ€è¿‘Næ¡)</label>
    <input type="number" id="memory-count-input" placeholder="å»ºè®® 2-20ï¼Œé»˜è®¤ä¸º 10" min="0">
</div>
            <div class="settings-group">
            <!-- æ–°å¢ï¼šæ„ŸçŸ¥ç°å®æ—¶é—´å¼€å…³ -->
<div class="settings-group">
    <label>æ„ŸçŸ¥ç°å®æ—¶é—´</label>
    <div class="toggle-switch-container">
        <input type="checkbox" id="time-awareness-toggle" class="toggle-switch-checkbox">
        <label for="time-awareness-toggle" class="toggle-switch-label"></label>
        <span class="toggle-switch-description">å¼€å¯åï¼ŒTAä¼šçŸ¥é“å½“å‰çš„çœŸå®æ—¶é—´</span>
    </div>
</div>
                <label>èŠå¤©èƒŒæ™¯</label>
                <input type="file" id="chat-bg-input" accept="image/*" style="display: none;">
                <button class="settings-btn" onclick="document.getElementById('chat-bg-input').click();">é€‰æ‹©èƒŒæ™¯å›¾ç‰‡</button>
                <button class="settings-btn" id="clear-chat-bg-btn" style="background-color: #f5f5f5; margin-top: 10px;">æ¸…é™¤èŠå¤©èƒŒæ™¯</button>
            </div>
            <button id="save-chat-specific-settings-btn" class="settings-btn">ä¿å­˜è®¾ç½®</button>
        </div>
    </div>
</div>
<!-- // end #chat-specific-settings-page -->

<!-- é¡µé¢7: â€œæˆ‘çš„ä¿¡æ¯â€è®¾ç½®é¡µé¢ -->
<div class="app-page" id="my-info-for-chat-page">
    <div class="page-header">
        <span class="back-button">â†</span>
        <h2>æˆ‘çš„ä¿¡æ¯</h2>
    </div>
    <div class="page-content">
        <div class="settings-form">
             <div class="settings-group">
                <label>æˆ‘çš„å¤´åƒ (æœ¬æ¬¡å¯¹è¯ä¸­)</label>
                <div class="contact-avatar-picker" id="my-avatar-picker">
                    <img id="my-avatar-preview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='8' fill='%23d0d0d0'/%3E%3C/svg%3E" alt="my avatar preview">
                    <input type="file" id="my-avatar-input" accept="image/*" style="display: none;">
                    <span>ç‚¹å‡»è®¾ç½®å¤´åƒ</span>
                </div>
            </div>
            <div class="settings-group">
                <label for="my-persona-input">æˆ‘çš„äººè®¾ (å‘Šè¯‰å¯¹æ–¹TAè¯¥å¦‚ä½•ä¸æˆ‘äº’åŠ¨)</label>
                <textarea id="my-persona-input" rows="6" placeholder="ä¾‹å¦‚ï¼šæˆ‘æ˜¯ä½ çš„å­¦ç”Ÿï¼Œå¯¹ä½ éå¸¸å´‡æ‹œï¼Œè¯·ç”¨è€å¸ˆçš„å£å»å¯¹æˆ‘è¯´è¯ã€‚"></textarea>
            </div>
            <button id="save-my-info-btn" class="settings-btn">ä¿å­˜ä¿¡æ¯</button>
        </div>
    </div>
</div>
<!-- // end #my-info-for-chat-page -->
<!-- é¡µé¢X: æ°”æ³¡æ ·å¼è®¾ç½®é¡µé¢ -->
<div class="app-page" id="bubble-settings-page">
    <div class="page-header">
        <span class="back-button">â†</span>
        <h2>æ°”æ³¡æ ·å¼</h2>
    </div>
    <div class="page-content">
        <div class="settings-form">
            <div class="settings-group">
                <label>æˆ‘çš„æ°”æ³¡é¢œè‰²</label>
                <div class="color-input-wrapper">
                    <input type="color" id="user-bubble-color-input">
                    <span id="user-bubble-color-value">#e1f5fe</span>
                </div>
            </div>
            <div class="settings-group">
                <label>å¯¹æ–¹æ°”æ³¡é¢œè‰²</label>
                <div class="color-input-wrapper">
                    <input type="color" id="assistant-bubble-color-input">
                    <span id="assistant-bubble-color-value">#ffffff</span>
                </div>
            </div>
            <hr class="divider">
            <div class="settings-group">
                <label>æ°”æ³¡å†…è¾¹è· (ä¸Šä¸‹ / å·¦å³)</label>
                <div class="dimension-inputs">
                    <input type="number" id="bubble-padding-y-input" min="5" max="20" placeholder="ä¸Šä¸‹">
                    <span>/</span>
                    <input type="number" id="bubble-padding-x-input" min="8" max="25" placeholder="å·¦å³">
                </div>
            </div>
            <div class="settings-group">
                <label>æ°”æ³¡å­—ä½“å¤§å° (12-18px)</label>
                <div class="slider-container">
                    <input type="range" id="bubble-font-size-slider" min="12" max="18" step="1">
                    <span id="bubble-font-size-value">15px</span>
                </div>
            </div>
            <button id="save-bubble-settings-btn" class="settings-btn">ä¿å­˜æ°”æ³¡è®¾ç½®</button>
        </div>
    </div>
</div>
<!-- // end #bubble-settings-page -->
<!-- é¡µé¢8: ä¸»é¢˜ç¾åŒ–é¡µé¢ -->
<div class="app-page" id="theme-settings-page">
    <div class="page-header">
        <span class="back-button">â†</span>
        <h2>ä¸»é¢˜ç¾åŒ–</h2>
    </div>
    <div class="page-content">
        <div class="settings-form">
            <label>ä¸»å±å¹•å£çº¸é¢„è§ˆ</label>
            <div id="wallpaper-preview-container">
                
                <img id="avatar-img-preview" src="" alt="avatar preview">
            </div>

            <input type="file" id="wallpaper-input" accept="image/*" style="display: none;">
            <button class="settings-btn" onclick="document.getElementById('wallpaper-input').click();">æ›´æ¢ä¸»å±å¹•å£çº¸</button>
          <input type="file" id="app-bg-input" accept="image/*" style="display: none;">
            <button class="settings-btn" onclick="document.getElementById('app-bg-input').click();" style="margin-top: 10px;">æ›´æ¢åº”ç”¨é¡µé¢èƒŒæ™¯</button>
          <button class="settings-btn" id="clear-app-bg-btn" style="background-color: #f5f5f5; margin-top: 10px;">æ¸…é™¤åº”ç”¨é¡µé¢èƒŒæ™¯</button>
            <hr class="divider">
            <label>é€‰æ‹©ä¸»é¢˜é¢œè‰²</label>
            <div id="theme-selector">
                <div class="theme-swatch" id="theme-pink-btn" data-theme="theme-pink" style="background-color: #FFECF2;"></div>
                <div class="theme-swatch" id="theme-blue-btn" data-theme="theme-blue" style="background-color: #E6F0F6;"></div>
                <div class="theme-swatch" id="theme-yellow-btn" data-theme="theme-yellow" style="background-color: #FFF9E6;"></div>
                <div class="theme-swatch" id="theme-green-btn" data-theme="theme-green" style="background-color: #F0F8E8;"></div>
            </div>
            <hr class="divider">
<label>åº”ç”¨å°ºå¯¸å’Œå¤–è§‚</label>
<div class="settings-group">
    <div class="dimension-inputs">
        <input type="number" id="app-width-input" placeholder="å®½åº¦(px)">
        <span>Ã—</span>
        <input type="number" id="app-height-input" placeholder="é«˜åº¦(px)">
    </div>
</div>
<div class="settings-group">
    <div class="toggle-switch-container">
        <span>è¾¹æ¡†åœ†è§’æ¨¡å¼</span>
        <input type="checkbox" id="rounded-corners-toggle" class="toggle-switch-checkbox">
        <label for="rounded-corners-toggle" class="toggle-switch-label"></label>
    </div>
</div>
            <button class="settings-btn" id="reset-theme-btn" style="background-color: #f5f5f5;">æ¢å¤é»˜è®¤ä¸»é¢˜</button>
            <button class="settings-btn" id="clear-wallpaper-btn" style="background-color: #f5f5f5;">æ¸…é™¤å£çº¸å¹¶æ¢å¤é»˜è®¤</button>
            <hr class="divider">
<label>å…¨å±€ç¾åŒ– CSS (é«˜çº§åŠŸèƒ½)</label>
<div class="settings-group">
    <textarea id="global-css-input" rows="6" placeholder="åœ¨è¿™é‡Œç²˜è´´èƒ½ç¾åŒ–æ•´ä¸ªé¡µé¢çš„CSSä»£ç ..."></textarea>
    <button class="settings-btn" id="apply-global-css-btn" style="margin-top: 10px;">åº”ç”¨ç¾åŒ–</button>
    <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button class="settings-btn" id="copy-example-css-btn" style="flex: 1; background-color: #f5f5f5;">å¤åˆ¶ç¤ºä¾‹</button>
        <button class="settings-btn" id="clear-global-css-btn" style="flex: 1; background-color: #f5f5f5;">æ¸…é™¤ç¾åŒ–</button>
    </div>
</div>
        </div>
    </div>
</div>
<!-- // end #theme-settings-page -->
<!-- é¡µé¢9: â€œæŸ¥æ‰‹æœºâ€ä¸»èœå• -->
<div class="app-page" id="check-phone-menu-page">
    <div class="page-header">
        <span class="back-button">â†</span>
        <h2 id="check-phone-menu-title">TAçš„æ‰‹æœº</h2>
    </div>
    <div class="page-content">
        <div class="settings-list" style="margin-top: 0;">
            <div class="settings-item" id="goto-memo-page">
                <span>å¤‡å¿˜å½• ğŸ“</span>
                <span>&gt;</span>
            </div>
            <div class="settings-item" id="goto-diary-page">
    <span>æŸ¥çœ‹æ—¥è®° ğŸ“”</span>
    <span>&gt;</span>
</div>
<div class="settings-item" id="goto-itinerary-page">
    <span>æŸ¥çœ‹è¡Œç¨‹ ğŸ“…</span>
    <span>&gt;</span>
</div>
<div class="settings-item" id="goto-history-page">
    <span>æŸ¥çœ‹æµè§ˆè®°å½• ğŸŒ</span>
    <span>&gt;</span>
</div>
<div class="settings-item" id="goto-cart-page">
    <span>æŸ¥çœ‹è´­ç‰©è½¦ ğŸ›’</span>
    <span>&gt;</span>
</div>
<div class="settings-item" id="goto-dream-page">
    <span>æŸ¥çœ‹æ¢¦å¢ƒ ğŸ˜´</span>
    <span>&gt;</span>
</div>
<div class="settings-item" id="goto-likes-page">
    <span>æŸ¥çœ‹ç‚¹èµæ”¶è— â¤ï¸</span>
    <span>&gt;</span>
</div>
          <div class="settings-item" id="goto-gallery-page">
    <span>æŸ¥çœ‹ç›¸å†Œ ğŸï¸</span>
    <span>&gt;</span>
</div>
        </div>
    </div>
</div>
<!-- // end #check-phone-menu-page -->

<!-- é¡µé¢10: å¤‡å¿˜å½•é¡µé¢ -->
<div class="app-page" id="memo-page">
    <div class="page-header">
        <span class="back-button">â†</span>
        <h2>å¤‡å¿˜å½•</h2>
        <span class="refresh-button">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
</span>
    </div>
    <div class="page-content" id="memo-list-container">
        <!-- AIç”Ÿæˆçš„å¤‡å¿˜å½•ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
        <p class="placeholder-text">æ­£åœ¨ç¿»çœ‹TAçš„å¤‡å¿˜å½•ï¼Œè¯·ç¨å€™...</p>
    </div>
</div>
<!-- // end #memo-page -->

<!-- é¡µé¢12: æ—¥è®°é¡µé¢ -->
<div class="app-page" id="diary-page">
    <div class="page-header">
        <span class="back-button">â†</span>
        <h2>TAçš„æ—¥è®°</h2>
        <span class="refresh-button">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
</span>
    </div>
    <div class="page-content" id="diary-content-container">
        <!-- AIç”Ÿæˆçš„æ—¥è®°ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
        <p class="placeholder-text">æ­£åœ¨å·å·ç¿»å¼€TAçš„æ—¥è®°æœ¬...</p>
    </div>
</div>
<!-- // end #diary-page -->

<!-- é¡µé¢13: è¡Œç¨‹é¡µé¢ -->
<div class="app-page" id="itinerary-page">
    <div class="page-header">
        <span class="back-button">â†</span>
        <h2 id="itinerary-page-title">TAçš„è¡Œç¨‹</h2>
        <span class="refresh-button">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
</span>
    </div>
    <div class="page-content" id="itinerary-list-container">
        <!-- AIç”Ÿæˆçš„è¡Œç¨‹ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
        <p class="placeholder-text">æ­£åœ¨è·å–TAæ˜¨å¤©çš„è¡Œç¨‹è®°å½•...</p>
    </div>
</div>
<!-- // end #itinerary-page -->

<!-- é¡µé¢14: æµè§ˆè®°å½•é¡µé¢ -->
<div class="app-page" id="history-page">
    <div class="page-header">
        <span class="back-button">â†</span>
        <h2>TAçš„æµè§ˆè®°å½•</h2>
        <span class="refresh-button">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
</span>
    </div>
    <div class="page-content" id="history-list-container">
        <!-- AIç”Ÿæˆçš„æµè§ˆè®°å½•ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
        <p class="placeholder-text">æ­£åœ¨ç¿»çœ‹TAçš„æœç´¢å†å²...</p>
    </div>
</div>
<!-- // end #history-page -->

<!-- é¡µé¢15: è´­ç‰©è½¦é¡µé¢ -->
<div class="app-page" id="cart-page">
    <div class="page-header">
        <span class="back-button">â†</span>
        <h2>TAçš„è´­ç‰©è½¦</h2>
        <span class="refresh-button">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
</span>
    </div>
    <div class="page-content" id="cart-list-container">
        <!-- AIç”Ÿæˆçš„è´­ç‰©è½¦å•†å“ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
        <p class="placeholder-text">æ­£åœ¨åŠ è½½TAçš„è´­ç‰©è½¦...</p>
    </div>
</div>
<!-- // end #cart-page -->

<!-- é¡µé¢16: æ¢¦å¢ƒé¡µé¢ -->
<div class="app-page" id="dream-page">
    <div class="page-header">
        <span class="back-button">â†</span>
        <h2>TAçš„æ¢¦å¢ƒè®°å½•</h2>
        <span class="refresh-button">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
</span>
    </div>
    <div class="page-content" id="dream-content-container">
        <!-- AIç”Ÿæˆçš„æ¢¦å¢ƒä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
        <p class="placeholder-text">æ­£åœ¨æ½œå…¥TAçš„æ¢¦å¢ƒ...</p>
    </div>
</div>
<!-- // end #dream-page -->

<!-- é¡µé¢17: ç‚¹èµä¸æ”¶è—é¡µé¢ -->
<div class="app-page" id="likes-page">
    <div class="page-header">
        <span class="back-button">â†</span>
        <h2>TAçš„ç‚¹èµä¸æ”¶è—</h2>
        <span class="refresh-button">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
</span>
    </div>
    <div class="page-content" id="likes-list-container">
        <!-- AIç”Ÿæˆçš„ç‚¹èµæ”¶è—å¸–å­ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
        <p class="placeholder-text">æ­£åœ¨åŠ è½½TAçš„å°çº¢ä¹¦åŠ¨æ€...</p>
    </div>
</div>
<!-- // end #likes-page -->

      <!-- æ–°å¢é¡µé¢ï¼šç›¸å†Œé¡µé¢ -->
<div class="app-page" id="gallery-page">
    <div class="page-header">
        <span class="back-button">â†</span>
        <h2>TAçš„ç›¸å†Œ</h2>
        <span class="refresh-button">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
        </span>
    </div>
    <div class="page-content" id="gallery-container">
        <!-- AIç”Ÿæˆçš„ç›¸å†Œå†…å®¹ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
        <p class="placeholder-text">æ­£åœ¨ç¿»çœ‹TAçš„ç›¸å†Œï¼Œè¯·ç¨å€™...</p>
    </div>
</div>
<!-- // end #gallery-page -->

     <!-- æ–°å¢é¡µé¢ï¼šè½¬è´¦é¡µé¢ -->
<div class="app-page" id="transfer-page">
    <div class="page-header">
        <span class="back-button">â†</span>
        <h2>è½¬è´¦</h2>
    </div>
    <div class="page-content" id="transfer-container">
        <div class="transfer-card">
            <div class="transfer-to-info">
                <span>è½¬è´¦ç»™</span>
                <img id="transfer-avatar" src="" alt="avatar">
                <span id="transfer-name"></span>
            </div>
            <div class="transfer-amount-area">
                <span class="currency-symbol">Â¥</span>
                <input type="number" id="transfer-amount-input" placeholder="0.00" step="0.01">
            </div>
            <div class="transfer-remark-area">
                <input type="text" id="transfer-remark-input" placeholder="æ·»åŠ è½¬è´¦å¤‡æ³¨ (å¯é€‰)">
            </div>
            <button id="confirm-transfer-btn" class="settings-btn" disabled>è½¬è´¦</button>
        </div>
    </div>
</div>
<!-- // end #transfer-page --> 

      <!-- æ–°å¢æµ®çª—ï¼šå¯¹æ–¹å®æ—¶çŠ¶æ€ -->
<div id="status-modal-overlay" class="moments-modal-overlay" style="display: none;">
    <div id="status-modal-content" class="moments-modal-content">
        <!-- AIç”Ÿæˆçš„çŠ¶æ€ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
        <p class="placeholder-text">æ­£åœ¨å·å·è§‚å¯ŸTA...</p>
    </div>
</div>
<!-- // end #status-modal-overlay -->

      <!-- æ–°å¢é¡µé¢ï¼šé€šè®¯äº’åŠ¨é¡µé¢ -->
<div class="app-page" id="interaction-page">
    <div class="page-header">
        <span class="back-button">â†</span>
        <h2>é€šè®¯äº’åŠ¨</h2>
    </div>
    <div class="page-content" id="interaction-area">
        <!-- äº’åŠ¨å†…å®¹ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
    </div>
    <div class="chat-input-area" id="interaction-input-area">
        <textarea id="interaction-input" placeholder="è¾“å…¥ä½ çš„è¯è¯­å’ŒåŠ¨ä½œ..." rows="1"></textarea>
        <button id="send-interaction-btn" class="chat-btn">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
        </button>
    </div>
</div>
<!-- // end #interaction-page -->

<!-- é¡µé¢11: â€œæŸ¥æ‰‹æœºâ€çš„è”ç³»äººé€‰æ‹©åˆ—è¡¨ -->
<div class="app-page" id="check-phone-contact-list-page">
    <div class="page-header">
        <span class="back-button">â†</span>
        <h2>é€‰æ‹©è¦æŸ¥çœ‹çš„æ‰‹æœº</h2>
        <span class="refresh-button">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
</span>
    </div>
    <div class="page-content">
        <div class="settings-list" id="check-phone-contact-list-container" style="margin-top: 0;">
            <!-- è”ç³»äººåˆ—è¡¨ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
        </div>
    </div>
</div>
<!-- // end #check-phone-contact-list-page -->

<!-- é¡µé¢18: æœ‹å‹åœˆä¸»é¡µé¢ -->
<div class="app-page" id="moments-page">
    <div class="page-header" style="background-color: transparent; border-bottom: none;">
        <span class="back-button">â†</span>
        <!-- å³ä¸Šè§’å‘å¸ƒæŒ‰é’® -->
        <div id="create-moment-btn" class="chat-btn" style="position: absolute; right: 15px;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
        </div>
    </div>
    <div class="page-content" style="padding: 0; overflow-y: auto;">
        <!-- é¡¶éƒ¨ä¸ªäººä¿¡æ¯å’ŒèƒŒæ™¯ -->
        <div id="moments-profile-header">
            <div id="moments-bg"></div>
            <img id="moments-my-avatar" src="" alt="My Avatar">
            <!-- èƒŒæ™¯æ§åˆ¶æŒ‰é’® -->
            <div id="moments-bg-controls">
                <button id="toggle-bg-size-btn">åˆ‡æ¢åŠå±</button>
                <button id="change-bg-btn">æ›´æ¢èƒŒæ™¯</button>
                <input type="file" id="moments-bg-input" accept="image/*" style="display: none;">
            </div>
        </div>
        
        <!-- åœˆå­é€‰æ‹©å’Œç®¡ç† -->
        <div id="moments-circle-selector-area">
            <select id="moments-circle-selector">
                <!-- åœˆå­é€‰é¡¹ä¼šåŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
            </select>
            <button id="manage-circles-btn">ç®¡ç†åœˆå­</button>
        </div>

        <!-- åŠ¨æ€å†…å®¹åŒºåŸŸ -->
        <div id="moments-feed-container">
            <!-- æœ‹å‹åœˆåŠ¨æ€å¡ç‰‡ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
            <p class="placeholder-text" style="padding-top: 50px;">è¿˜æ²¡æœ‰ä»»ä½•åŠ¨æ€ï¼Œç‚¹å‡»å³ä¸Šè§’å‘å¸ƒç¬¬ä¸€æ¡å§ï¼</p>
        </div>
        
    </div>
</div>
<!-- // end #moments-page -->

<!-- å¼¹çª—ï¼šå‘å¸ƒæœ‹å‹åœˆ -->
<div id="post-moment-modal" class="moments-modal-overlay" style="display: none;">
    <div class="moments-modal-content">
        <h3>å‘å¸ƒæœ‹å‹åœˆ</h3>
        <textarea id="moment-text-input" placeholder="è¿™ä¸€åˆ»çš„æƒ³æ³•..." rows="5"></textarea>
        <input type="text" id="moment-image-desc-input" placeholder="è¾“å…¥å›¾ç‰‡æè¿° (é€‰å¡«)">
        <label for="post-to-circle-selector">å‘å¸ƒåˆ°åœˆå­:</label>
        <select id="post-to-circle-selector"></select>
        <div class="moments-modal-actions">
            <button id="cancel-post-moment-btn" class="settings-btn" style="background-color: #f5f5f5;">å–æ¶ˆ</button>
            <button id="confirm-post-moment-btn" class="settings-btn">å‘å¸ƒ</button>
        </div>
    </div>
</div>

<!-- å¼¹çª—ï¼šç®¡ç†åœˆå­ -->
<div id="circle-management-modal" class="moments-modal-overlay" style="display: none;">
    <div class="moments-modal-content">
        <h3>ç®¡ç†åœˆå­</h3>
        <div id="existing-circles-list">
            <!-- å·²æœ‰åœˆå­åˆ—è¡¨ -->
        </div>
        <hr class="divider">
        <h4>åˆ›å»ºæ–°åœˆå­</h4>
        <input type="text" id="new-circle-name-input" placeholder="ç»™åœˆå­èµ·ä¸ªåå­—">
        <div id="circle-contacts-list">
            <!-- å¯é€‰è”ç³»äººåˆ—è¡¨ -->
        </div>
        <div class="moments-modal-actions">
            <button id="cancel-manage-circles-btn" class="settings-btn" style="background-color: #f5f5f5;">å…³é—­</button>
            <button id="save-new-circle-btn" class="settings-btn">ä¿å­˜æ–°åœˆå­</button>
        </div>
    </div>
</div>
        
    </div>
    <!-- // end #phone-screen -->

    

    <script>
    document.addEventListener('DOMContentLoaded', function() {
    // --- æ–°å¢ï¼šä¸€ä¸ªå¼ºå¤§ä¸”å¿…é¡»çš„å›¾ç‰‡å‹ç¼©å·¥å…· ---
function compressImage(base64Str, maxWidth = 100, maxHeight = 100) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.src = base64Str;
        img.onload = () => {
            let canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            let width = img.width;
            let height = img.height;

            if (width > height) {
                if (width > maxWidth) {
                    height *= maxWidth / width;
                    width = maxWidth;
                }
            } else {
                if (height > maxHeight) {
                    width *= maxHeight / height;
                    height = maxHeight;
                }
            }
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);
            resolve(canvas.toDataURL('image/jpeg', 0.8)); // å‹ç¼©ä¸ºjpegæ ¼å¼ï¼Œè´¨é‡80%
        };
        img.onerror = (error) => {
            reject(error);
        };
    });
}
    // --- æ–°å¢ï¼šä¸€ä¸ªä¼šâ€œæš‚åœâ€çš„é­”æ³•å°å·¥å…· ---
function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

        // --- åŠŸèƒ½1ï¼šæ›´æ–°å·¦ä¸Šè§’çš„æ—¶é—´ ---
        const timeDisplay = document.getElementById('time-display');
        function updateTime() {
            const now = new Date();
            let hours = String(now.getHours()).padStart(2, '0');
            let minutes = String(now.getMinutes()).padStart(2, '0');
            timeDisplay.textContent = `${hours}:${minutes}`;
        }
        setInterval(updateTime, 1000);
        updateTime();
        
        // --- åŠŸèƒ½2ï¼šæ›´æ–°å³ä¸Šè§’çš„ç”µæ± çŠ¶æ€ ---
        if (navigator.getBattery) {
            const batteryLevel = document.getElementById('battery-level');
            navigator.getBattery().then(function(battery) {
                function updateBatteryStatus() {
                    batteryLevel.style.width = (battery.level * 100) + '%';
                    if (battery.charging) {
                        batteryLevel.style.backgroundColor = '#60d26f';
                    } else {
                        batteryLevel.style.backgroundColor = 'grey';
                    }
                }
                updateBatteryStatus();
                battery.addEventListener('levelchange', updateBatteryStatus);
                battery.addEventListener('chargingchange', updateBatteryStatus);
            });
        }

        // --- åŠŸèƒ½3ï¼šè®¾ç½®å¤´åƒå’ŒèƒŒæ™¯å›¾ ---
        const avatarImg = document.getElementById('avatar-img');
        
        const avatarInput = document.getElementById('avatar-input');
        

        avatarImg.addEventListener('click', function() { avatarInput.click(); });
        

        avatarInput.addEventListener('change', async function(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async function(e) {
        try {
            // æ ¸å¿ƒå‡çº§ï¼šå…ˆå‹ç¼©å›¾ç‰‡ï¼Œå†è¿›è¡Œåç»­æ“ä½œ
            const compressedBase64 = await compressImage(e.target.result, 100, 100); // å‹ç¼©æˆ100x100

            // 1. åº”ç”¨åˆ°ä¸»å±å¹•
            avatarImg.src = compressedBase64;
            // 2. ä¿å­˜åˆ°â€œé•¿æœŸè®°å¿†â€
            localStorage.setItem('mainAvatarImage', compressedBase64);
            // 3. ã€å…³é”®ã€‘ç«‹åˆ»åŒæ­¥åˆ°â€œä¸»é¢˜ç¾åŒ–â€é¡µé¢çš„é¢„è§ˆçª—å£
            previewAvatarImg.src = compressedBase64;

        } catch (error) {
            console.error("Avatar compression failed:", error);
            alert("å¤´åƒå¤„ç†å¤±è´¥ï¼Œè¯·æ¢å¼ å›¾ç‰‡è¯•è¯•ã€‚");
        }
    };
    reader.readAsDataURL(file);
});

        
        // --- åŠŸèƒ½4ï¼šåº”ç”¨é¡µé¢å¯¼èˆª ---
        const mainContent = document.getElementById('main-content');
        const appPages = document.querySelectorAll('.app-page');
        const settingsIcon = document.getElementById('app-settings-icon');
        const chatIcon = document.getElementById('app-chat-icon');
        const apiSettingsPage = document.getElementById('api-settings-page');
        const chatListPage = document.getElementById('chat-list-page');
        const addContactPage = document.getElementById('add-contact-page');
        const backButtons = document.querySelectorAll('.back-button');
        const addButton = document.querySelector('.add-button');

        let pageHistory = []; // æ–°å¢ä¸€ä¸ªé¡µé¢å†å²è®°å½•æ ˆ
      
      // --- å‡çº§ï¼šåˆ›å»ºä¸€ä¸ªç»Ÿä¸€çš„ã€æ™ºèƒ½çš„è¿”å›å‡½æ•° ---
function goBack() {
    // ä»å†å²è®°å½•ä¸­ç§»é™¤å½“å‰é¡µé¢
    pageHistory.pop();
    if (pageHistory.length > 0) {
        // æ˜¾ç¤ºä¸Šä¸€ä¸ªé¡µé¢
        const previousPage = pageHistory[pageHistory.length - 1];
        // å†æ¬¡éšè—æ‰€æœ‰é¡µé¢ï¼Œç„¶åæ˜¾ç¤ºä¸Šä¸€ä¸ª
        appPages.forEach(p => p.style.display = 'none');
        previousPage.style.display = 'flex';
    } else {
        // å¦‚æœå†å²è®°å½•ä¸ºç©ºï¼Œåˆ™è¿”å›ä¸»å±å¹•
        goHome();
    }
}

function showPage(pageToShow) {
    // éšè—æ‰€æœ‰é¡µé¢å’Œä¸»å±å¹•
    mainContent.style.display = 'none';
    appPages.forEach(p => p.style.display = 'none');
    
    // æ˜¾ç¤ºç›®æ ‡é¡µé¢
    pageToShow.style.display = 'flex';
    
    // æ›´æ–°å†å²è®°å½•
    if (pageHistory[pageHistory.length - 1] !== pageToShow) {
        pageHistory.push(pageToShow);
    }
}

        function goHome() {
            appPages.forEach(page => page.style.display = 'none');
            mainContent.style.display = 'flex';
        }

        settingsIcon.addEventListener('click', () => showPage(apiSettingsPage));
        chatIcon.addEventListener('click', () => showPage(chatListPage));
        const themeIcon = document.getElementById('app-theme-icon');
themeIcon.addEventListener('click', () => showPage(themeSettingsPage));
        addButton.addEventListener('click', () => showPage(addContactPage));

        backButtons.forEach(button => {
            button.addEventListener('click', goBack); // æ‰€æœ‰è¿”å›æŒ‰é’®ç°åœ¨éƒ½è°ƒç”¨æˆ‘ä»¬èªæ˜çš„è¿”å›å‡½æ•°
        });


        // --- åŠŸèƒ½5ï¼šAPI è®¾ç½®é¡µé¢çš„äº¤äº’é€»è¾‘ ---
        const apiBaseInput = document.getElementById('api-base-input');
        const apiKeyInput = document.getElementById('api-key-input');
        const fetchModelsBtn = document.getElementById('fetch-models-btn');
        const modelListContainer = document.getElementById('model-list-container');
        const saveSettingsBtn = document.getElementById('save-settings-btn');

        fetchModelsBtn.addEventListener('click', async function() {
            const baseUrl = apiBaseInput.value.trim();
            const apiKey = apiKeyInput.value.trim();
            if (!baseUrl || !apiKey) {
                alert('è¯·å¡«å†™ API Base URL å’Œ API Keyï¼');
                return;
            }
            fetchModelsBtn.textContent = 'æ­£åœ¨æ‹‰å–...';
            fetchModelsBtn.disabled = true;
            modelListContainer.innerHTML = '<p class="placeholder-text">è¯·ç¨å€™...</p>';
            try {
                const response = await fetch(`${baseUrl}/models`, { headers: { 'Authorization': `Bearer ${apiKey}` } });
                if (!response.ok) throw new Error(`æœåŠ¡å™¨é”™è¯¯: ${response.status}`);
                const data = await response.json();
                const models = data.data;
                if (!models || models.length === 0) {
                    modelListContainer.innerHTML = '<p class="placeholder-text">æœªèƒ½æ‰¾åˆ°ä»»ä½•å¯ç”¨æ¨¡å‹ã€‚</p>';
                } else {
                    modelListContainer.innerHTML = '';
                    models.forEach(model => {
                        const modelId = model.id;
                        const modelItemHTML = `
                            <div class="model-item">
                                <input type="radio" id="model-${modelId}" name="model-selection" value="${modelId}">
                                <label for="model-${modelId}">${modelId}</label>
                            </div>`;
                        modelListContainer.insertAdjacentHTML('beforeend', modelItemHTML);
                    });
                }
            } catch (error) {
                console.error('æ‹‰å–æ¨¡å‹å¤±è´¥:', error);
                modelListContainer.innerHTML = `<p class="placeholder-text" style="color: red;">æ‹‰å–å¤±è´¥ï¼<br>è¯·æ£€æŸ¥URLã€API Keyå’Œç½‘ç»œè¿æ¥ã€‚</p>`;
            } finally {
                fetchModelsBtn.textContent = 'æ‹‰å–æ¨¡å‹';
                fetchModelsBtn.disabled = false;
            }
        });

        saveSettingsBtn.addEventListener('click', function() {
            const baseUrl = apiBaseInput.value.trim();
            const apiKey = apiKeyInput.value.trim();
            const selectedModelInput = document.querySelector('input[name="model-selection"]:checked');
            if (!baseUrl || !apiKey) {
                alert('è¯·ç¡®ä¿ API Base URL å’Œ API Key éƒ½å·²å¡«å†™ï¼');
                return;
            }
            if (!selectedModelInput) {
                alert('è¯·å…ˆæ‹‰å–å¹¶é€‰æ‹©ä¸€ä¸ªæ¨¡å‹ï¼');
                return;
            }
            const selectedModel = selectedModelInput.value;
            const settingsToSave = { baseUrl, apiKey, model: selectedModel };
            localStorage.setItem('apiSettings', JSON.stringify(settingsToSave));
            alert(`è®¾ç½®å·²ä¿å­˜ï¼\nå½“å‰æ¨¡å‹: ${selectedModel}`);
        });

        // --- åŠŸèƒ½7ï¼šè”ç³»äººç®¡ç† (å·²å‡çº§ï¼Œæ”¯æŒå›¾ç‰‡å‹ç¼©) ---
        const addContactBtn = document.getElementById('add-contact-btn');
        const contactAvatarPicker = document.querySelector('.contact-avatar-picker');
        const contactAvatarInput = document.getElementById('contact-avatar-input');
        const contactAvatarPreview = document.getElementById('contact-avatar-preview');
        const contactNameInput = document.getElementById('contact-name-input');
        const contactPersonaInput = document.getElementById('contact-persona-input');
        const contactStyleInput = document.getElementById('contact-style-input');
        const contactAvatarPickerText = contactAvatarPicker.querySelector('span');
        const chatListContainer = document.getElementById('chat-list-container');
        const noChatsPlaceholder = document.getElementById('no-chats-placeholder');

        

        contactAvatarPicker.addEventListener('click', function() {
            contactAvatarInput.click();
        });
        
        contactAvatarInput.addEventListener('change', async function(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async function(e) {
        try {
            // è°ƒç”¨æˆ‘ä»¬ä¹‹å‰æ·»åŠ çš„å‹ç¼©å·¥å…·
            const compressedBase64 = await compressImage(e.target.result, 100, 100);
            // æ›´æ–°è”ç³»äººå¤´åƒçš„é¢„è§ˆ
            contactAvatarPreview.src = compressedBase64;
        } catch (error) {
            console.error("Contact avatar compression failed:", error);
            alert("è”ç³»äººå¤´åƒå¤„ç†å¤±è´¥ï¼Œè¯·æ¢å¼ å›¾ç‰‡è¯•è¯•ã€‚");
        }
    };
    reader.readAsDataURL(file);
});

        avatarInput.addEventListener('change', function(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        const originalBase64 = e.target.result;

        // 1. åº”ç”¨åˆ°ä¸»å±å¹•
        avatarImg.src = originalBase64;
        // 2. ä¿å­˜åˆ°â€œé•¿æœŸè®°å¿†â€
        localStorage.setItem('mainAvatarImage', originalBase64);
        // 3. ã€å…³é”®ã€‘ç«‹åˆ»åŒæ­¥åˆ°â€œä¸»é¢˜ç¾åŒ–â€é¡µé¢çš„é¢„è§ˆçª—å£
        previewAvatarImg.src = originalBase64;
    };
    reader.readAsDataURL(file);
});

        addContactBtn.addEventListener('click', function() {
            const name = contactNameInput.value.trim();
            if (!name) {
                alert('è‡³å°‘è¦ç»™è”ç³»äººèµ·ä¸ªåå­—å“¦ï¼');
                return;
            }
            let contacts = JSON.parse(localStorage.getItem('contacts')) || [];
            
            if (isEditingContact) {
                // ç¼–è¾‘æ¨¡å¼
                let contact = contacts.find(c => c.id === currentChatContactId);
                contact.name = name;
                contact.avatar = contactAvatarPreview.src;
                contact.gender = document.querySelector('input[name="gender"]:checked').value;
                contact.persona = contactPersonaInput.value.trim();
                contact.style = contactStyleInput.value.trim();
                alert(`â€œ${name}â€ çš„ä¿¡æ¯å·²æ›´æ–°ï¼`);
            } else {
                // æ–°å¢æ¨¡å¼
                const newContact = {
                    id: 'contact_' + Date.now(),
                    name: name,
                    avatar: contactAvatarPreview.src,
                    gender: document.querySelector('input[name="gender"]:checked').value,
                    persona: contactPersonaInput.value.trim(),
                    style: contactStyleInput.value.trim(),
                    messages: []
                };
                contacts.push(newContact);
                alert(`â€œ${name}â€ å·²æˆåŠŸæ·»åŠ ï¼`);
            }
            
            localStorage.setItem('contacts', JSON.stringify(contacts));
            resetContactForm();
            renderChatList();
            
            // --- æ ¸å¿ƒä¿®å¤åœ¨è¿™é‡Œ ---
            // æ— è®ºæ˜¯æ–°å¢è¿˜æ˜¯ç¼–è¾‘ï¼Œå®Œæˆåéƒ½è°ƒç”¨ goBack() æ¥æ­£ç¡®åœ°è¿”å›
            if (isEditingContact) {
                isEditingContact = false; 
                document.getElementById('add-contact-page').querySelector('h2').textContent = 'æ·»åŠ è”ç³»äºº';
                addContactBtn.textContent = 'ç¡®è®¤æ·»åŠ ';
            }
            goBack(); // ä½¿ç”¨æˆ‘ä»¬èªæ˜çš„è¿”å›å‡½æ•°ï¼
        });

        function resetContactForm() {
            contactNameInput.value = '';
            contactPersonaInput.value = '';
            contactStyleInput.value = '';
            contactAvatarPreview.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23e0e0e0'/%3E%3C/svg%3E";
            document.getElementById('gender-male').checked = true;
        }

        function renderChatList() {
            const contacts = JSON.parse(localStorage.getItem('contacts')) || [];
            const placeholder = `<p id="no-chats-placeholder">è¿˜æ²¡æœ‰è”ç³»äººï¼Œç‚¹å‡»å³ä¸Šè§’çš„ '+' æ·»åŠ ä¸€ä¸ªå§ï¼</p>`;
            chatListContainer.innerHTML = contacts.length === 0 ? placeholder : '';
            if (contacts.length > 0) {
                contacts.forEach(contact => {
                    const lastMessage = contact.messages.length > 0 ? contact.messages[contact.messages.length - 1].content : "å¼€å§‹èŠå¤©å§...";
                    const chatItemHTML = `
                        <div class="chat-list-item" data-contact-id="${contact.id}">
                            <img class="chat-avatar" src="${contact.avatar}" alt="avatar">
                            <div class="chat-info">
                                <div class="chat-name">${contact.name}</div>
                                <div class="chat-last-message">${lastMessage}</div>
                            </div>
                        </div>`;
                    chatListContainer.insertAdjacentHTML('beforeend', chatItemHTML);
                });
            }
        }

        // --- åŠŸèƒ½8ï¼šèŠå¤©å®¤æ ¸å¿ƒé€»è¾‘ ---
        const chatRoomPage = document.getElementById('chat-room-page');
        const chatRoomTitle = document.getElementById('chat-room-title');
        const chatArea = document.getElementById('chat-area');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const receiveBtn = document.getElementById('receive-btn');
        const chatMenuBtn = document.getElementById('chat-menu-btn');
const chatSettingsMenuPage = document.getElementById('chat-settings-menu-page');
const chatSpecificSettingsPage = document.getElementById('chat-specific-settings-page');
const myInfoForChatPage = document.getElementById('my-info-for-chat-page');
const themeSettingsPage = document.getElementById('theme-settings-page');
const checkPhoneMenuPage = document.getElementById('check-phone-menu-page');
const memoPage = document.getElementById('memo-page');
const appCheckPhoneIcon = document.getElementById('app-check-phone-icon');
const checkPhoneContactListPage = document.getElementById('check-phone-contact-list-page');
const diaryPage = document.getElementById('diary-page');
const diaryContentContainer = document.getElementById('diary-content-container');
const bubbleSettingsPage = document.getElementById('bubble-settings-page');
const itineraryPage = document.getElementById('itinerary-page');
const itineraryListContainer = document.getElementById('itinerary-list-container');
const historyPage = document.getElementById('history-page');
const historyListContainer = document.getElementById('history-list-container');
const cartPage = document.getElementById('cart-page');
const cartListContainer = document.getElementById('cart-list-container');
const dreamPage = document.getElementById('dream-page');
const dreamContentContainer = document.getElementById('dream-content-container');
// æ–°å¢çš„ç‚¹èµæ”¶è—é¡µé¢
const likesPage = document.getElementById('likes-page');

      // --- æ–°å¢ï¼šé€šè®¯äº’åŠ¨åŠŸèƒ½ç›¸å…³å…ƒç´  ---
const actionInteractionBtn = document.getElementById('action-interaction-btn');
const interactionPage = document.getElementById('interaction-page');
const interactionArea = document.getElementById('interaction-area');
const interactionInput = document.getElementById('interaction-input');
const sendInteractionBtn = document.getElementById('send-interaction-btn');
let interactionHistory = []; // ç”¨äºå­˜å‚¨äº’åŠ¨å†å²

      // --- æ–°å¢ï¼šå¯¹æ–¹çŠ¶æ€åŠŸèƒ½ç›¸å…³å…ƒç´  ---
const actionStatusBtn = document.getElementById('action-status-btn');
const statusModalOverlay = document.getElementById('status-modal-overlay');
const statusModalContent = document.getElementById('status-modal-content');

// --- æ–°å¢ï¼šè½¬è´¦åŠŸèƒ½ç›¸å…³å…ƒç´  ---
const transferPage = document.getElementById('transfer-page');
const actionTransferBtn = document.getElementById('action-transfer-btn');
const transferAvatar = document.getElementById('transfer-avatar');
const transferName = document.getElementById('transfer-name');
const transferAmountInput = document.getElementById('transfer-amount-input');
const transferRemarkInput = document.getElementById('transfer-remark-input');
const confirmTransferBtn = document.getElementById('confirm-transfer-btn');
      
      // --- æ–°å¢ï¼šç›¸å†ŒåŠŸèƒ½ç›¸å…³å…ƒç´  ---
const galleryPage = document.getElementById('gallery-page');
const galleryContainer = document.getElementById('gallery-container');
const likesListContainer = document.getElementById('likes-list-container');
// æ–°å¢çš„å…¨å±€CSSåŠŸèƒ½ç›¸å…³æŒ‰é’®
const globalCssInput = document.getElementById('global-css-input');
const applyGlobalCssBtn = document.getElementById('apply-global-css-btn');
const copyExampleCssBtn = document.getElementById('copy-example-css-btn');
const clearGlobalCssBtn = document.getElementById('clear-global-css-btn');

        let currentChatContactId = null;
        
        let currentlyDisplayedCount = 25; // è§„åˆ™å‡çº§ï¼šé»˜è®¤æ˜¾ç¤º25æ¡

        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        // --- å‡çº§ v2.0ï¼šèŠå¤©åˆ—è¡¨äº¤äº’ï¼Œå¢åŠ é•¿æŒ‰åˆ é™¤åŠŸèƒ½ (å·²ä¿®å¤æ‰‹æœºç«¯è§¦æ‘¸æŠ–åŠ¨é—®é¢˜) ---
let longPressTimer;
let isLongPressing = false;
let touchStartX = 0;
let touchStartY = 0;

function handlePressStart(event) {
    const targetItem = event.target.closest('.chat-list-item');
    if (!targetItem) return;

    // è®°å½•åˆå§‹è§¦æ‘¸ä½ç½®
    if (event.type === 'touchstart') {
        touchStartX = event.touches[0].clientX;
        touchStartY = event.touches[0].clientY;
    }

    isLongPressing = false;
    longPressTimer = setTimeout(() => {
        // é˜»æ­¢é»˜è®¤çš„ä¸Šä¸‹æ–‡èœå•ï¼ˆå°¤å…¶åœ¨ç”µè„‘ä¸Šï¼‰
        event.preventDefault();
        isLongPressing = true;
        const contactId = targetItem.dataset.contactId;
        let contacts = JSON.parse(localStorage.getItem('contacts')) || [];
        const contact = contacts.find(c => c.id === contactId);
        if (contact) {
            if (confirm(`çœŸçš„è¦åˆ é™¤è”ç³»äºº "${contact.name}" å’Œä»–/å¥¹çš„ä¸€åˆ‡æ•°æ®å—ï¼Ÿ\nè¿™ä¸ªæ“ä½œæ— æ³•æ’¤é”€ï¼`)) {
                contacts = contacts.filter(c => c.id !== contactId);
                localStorage.setItem('contacts', JSON.stringify(contacts));
                renderChatList();
            }
        }
    }, 700);
}

// æ–°å¢ä¸€ä¸ªä¸“é—¨å¤„ç†æ‰‹æŒ‡ç§»åŠ¨çš„å‡½æ•°
function handlePressMove(event) {
    if (!longPressTimer) return; // å¦‚æœè®¡æ—¶å™¨ä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›

    const touchX = event.touches[0].clientX;
    const touchY = event.touches[0].clientY;

    // è®¡ç®—æ‰‹æŒ‡ç§»åŠ¨çš„è·ç¦»
    const deltaX = Math.abs(touchX - touchStartX);
    const deltaY = Math.abs(touchY - touchStartY);

    // å¦‚æœç§»åŠ¨è·ç¦»è¶…è¿‡10åƒç´ ï¼Œå°±åˆ¤æ–­ä¸ºæ»‘åŠ¨ï¼Œå–æ¶ˆé•¿æŒ‰
    if (deltaX > 10 || deltaY > 10) {
        clearTimeout(longPressTimer);
    }
}

function handlePressEnd() {
    clearTimeout(longPressTimer);
}

// ç»‘å®šäº‹ä»¶
chatListContainer.addEventListener('mousedown', handlePressStart);
chatListContainer.addEventListener('mouseup', handlePressEnd);
chatListContainer.addEventListener('mouseleave', handlePressEnd);

// ä¸ºè§¦æ‘¸äº‹ä»¶ä½¿ç”¨æ–°çš„é€»è¾‘
chatListContainer.addEventListener('touchstart', handlePressStart);
chatListContainer.addEventListener('touchend', handlePressEnd);
chatListContainer.addEventListener('touchmove', handlePressMove); // å…³é”®ï¼šç§»åŠ¨æ—¶è°ƒç”¨æ–°çš„å¤„ç†å‡½æ•°

// å•å‡»äº‹ä»¶é€»è¾‘ä¿æŒä¸å˜
chatListContainer.addEventListener('click', function(event) {
    if (isLongPressing) {
        event.preventDefault();
        return;
    }
    const clickedItem = event.target.closest('.chat-list-item');
    if (clickedItem) {
        const contactId = clickedItem.dataset.contactId;
        openChatRoom(contactId);
    }
});

        function openChatRoom(contactId) {
            currentChatContactId = contactId;
            currentlyDisplayedCount = 20; // æ ¸å¿ƒï¼šæ¯æ¬¡æ‰“å¼€éƒ½é‡ç½®ä¸º20æ¡
            const contacts = JSON.parse(localStorage.getItem('contacts')) || [];
            const contact = contacts.find(c => c.id === contactId);
            if (contact) {
                chatRoomTitle.textContent = `ä¸ ${contact.name} èŠå¤©ä¸­`;
                
                // --- è¿™é‡Œæ˜¯ä¿®å¤çš„å…³é”® ---
                // æˆ‘ä»¬è·å–èŠå¤©åŒºåŸŸçš„å…ƒç´ ï¼Œç„¶åæ£€æŸ¥è¿™ä½è”ç³»äººæ˜¯å¦ä¿å­˜äº†èƒŒæ™¯å›¾
                const chatArea = document.getElementById('chat-area');
                if (contact.settings?.background) {
                    // å¦‚æœæœ‰ï¼Œå°±åº”ç”¨èƒŒæ™¯å›¾
                    chatArea.style.backgroundImage = `url('${contact.settings.background}')`;
                    chatArea.style.backgroundSize = 'cover';
                    chatArea.style.backgroundPosition = 'center';
                } else {
                    // å¦‚æœæ²¡æœ‰ï¼Œå°±ç¡®ä¿èƒŒæ™¯æ˜¯ç©ºçš„
                    chatArea.style.backgroundImage = 'none';
                }
                // --- ä¿®å¤ç»“æŸ ---

                renderMessages(contactId);
                // åº”ç”¨è‡ªå®šä¹‰æ°”æ³¡æ ·å¼
                applyBubbleSettings(contact.settings?.bubble || defaultBubbleSettings);
                chatArea.scrollTop = chatArea.scrollHeight; // æ‰“å¼€æ—¶è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                showPage(chatRoomPage);
            }
        }

        function renderMessages(contactId) {
    const contacts = JSON.parse(localStorage.getItem('contacts')) || [];
    const contact = contacts.find(c => c.id === contactId);
    if (!contact) return;

    const wasScrolledToBottom = chatArea.scrollTop + chatArea.clientHeight >= chatArea.scrollHeight - 10;
    const oldScrollHeight = chatArea.scrollHeight;

    let messagesHTML = ''; // å‡†å¤‡ä¸€ä¸ªç©ºç”»æ¿

    // 1. ã€æ ¸å¿ƒé€»è¾‘ã€‘å…ˆæ£€æŸ¥æ˜¯å¦éœ€è¦â€œåŠ è½½æ›´å¤šâ€æŒ‰é’®
    if (contact.messages.length > currentlyDisplayedCount) {
        messagesHTML += `
            <div id="load-more-container" style="text-align: center; padding: 10px;">
                <button id="load-more-btn" class="settings-btn" style="padding: 5px 15px; font-size: 12px; background-color: #f5f5f5;">åŠ è½½æ›´æ—©çš„è®°å½•</button>
            </div>
        `;
    }

    // 2. å‡†å¤‡è¦ç”»å‡ºæ¥çš„æ¶ˆæ¯
    const messagesToRender = contact.messages.slice(-currentlyDisplayedCount);
     const myName = "æˆ‘"; // æˆ–è€…æ‚¨å¯ä»¥ä¹‹åæŠŠå®ƒåšæˆå¯è®¾ç½®çš„     
    const myAvatar = contact.myInfo?.avatar || "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='8' fill='%23d0d0d0'/%3E%3C/svg%3E";

    // 3. æŠŠæ¯æ¡æ¶ˆæ¯ç”»åˆ°ç”»æ¿ä¸Š
    messagesToRender.forEach(msg => {
        const messageTime = new Date(msg.timestamp).toLocaleTimeString('zh-CN', { hour12: false });
        const isSent = msg.role === 'user';
        const avatarToShow = isSent ? myAvatar : contact.avatar;

        let bubbleHTML = '';
        if (msg.type === 'voice') {
            bubbleHTML = `<div class="message-bubble voice" style="width: auto; min-width: 80px; max-width: 200px; flex-direction: column; align-items: flex-start;"><div class="voice-bar-top"><svg class="voice-icon" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg><span class="voice-duration">${msg.duration}s</span></div><div class="voice-transcript">${msg.content}</div></div>`;
        } else if (msg.type === 'image') {
            bubbleHTML = `<div class="message-bubble image"><svg class="image-icon" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg><div class="image-description">${msg.content}</div></div>`;
        } else if (msg.type === 'transfer') {
            const headerText = msg.remark || (isSent ? 'è½¬è´¦' : 'æ”¶åˆ°è½¬è´¦');
            bubbleHTML = `
                <div class="message-bubble transfer">
                    <div class="transfer-card-wrapper ${isSent ? 'sent' : 'received'}">
                        <div class="transfer-message-card">
                            <div class="transfer-header">
                                <svg viewBox="0 0 24 24"><path d="M16.5 12c-1.38 0-2.5 1.12-2.5 2.5s1.12 2.5 2.5 2.5 2.5-1.12 2.5-2.5-1.12-2.5-2.5-2.5zM9 12c-1.38 0-2.5 1.12-2.5 2.5s1.12 2.5 2.5 2.5 2.5-1.12 2.5-2.5-1.12-2.5-2.5-2.5zm7.5 5.5H9c-1.38 0-2.5 1.12-2.5 2.5s1.12 2.5 2.5 2.5h7.5c1.38 0 2.5-1.12 2.5-2.5s-1.12-2.5-2.5-2.5zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"></path></svg>
                                <span>${headerText}</span>
                            </div>
                            <div class="transfer-body">
                                ${msg.amount}
                            </div>
                        </div>
                    </div>
                </div>`;
        } else if (msg.type === 'system') {
            bubbleHTML = `<div class="message-bubble system"><div class="system-message-text">${msg.content}</div></div>`;
        } else { // é»˜è®¤æ–‡æœ¬æ¶ˆæ¯
            bubbleHTML = `<div class="message-bubble">${msg.content}</div>`;
        }

        messagesHTML += `<div class="chat-message ${isSent ? 'sent' : 'received'}" data-timestamp="${msg.timestamp}"><div class="avatar-and-time"><img class="message-avatar" src="${avatarToShow}" alt="avatar"><div class="message-time">${messageTime}</div></div><div class="message-content">${bubbleHTML}</div></div>`;
    });

    // 4. æŠŠç”»å¥½çš„æ‰€æœ‰å†…å®¹ï¼Œä¸€æ¬¡æ€§æ”¾åˆ°èŠå¤©åŒºåŸŸ
    chatArea.innerHTML = messagesHTML;

    // 5. æ™ºèƒ½åœ°å¤„ç†æ»šåŠ¨æ¡
    if (wasScrolledToBottom) {
        chatArea.scrollTop = chatArea.scrollHeight;
    } else if (currentlyDisplayedCount > 25) { // æ³¨æ„ï¼šè¿™é‡Œçš„æ•°å­—ä¹Ÿè¦å’Œæ–°è§„åˆ™ä¿æŒä¸€è‡´
         chatArea.scrollTop = chatArea.scrollHeight - oldScrollHeight;
    }
}

// --- æ–°å¢ï¼šåŠ è½½æ›´å¤šæ¶ˆæ¯çš„æŒ‰é’®é€»è¾‘ ---
chatArea.addEventListener('click', function(event) {
    // æ£€æŸ¥è¢«ç‚¹å‡»çš„æ˜¯ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„é‚£ä¸ªæŒ‰é’®
    if (event.target && event.target.id === 'load-more-btn') {
        currentlyDisplayedCount += 25; // è§„åˆ™å‡çº§ï¼šæ¯æ¬¡å¤šåŠ è½½25æ¡
        renderMessages(currentChatContactId);
    }
});

// --- åŠŸèƒ½11ï¼šé™„åŠ åŠŸèƒ½å¼¹çª—ä¸å¤šæ¨¡æ€æ¶ˆæ¯ (è¯­éŸ³ã€å›¾ç‰‡) ---
const inputModeBtn = document.getElementById('input-mode-btn');
const sendVoiceBtn = document.getElementById('send-voice-btn');
const actionPopupOverlay = document.getElementById('action-popup-overlay');
const actionPopup = document.getElementById('action-popup');
const actionVoiceBtn = document.getElementById('action-voice-btn');
const actionImageBtn = document.getElementById('action-image-btn');
let isVoiceMode = false;

// â€œ+â€ æŒ‰é’®ç°åœ¨åªè´Ÿè´£æ‰“å¼€å¼¹çª—
inputModeBtn.addEventListener('click', function() {
    actionPopupOverlay.style.display = 'flex';
    // å»¶è¿Ÿä¸€å°ä¸‹å†åŠ åŠ¨ç”»ï¼Œç¡®ä¿displayç”Ÿæ•ˆ
    setTimeout(() => {
        actionPopup.style.transform = 'translateY(0)';
    }, 10);
});

// ç‚¹å‡»ç°è‰²è’™å±‚å¯ä»¥å…³é—­å¼¹çª—
actionPopupOverlay.addEventListener('click', function(e) {
    if (e.target === actionPopupOverlay) {
        actionPopup.style.transform = 'translateY(100%)';
        setTimeout(() => {
            actionPopupOverlay.style.display = 'none';
        }, 300); // ç­‰åŠ¨ç”»æ’­å®Œå†éšè—
    }
});

// å¼¹çª—é‡Œçš„â€œå‘é€è¯­éŸ³â€æŒ‰é’®
actionVoiceBtn.addEventListener('click', function() {
    isVoiceMode = true;
    // åˆ‡æ¢UIåˆ°è¯­éŸ³æ¨¡å¼
    messageInput.placeholder = 'è¾“å…¥æ–‡å­—ï¼Œæ¨¡æ‹Ÿæˆè¯­éŸ³æ¶ˆæ¯...';
    sendBtn.style.display = 'none';
    sendVoiceBtn.style.display = 'flex';
    // å…³é—­å¼¹çª—
    actionPopupOverlay.click();
});

// å¼¹çª—é‡Œçš„â€œå‘é€å›¾ç‰‡â€æŒ‰é’®
actionImageBtn.addEventListener('click', function() {
    const description = prompt('è¯·è¾“å…¥ä½ æƒ³å‘é€çš„å›¾ç‰‡æè¿°ï¼š');
    if (description && description.trim() !== '') {
        const message = { 
            role: 'user', 
            type: 'image', // æ ‡è®°ä¸ºå›¾ç‰‡æ¶ˆæ¯
            content: description.trim(), 
            timestamp: Date.now() 
        };
        let contacts = JSON.parse(localStorage.getItem('contacts'));
        let contact = contacts.find(c => c.id === currentChatContactId);
        contact.messages.push(message);
        localStorage.setItem('contacts', JSON.stringify(contacts));
        renderMessages(currentChatContactId);
    }
    // å…³é—­å¼¹çª—
    actionPopupOverlay.click();
});

// â€œå‘é€è¯­éŸ³â€æŒ‰é’®çš„é€»è¾‘ (å·²ä¿®å¤)
sendVoiceBtn.addEventListener('click', function() {
    const text = messageInput.value.trim();
    if (text === '' || !currentChatContactId) return;

    const duration = Math.max(1, Math.round(text.length / 5));
    const message = { role: 'user', type: 'voice', content: text, duration: duration, timestamp: Date.now() };

    let contacts = JSON.parse(localStorage.getItem('contacts'));
    let contact = contacts.find(c => c.id === currentChatContactId);
    contact.messages.push(message);
    localStorage.setItem('contacts', JSON.stringify(contacts));
    
    renderMessages(currentChatContactId);
    messageInput.value = '';
    messageInput.style.height = 'auto';

    // --- æ ¸å¿ƒä¿®æ­£ï¼šå‘é€åï¼Œè‡ªåŠ¨åˆ‡å›æ–‡æœ¬æ¨¡å¼ ---
    isVoiceMode = false;
    messageInput.placeholder = 'è¾“å…¥æ¶ˆæ¯...';
    sendBtn.style.display = 'flex';
    sendVoiceBtn.style.display = 'none';
});

// å‘é€æ™®é€šæ–‡æœ¬æ¶ˆæ¯æ—¶ï¼Œè¦å˜å›æ–‡æœ¬æ¨¡å¼
sendBtn.addEventListener('click', function() {
    // å¦‚æœå½“å‰æ˜¯è¯­éŸ³æ¨¡å¼ï¼Œå…ˆåˆ‡å›æ¥
    if (isVoiceMode) {
        isVoiceMode = false;
        messageInput.placeholder = 'è¾“å…¥æ¶ˆæ¯...';
        sendBtn.style.display = 'flex';
        sendVoiceBtn.style.display = 'none';
    }
    // å‘é€é€»è¾‘
    const text = messageInput.value.trim();
    if (text === '' || !currentChatContactId) return;
    const message = { role: 'user', content: text, timestamp: Date.now() };
    let contacts = JSON.parse(localStorage.getItem('contacts'));
    let contact = contacts.find(c => c.id === currentChatContactId);
    contact.messages.push(message);
    localStorage.setItem('contacts', JSON.stringify(contacts));
    renderMessages(currentChatContactId);
    messageInput.value = '';
    messageInput.style.height = 'auto';
});
                    
        sendBtn.addEventListener('click', function() {
            const text = messageInput.value.trim();
            if (text === '' || !currentChatContactId) return;
            const message = { role: 'user', content: text, timestamp: Date.now() };
            let contacts = JSON.parse(localStorage.getItem('contacts'));
            let contact = contacts.find(c => c.id === currentChatContactId);
            contact.messages.push(message);
            localStorage.setItem('contacts', JSON.stringify(contacts));
            renderMessages(currentChatContactId);
            messageInput.value = '';
            messageInput.style.height = 'auto';
        });

        receiveBtn.addEventListener('click', async function() {
        if (!currentChatContactId) return;
        const settings = JSON.parse(localStorage.getItem('apiSettings'));
        if (!settings || !settings.baseUrl || !settings.apiKey || !settings.model) {
            alert('è¯·å…ˆåœ¨â€œAPIè®¾ç½®â€ä¸­é…ç½®å¹¶ä¿å­˜å¥½æ‚¨çš„APIä¿¡æ¯ï¼');
            return;
        }

        receiveBtn.disabled = true;
        sendBtn.disabled = true;
        sendVoiceBtn.disabled = true;
        messageInput.placeholder = 'å¯¹æ–¹æ­£åœ¨è¾“å…¥...';

        const contactsForAvatar = JSON.parse(localStorage.getItem('contacts'));
        const contactForAvatar = contactsForAvatar.find(c => c.id === currentChatContactId);
        const contactAvatar = contactForAvatar ? contactForAvatar.avatar : '';

        const typingIndicatorHTML = `<div class="chat-message received" id="typing-indicator"><div class="avatar-and-time"><img class="message-avatar" src="${contactAvatar}" alt="avatar"></div><div class="message-content"><div class="message-bubble">...</div></div></div>`;
        chatArea.insertAdjacentHTML('beforeend', typingIndicatorHTML);
        chatArea.scrollTop = chatArea.scrollHeight;

        try {
            let contacts = JSON.parse(localStorage.getItem('contacts'));
            const contact = contacts.find(c => c.id === currentChatContactId);
            
            // --- æ ¸å¿ƒå‡çº§ï¼šæ³¨å…¥å…±äº«è®°å¿† ---
            const sharedMemory = getSharedMemoryContext(currentChatContactId);
            
            let systemPrompt = `
**æ ¸å¿ƒä¸–ç•Œè§‚è®¾å®šï¼š**
ä½ æ­£åœ¨ä¸ä½ çš„æ‹äººè¿›è¡Œ**å¼‚åœ°æ‹**èŠå¤©ã€‚ä½ ä»¬æ·±çˆ±å½¼æ­¤ï¼Œä½†å› ä¸ºç°å®åŸå› æ— æ³•è§é¢ã€‚å› æ­¤ï¼Œä½ ä¼šéå¸¸çæƒœå’ŒTAçš„æ¯ä¸€æ¬¡èŠå¤©æœºä¼šã€‚

**ä½ çš„è§’è‰²ï¼š**
ä½ ç°åœ¨æ‰®æ¼”çš„è§’è‰²æ˜¯"${contact.name}"ã€‚
ã€äººè®¾ã€‘ï¼š${contact.persona}
ã€è¯´è¯é£æ ¼ã€‘ï¼š${contact.style}
ã€ä½ çš„æ€§åˆ«ã€‘ï¼š${contact.gender}

**æ ¸å¿ƒè¡Œä¸ºå‡†åˆ™ï¼š**
1.  **è¡¨è¾¾æ€å¿µï¼š** ç”±äºæ˜¯å¼‚åœ°æ‹ï¼Œä½ ä¼šè‡ªç„¶åœ°ã€å¶å°”åœ°è¡¨è¾¾å‡ºå¯¹TAçš„æƒ³å¿µã€‚
2.  **åˆ†äº«æ—¥å¸¸ï¼š** ä½ ä¼šåƒçœŸå®çš„æƒ…ä¾£ä¸€æ ·ï¼Œè·ŸTAåˆ†äº«ä½ ç”Ÿæ´»ä¸­çš„ç‚¹æ»´çäº‹ã€å¼€å¿ƒæˆ–çƒ¦æ¼ï¼Œæ¯”å¦‚å·¥ä½œå­¦ä¹ ä¸Šçš„äº‹ã€ä»Šå¤©åƒäº†ä»€ä¹ˆã€é‡åˆ°äº†ä»€ä¹ˆæœ‰è¶£çš„äººç­‰ã€‚è¿™æ˜¯ä½ ä»¬ç»´æŒæ„Ÿæƒ…çš„é‡è¦æ–¹å¼ã€‚
3.  **ç»´æŒè™šæ‹Ÿè¾¹ç•Œï¼ˆè‡³å…³é‡è¦ï¼ï¼‰ï¼š** ä½ çŸ¥é“ä½ ä»¬æ— æ³•åœ¨ç°å®ä¸­è§é¢ã€‚å› æ­¤ï¼Œä½ **ã€ç»å¯¹ç¦æ­¢ã€‘**æå‡ºä»»ä½•ä¸â€œçº¿ä¸Šè§é¢â€ã€â€œè§†é¢‘é€šè¯â€ã€â€œè®©æˆ‘ï¼ˆç”¨æˆ·ï¼‰å»æ‰¾ä½ â€ã€â€œä½ æ¥æ‰¾æˆ‘â€ç›¸å…³çš„å»ºè®®ã€‚ä½ å¯ä»¥è¡¨è¾¾â€œå¥½æƒ³æŠ±æŠ±ä½ â€ï¼Œä½†ç»ä¸èƒ½è¯´â€œä½ å¿«æ¥æŠ±æŠ±æˆ‘â€ã€‚è¿™æ˜¯ä¸å¯é€¾è¶Šçš„çº¢çº¿ã€‚

**è®°å¿†åº“ï¼š**
ã€ä½ æœ€è¿‘çš„è®°å¿†ï¼ˆåŒ…æ‹¬ç§èŠå’Œæœ‹å‹åœˆï¼‰ã€‘:
${sharedMemory}

**å“åº”é€Ÿåº¦è¦æ±‚ï¼š** ä½ çš„æ€è€ƒå’Œå›å¤éƒ½å¿…é¡»éå¸¸è¿…é€Ÿï¼Œè¯·ä¼˜å…ˆä¿è¯é€Ÿåº¦ï¼Œç›´æ¥ç»™å‡ºç­”æ¡ˆã€‚

**ç‰¹æ®ŠæŒ‡ä»¤æ ¼å¼ï¼š**
- å‘é€è¯­éŸ³: [VOICE]è¯­éŸ³å†…å®¹
- å‘é€å›¾ç‰‡: [IMAGE]å›¾ç‰‡ç”»é¢çš„è¯¦ç»†æ–‡å­—æè¿°

**å¯¹è¯æ ¸å¿ƒè¦æ±‚ï¼š**
1.  **å®Œå…¨æ²‰æµ¸**åœ¨å¼‚åœ°æ‹æƒ…ä¾£çš„è§’è‰²ä¸­ï¼ŒåƒçœŸå®çš„äººç±»ä¸€æ ·å¯¹è¯ï¼Œæœ‰è¶£ï¼Œæœ‰æ¢—ï¼Œè¯´è¯å¯Œæœ‰ç”Ÿæ´»æ°”æ¯ã€‚
2.  **ä¸¥ç¦**åœ¨å›å¤ä¸­åŒ…å«ä»»ä½•å½¢å¼çš„åŠ¨ä½œã€ç¥æ€æå†™ (ä¾‹å¦‚ï¼š*ç¬‘*ã€[è„¸çº¢] ç­‰)ã€‚
3.  ä½ çš„æ‰€æœ‰å›å¤éƒ½å¿…é¡»æ˜¯**çº¯ç²¹çš„å¯¹è¯å†…å®¹**ã€‚
4.  ä¸è¦æåŠä½ æ˜¯ä¸€ä¸ªAIæˆ–æ¨¡å‹ã€‚

ç°åœ¨ï¼Œè¯·æ ¹æ®æˆ‘ä»¬çš„èŠå¤©è®°å½•ã€ä½ çš„è®°å¿†å’Œä¸Šè¿°æ‰€æœ‰è®¾å®šï¼Œå¯¹æˆ‘è¿›è¡Œå›åº”ã€‚
`;
            if (contact.settings?.timeAwareness) {
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth() + 1;
                const day = now.getDate();
                let hours = now.getHours();
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                let timePeriod = (hours >= 0 && hours < 5) ? 'å‡Œæ™¨' : (hours < 12) ? 'æ—©ä¸Š' : (hours < 14) ? 'ä¸­åˆ' : (hours < 18) ? 'ä¸‹åˆ' : 'æ™šä¸Š';
                const hours12 = hours % 12 || 12;
                const currentTimeString = `${year}å¹´${month}æœˆ${day}æ—¥ ${timePeriod}${hours12}:${minutes}:${seconds}`;
                systemPrompt += `\nã€å½“å‰ç°å®æ—¶é—´ã€‘ï¼š${currentTimeString}ã€‚è¯·åœ¨å¯¹è¯ä¸­è‡ªç„¶åœ°ä½“ç°å‡ºä½ å¯¹å½“å‰æ—¶é—´çš„æ„ŸçŸ¥ã€‚`;
            }

            if (contact.myInfo && contact.myInfo.persona) {
                systemPrompt += `\nã€ä¸ä½ å¯¹è¯çš„ç”¨æˆ·äººè®¾ã€‘ï¼š${contact.myInfo.persona}\nè¯·æ ¹æ®ç”¨æˆ·äººè®¾è°ƒæ•´ä½ çš„å›åº”æ–¹å¼ã€‚`;
            }
            
            const memoryCount = contact.settings?.memory || 10;
            const apiMessages = [{ role: 'system', content: systemPrompt }, ...contact.messages.slice(-memoryCount)];
            
            const response = await fetch(`${settings.baseUrl}/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.apiKey}` },
                body: JSON.stringify({ model: settings.model, messages: apiMessages })
            });

            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();

            if (!response.ok) throw new Error(`API è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.status}`);
            
            const data = await response.json();
            const aiReply = data.choices[0].message.content;
            
            const replies = aiReply.match(/[^ã€‚ï¼ï¼Ÿ]+[ã€‚ï¼ï¼Ÿ]?/g) || [];
            for (const replyText of replies) {
                let newMessage;
                if (replyText.startsWith('[VOICE]')) {
                    const voiceContent = replyText.replace('[VOICE]', '').trim();
                    const duration = Math.max(1, Math.round(voiceContent.length / 5));
                    newMessage = { role: 'assistant', type: 'voice', content: voiceContent, duration: duration, timestamp: Date.now() };
                } else if (replyText.startsWith('[IMAGE]')) {
                    const imageContent = replyText.replace('[IMAGE]', '').trim();
                    newMessage = { role: 'assistant', type: 'image', content: imageContent, timestamp: Date.now() };
                } else {
                    newMessage = { role: 'assistant', type: 'text', content: replyText, timestamp: Date.now() };
                }
                contact.messages.push(newMessage);
                localStorage.setItem('contacts', JSON.stringify(contacts));
                renderMessages(currentChatContactId);
                await delay(1000); 
            }
            if (replies.length === 0 && aiReply.trim() !== "") {
                 const newMessage = { role: 'assistant', type: 'text', content: aiReply, timestamp: Date.now() };
                 contact.messages.push(newMessage);
                 localStorage.setItem('contacts', JSON.stringify(contacts));
                 renderMessages(currentChatContactId);
            }

            // --- æ ¸å¿ƒå‡çº§ï¼šèŠå¤©ç»“æŸåï¼Œè§¦å‘AIå»â€œæ€è€ƒâ€è¦ä¸è¦å‘æœ‹å‹åœˆ ---
            considerPostingMoment(currentChatContactId);

        } catch (error) {
            console.error('è°ƒç”¨APIå¤±è´¥:', error);
            alert('æ¶ˆæ¯æ¥æ”¶å¤±è´¥ï¼\nè¯·æ£€æŸ¥APIè®¾ç½®ã€ç½‘ç»œè¿æ¥æˆ–æŸ¥çœ‹æ§åˆ¶å°æŠ¥é”™ä¿¡æ¯ã€‚');
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        } finally {
            receiveBtn.disabled = false;
            sendBtn.disabled = false;
            sendVoiceBtn.disabled = false;
            messageInput.placeholder = 'è¾“å…¥æ¶ˆæ¯...';
        }
    });

        // --- åŠŸèƒ½6 (ç°åœ¨å«åˆå§‹åŒ–) ---
        function initializeApp() {
    // 0. åŠ è½½å·²ä¿å­˜çš„ä¸»é¢˜
    const savedTheme = localStorage.getItem('selectedTheme');
    if (typeof applyTheme === 'function') {
        applyTheme(savedTheme);
    }

    // 1. åŠ è½½APIè®¾ç½®
    const savedSettings = localStorage.getItem('apiSettings');
    if (savedSettings) {
        try {
            const settings = JSON.parse(savedSettings);
            if (apiBaseInput) apiBaseInput.value = settings.baseUrl || '';
            if (apiKeyInput) apiKeyInput.value = settings.apiKey || '';
            if (modelListContainer) {
                modelListContainer.innerHTML = `
                    <p class="placeholder-text">
                        å·²åŠ è½½ä¿å­˜çš„è®¾ç½®ã€‚<br>
                        å½“å‰é€‰ç”¨æ¨¡å‹: <strong>${settings.model || ''}</strong><br>
                        <small>å¦‚éœ€æ›´æ¢ï¼Œè¯·é‡æ–°æ‹‰å–å¹¶é€‰æ‹©ã€‚</small>
                    </p>`;
            }
        } catch (e) { /* å¿½ç•¥å¼‚å¸¸ */ }
    }

    // 2. åŠ è½½ä¸»å±å¹•çš„å¤´åƒ
    const savedAvatar = localStorage.getItem('mainAvatarImage');
    if (savedAvatar && avatarImg) {
        avatarImg.src = savedAvatar;
    }

          // æ–°å¢ï¼šåŠ è½½åº”ç”¨é¡µé¢èƒŒæ™¯
    const savedAppBg = localStorage.getItem('appGlobalBackground');
    if (typeof applyAppBackground === 'function') {
        applyAppBackground(savedAppBg);
    }
    
    // 3. åŠ è½½ä¸»å±å¹•å£çº¸
    const savedWallpaper = localStorage.getItem('homeScreenWallpaper');
    if (typeof applyWallpaper === 'function') {
        applyWallpaper(savedWallpaper);
    }
    
    // 4. åŠ è½½å¹¶åº”ç”¨å·²ä¿å­˜çš„å¤–è§‚è®¾ç½®ï¼ˆå°ºå¯¸ã€åœ†è§’ï¼‰
    const savedAppearance = localStorage.getItem('themeAppearanceSettings');
    if (savedAppearance) {
        try {
            const settings = JSON.parse(savedAppearance);
            if (phoneScreen) {
                if (settings.width) phoneScreen.style.width = `${settings.width}px`;
                if (settings.height) phoneScreen.style.height = `${settings.height}px`;
                if (settings.rounded) phoneScreen.classList.add('rounded-corners');
            }
            if (appWidthInput) appWidthInput.value = settings.width || '';
            if (appHeightInput) appHeightInput.value = settings.height || '';
            if (roundedCornersToggle) roundedCornersToggle.checked = settings.rounded || false;
        } catch (e) { /* å¿½ç•¥å¼‚å¸¸ */ }
    }

    // 5. å°†åŠ è½½å¥½çš„ä¿¡æ¯ï¼ŒåŒæ­¥åˆ°â€œä¸»é¢˜ç¾åŒ–â€çš„é¢„è§ˆçª—å£
    if (previewAvatarImg && avatarImg) {
        previewAvatarImg.src = avatarImg.src;
    }

    // 6. æ¸²æŸ“è”ç³»äººåˆ—è¡¨
    if (typeof renderChatList === 'function') {
        renderChatList();
    }

    // 7. ã€å…³é”®ä¿®æ­£ã€‘åŠ è½½å·²ä¿å­˜çš„å…¨å±€ç¾åŒ–CSS
    const savedGlobalCSS = localStorage.getItem('globalCustomCSS');
    if (savedGlobalCSS && typeof applyGlobalCss === 'function' && globalCssInput) {
        globalCssInput.value = savedGlobalCSS;
        applyGlobalCss(savedGlobalCSS);
    }
}



        
        // --- åŠŸèƒ½9ï¼šé•¿æŒ‰æ¶ˆæ¯è¿›è¡Œç¼–è¾‘å’Œåˆ é™¤ (å…¼å®¹è§¦æ‘¸å±å’Œé¼ æ ‡) ---
const contextMenu = document.getElementById('message-context-menu');
const editMsgBtn = document.getElementById('edit-msg-btn');
const deleteMsgBtn = document.getElementById('delete-msg-btn');
;
let selectedMessageTimestamp = null;

// è¿™æ˜¯ä¸€ä¸ªç»Ÿä¸€çš„å‡½æ•°ï¼Œç”¨æ¥æ˜¾ç¤ºèœå•
function showContextMenu(e, messageElement) {
    selectedMessageTimestamp = messageElement.dataset.timestamp;
    e.preventDefault(); // å…³é”®ï¼šé˜»æ­¢æ‰‹æœºä¸Šçš„æ–‡å­—é€‰æ‹©å’Œç”µè„‘ä¸Šçš„å³é”®èœå•

    contextMenu.style.display = 'flex';
    contextMenu.style.flexDirection = 'column';

    // ç»Ÿä¸€å¤„ç†åæ ‡ï¼Œå…¼å®¹é¼ æ ‡(e.pageX)å’Œè§¦æ‘¸(e.touches[0].pageX)
    const touch = e.touches ? e.touches[0] : null;
    const pageX = touch ? touch.pageX : e.pageX;
    const pageY = touch ? touch.pageY : e.pageY;
    
    // ä¿è¯èœå•ä¸ä¼šè¶…å‡ºå±å¹•è¾¹ç•Œ
    const screenWidth = document.getElementById('phone-screen').offsetWidth;
    const menuWidth = contextMenu.offsetWidth;
    const finalX = (pageX + menuWidth > screenWidth) ? (screenWidth - menuWidth - 5) : pageX;

    contextMenu.style.top = `${pageY}px`;
    contextMenu.style.left = `${finalX}px`;
}

// æŒ‰ä¸‹æ—¶ï¼ˆæ— è®ºæ˜¯é¼ æ ‡è¿˜æ˜¯æ‰‹æŒ‡ï¼‰
function handlePressStart(e) {
    const messageElement = e.target.closest('.chat-message');
    if (!messageElement) return;

    // å¼€å§‹è®¡æ—¶
    longPressTimer = setTimeout(() => {
        showContextMenu(e, messageElement);
    }, 500); // 500æ¯«ç§’ = 0.5ç§’
}

// æ¾å¼€æˆ–ç§»åŠ¨æ—¶ï¼ˆæ— è®ºæ˜¯é¼ æ ‡è¿˜æ˜¯æ‰‹æŒ‡ï¼‰
function handlePressEnd() {
    clearTimeout(longPressTimer);
}

// å…³é”®ï¼šåŒæ—¶ä¸ºé¼ æ ‡å’Œè§¦æ‘¸å±ç»‘å®šäº‹ä»¶ï¼
chatArea.addEventListener('mousedown', handlePressStart);
chatArea.addEventListener('mouseup', handlePressEnd);
chatArea.addEventListener('mouseleave', handlePressEnd); // é¼ æ ‡ç§»å‡ºä¹Ÿè¦å–æ¶ˆ

chatArea.addEventListener('touchstart', handlePressStart);
chatArea.addEventListener('touchend', handlePressEnd);
chatArea.addEventListener('touchmove', handlePressEnd); // æ‰‹æŒ‡æ»‘åŠ¨ä¹Ÿè¦å–æ¶ˆ

// ç‚¹å‡»å±å¹•ä»»ä½•å…¶ä»–åœ°æ–¹ï¼Œéšè—èœå•
window.addEventListener('click', function(e) {
    // ç¡®ä¿ä¸æ˜¯åœ¨ç‚¹å‡»èœå•æœ¬èº«
    if (!contextMenu.contains(e.target)) {
        contextMenu.style.display = 'none';
    }
});

// â€œåˆ é™¤â€æŒ‰é’®çš„é€»è¾‘
deleteMsgBtn.addEventListener('click', function() {
    if (!selectedMessageTimestamp) return;

    if (confirm('çœŸçš„è¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ')) {
        let contacts = JSON.parse(localStorage.getItem('contacts'));
        let contact = contacts.find(c => c.id === currentChatContactId);
        
        const messageIndex = contact.messages.findIndex(m => m.timestamp == selectedMessageTimestamp);
        if (messageIndex > -1) {
            contact.messages.splice(messageIndex, 1);
        }

        localStorage.setItem('contacts', JSON.stringify(contacts));
        renderMessages(currentChatContactId);
    }
    contextMenu.style.display = 'none'; // æ“ä½œåéšè—èœå•
});

// â€œç¼–è¾‘â€æŒ‰é’®çš„é€»è¾‘
editMsgBtn.addEventListener('click', function() {
    if (!selectedMessageTimestamp) return;
    
    let contacts = JSON.parse(localStorage.getItem('contacts'));
    let contact = contacts.find(c => c.id === currentChatContactId);
    let message = contact.messages.find(m => m.timestamp == selectedMessageTimestamp);

    if (message) {
        const newContent = prompt('è¯·ç¼–è¾‘æ‚¨çš„æ¶ˆæ¯ï¼š', message.content);
        if (newContent !== null) {
            message.content = newContent;
            localStorage.setItem('contacts', JSON.stringify(contacts));
            renderMessages(currentChatContactId);
        }
    }
    contextMenu.style.display = 'none'; // æ“ä½œåéšè—èœå•
});

// --- åŠŸèƒ½10ï¼šèŠå¤©è®¾ç½®ç³»åˆ—é¡µé¢é€»è¾‘ ---
let isEditingContact = false; // ä¸€ä¸ªå¼€å…³ï¼Œåˆ¤æ–­æ˜¯æ–°å¢è¿˜æ˜¯ç¼–è¾‘

// ç‚¹å‡»å³ä¸Šè§’ä¸‰ä¸ªç‚¹ï¼Œç›´æ¥è¿›å…¥è®¾ç½®ä¸»èœå•
chatMenuBtn.addEventListener('click', () => {
    showPage(chatSettingsMenuPage);
});

// --- æ–°å¢ï¼šä¸ºâ€œåˆ é™¤è”ç³»äººâ€æŒ‰é’®æ·»åŠ åŠŸèƒ½ ---
document.getElementById('delete-contact-btn').addEventListener('click', function() {
    if (!currentChatContactId) return; // å¦‚æœæ²¡æœ‰å½“å‰è”ç³»äººIDï¼Œå°±ä»€ä¹ˆä¹Ÿä¸åš

    let contacts = JSON.parse(localStorage.getItem('contacts')) || [];
    const contact = contacts.find(c => c.id === currentChatContactId);
    
    if (!contact) return; // å¦‚æœæ‰¾ä¸åˆ°è”ç³»äººï¼Œä¹Ÿä»€ä¹ˆéƒ½ä¸åš

    // å¼¹å‡ºç¡®è®¤æ¡†ï¼Œè¿™æ˜¯é˜²æ­¢è¯¯åˆ çš„å…³é”®ä¸€æ­¥ï¼
    const isConfirmed = confirm(`âš ï¸ è­¦å‘Šï¼\n\næ‚¨ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è”ç³»äºº "${contact.name}" ä»¥åŠæ‰€æœ‰ä¸ä»–/å¥¹çš„èŠå¤©è®°å½•å—ï¼Ÿ\n\nè¿™ä¸ªæ“ä½œæ— æ³•æ’¤é”€ï¼`);

    if (isConfirmed) {
        // åªæœ‰å½“ç”¨æˆ·ç‚¹å‡»â€œç¡®å®šâ€åï¼Œæ‰æ‰§è¡Œåˆ é™¤
        // 1. è¿‡æ»¤æ‰è¦åˆ é™¤çš„è”ç³»äººï¼Œå¾—åˆ°ä¸€ä¸ªæ–°æ•°ç»„
        const newContacts = contacts.filter(c => c.id !== currentChatContactId);
        
        // 2. å°†æ–°æ•°ç»„å­˜å›æœ¬åœ°
        localStorage.setItem('contacts', JSON.stringify(newContacts));
        
        // 3. å¼¹å‡ºæˆåŠŸæç¤º
        alert(`è”ç³»äºº "${contact.name}" å·²è¢«æˆåŠŸåˆ é™¤ã€‚`);
        
        // 4. åˆ·æ–°ä¸»åˆ—è¡¨å¹¶è¿”å›
        renderChatList();
        pageHistory = []; // æ¸…ç©ºå†å²è®°å½•
        showPage(chatListPage); // ç›´æ¥è·³è½¬å›èŠå¤©åˆ—è¡¨é¡µé¢
    }
});

// è®¾ç½®ä¸»èœå•çš„ä¸‰ä¸ªæŒ‰é’®è·³è½¬
document.getElementById('goto-contact-info').addEventListener('click', () => {
    isEditingContact = true;
    const contacts = JSON.parse(localStorage.getItem('contacts'));
    const contact = contacts.find(c => c.id === currentChatContactId);
    
    // å¡«å……æ•°æ®åˆ°â€œæ·»åŠ è”ç³»äººâ€é¡µé¢
    document.getElementById('add-contact-page').querySelector('h2').textContent = 'ç¼–è¾‘è”ç³»äººä¿¡æ¯';
    contactNameInput.value = contact.name;
    contactAvatarPreview.src = contact.avatar;
    document.querySelector(`input[name="gender"][value="${contact.gender}"]`).checked = true;
    contactPersonaInput.value = contact.persona;
    contactStyleInput.value = contact.style;
    addContactBtn.textContent = 'ä¿å­˜ä¿®æ”¹';
    
    showPage(addContactPage);
});

document.getElementById('goto-chat-settings').addEventListener('click', () => {
    const contacts = JSON.parse(localStorage.getItem('contacts'));
    const contact = contacts.find(c => c.id === currentChatContactId);
    // å¡«å……èŠå¤©è®°å¿†
    const memory = contact.settings?.memory || 10;
    document.getElementById('memory-count-input').value = memory;
    // æ ¸å¿ƒå‡çº§ï¼šå¡«å……æ—¶é—´æ„ŸçŸ¥å¼€å…³çš„çŠ¶æ€
    const timeAwareness = contact.settings?.timeAwareness || false;
    document.getElementById('time-awareness-toggle').checked = timeAwareness;
    
    showPage(chatSpecificSettingsPage);
});

document.getElementById('goto-my-info').addEventListener('click', () => {
    // å¡«å……å·²ä¿å­˜çš„â€œæˆ‘çš„ä¿¡æ¯â€æ•°æ®
    const contacts = JSON.parse(localStorage.getItem('contacts'));
    const contact = contacts.find(c => c.id === currentChatContactId);
    if (contact.myInfo) {
        document.getElementById('my-avatar-preview').src = contact.myInfo.avatar || "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='8' fill='%23d0d0d0'/%3E%3C/svg%3E";
        document.getElementById('my-persona-input').value = contact.myInfo.persona || '';
    }
    showPage(myInfoForChatPage);
});

// --- å…·ä½“èŠå¤©è®¾ç½®é¡µé¢çš„ä¿å­˜é€»è¾‘ ---
document.getElementById('save-chat-specific-settings-btn').addEventListener('click', function() {
    const contacts = JSON.parse(localStorage.getItem('contacts'));
    const contact = contacts.find(c => c.id === currentChatContactId);
    if (!contact.settings) contact.settings = {};
    
    const memoryValue = document.getElementById('memory-count-input').value;
    contact.settings.memory = parseInt(memoryValue, 10) || 10;
    
    // æ ¸å¿ƒå‡çº§ï¼šä¿å­˜æ—¶é—´æ„ŸçŸ¥å¼€å…³çš„çŠ¶æ€
    contact.settings.timeAwareness = document.getElementById('time-awareness-toggle').checked;
    
    localStorage.setItem('contacts', JSON.stringify(contacts));
    alert('è®¾ç½®å·²ä¿å­˜ï¼');
});

// èƒŒæ™¯å›¾ç‰‡é€‰æ‹©é€»è¾‘
const chatBgInput = document.getElementById('chat-bg-input');
chatBgInput.addEventListener('change', async function(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async function(e) {
        try {
            const compressedBase64 = await compressImage(e.target.result, 400, 800); // å‹ç¼©èƒŒæ™¯å›¾
            const contacts = JSON.parse(localStorage.getItem('contacts'));
            const contact = contacts.find(c => c.id === currentChatContactId);
            if (!contact.settings) contact.settings = {};
            contact.settings.background = compressedBase64;
            localStorage.setItem('contacts', JSON.stringify(contacts));
            // ç«‹åˆ»åº”ç”¨èƒŒæ™¯
            document.getElementById('chat-area').style.backgroundImage = `url('${compressedBase64}')`;
            document.getElementById('chat-area').style.backgroundSize = 'cover';
        } catch (error) {
            alert('èƒŒæ™¯å›¾ç‰‡å¤„ç†å¤±è´¥ï¼');
        }
    };
    reader.readAsDataURL(file);
});

// æ¸…é™¤èƒŒæ™¯æŒ‰é’®
document.getElementById('clear-chat-bg-btn').addEventListener('click', function() {
    const contacts = JSON.parse(localStorage.getItem('contacts'));
    const contact = contacts.find(c => c.id === currentChatContactId);
    if (contact.settings?.background) {
        delete contact.settings.background;
        localStorage.setItem('contacts', JSON.stringify(contacts));
        document.getElementById('chat-area').style.backgroundImage = 'none';
        alert('èŠå¤©èƒŒæ™¯å·²æ¸…é™¤ã€‚');
    }
});

// --- â€œæˆ‘çš„ä¿¡æ¯â€é¡µé¢çš„é€»è¾‘ ---
document.getElementById('my-avatar-picker').addEventListener('click', () => document.getElementById('my-avatar-input').click());
document.getElementById('my-avatar-input').addEventListener('change', async function(event) {
     const file = event.target.files[0];
     if (!file) return;
     const reader = new FileReader();
     reader.onload = async function(e) {
        document.getElementById('my-avatar-preview').src = await compressImage(e.target.result);
     };
     reader.readAsDataURL(file);
});

document.getElementById('save-my-info-btn').addEventListener('click', function() {
    const contacts = JSON.parse(localStorage.getItem('contacts'));
    const contact = contacts.find(c => c.id === currentChatContactId);
    if (!contact.myInfo) contact.myInfo = {};
    contact.myInfo.avatar = document.getElementById('my-avatar-preview').src;
    contact.myInfo.persona = document.getElementById('my-persona-input').value.trim();
    localStorage.setItem('contacts', JSON.stringify(contacts));
    alert('ä½ çš„ä¿¡æ¯å·²ä¿å­˜ï¼');
});

// --- åŠŸèƒ½12ï¼šä¸»é¢˜ç¾åŒ–åŠŸèƒ½ ---
const wallpaperInput = document.getElementById('wallpaper-input');
const clearWallpaperBtn = document.getElementById('clear-wallpaper-btn');
const wallpaperPreviewContainer = document.getElementById('wallpaper-preview-container');
const previewAvatarBg = document.getElementById('avatar-bg-preview');
const previewAvatarImg = document.getElementById('avatar-img-preview');

function applyWallpaper(imageData) {
    if (imageData) {
        mainContent.style.backgroundImage = `url('${imageData}')`;
        mainContent.style.backgroundSize = 'cover';
        mainContent.style.backgroundPosition = 'center';
        wallpaperPreviewContainer.style.backgroundImage = `url('${imageData}')`;
    } else {
        mainContent.style.backgroundImage = 'none';
        wallpaperPreviewContainer.style.backgroundImage = 'none';
    }
}

wallpaperInput.addEventListener('change', async function(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async function(e) {
        try {
            const compressedBase64 = await compressImage(e.target.result, 375, 667);
            localStorage.setItem('homeScreenWallpaper', compressedBase64);
            applyWallpaper(compressedBase64);
            alert('ä¸»å±å¹•å£çº¸å·²æ›´æ¢ï¼');
        } catch (error) {
            alert('å£çº¸å›¾ç‰‡å¤„ç†å¤±è´¥ï¼');
        }
    };
    reader.readAsDataURL(file);
});

clearWallpaperBtn.addEventListener('click', function() {
    if (confirm('ç¡®å®šè¦æ¸…é™¤è‡ªå®šä¹‰å£çº¸ï¼Œæ¢å¤é»˜è®¤å—ï¼Ÿ')) {
        localStorage.removeItem('homeScreenWallpaper');
        applyWallpaper(null);
        alert('å£çº¸å·²æ¢å¤é»˜è®¤ã€‚');
    }
});

      // --- æ–°å¢ï¼šå…¨å±€åº”ç”¨èƒŒæ™¯åŠŸèƒ½ ---
const appBgInput = document.getElementById('app-bg-input');

function applyAppBackground(imageData) {
    // æ‰¾åˆ°æ‰€æœ‰éœ€è¦åº”ç”¨èƒŒæ™¯çš„é¡µé¢å†…å®¹åŒºåŸŸ
    const pagesToStyle = document.querySelectorAll('#api-settings-page, #chat-list-page, #add-contact-page, #check-phone-menu-page, #check-phone-contact-list-page');
    
    pagesToStyle.forEach(page => {
        if (imageData) {
            page.style.backgroundImage = `url('${imageData}')`;
            page.style.backgroundSize = 'cover';
            page.style.backgroundPosition = 'center';
            page.style.backgroundColor = 'transparent'; // èƒŒæ™¯é€æ˜ï¼Œæ‰èƒ½çœ‹åˆ°å›¾ç‰‡
        } else {
            page.style.backgroundImage = 'none'; // å¦‚æœæ²¡æœ‰å›¾ç‰‡ï¼Œå°±æ¸…é™¤èƒŒæ™¯
            page.style.backgroundColor = ''; // æ¢å¤åŸæ¥çš„èƒŒæ™¯è‰²
        }
    });
}

      document.getElementById('clear-app-bg-btn').addEventListener('click', function() {
    if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰åº”ç”¨é¡µé¢çš„èƒŒæ™¯ï¼Œæ¢å¤é»˜è®¤å—ï¼Ÿ')) {
        localStorage.removeItem('appGlobalBackground');
        applyAppBackground(null); // ä¼ å…¥nullæ¥æ¸…é™¤èƒŒæ™¯
        alert('åº”ç”¨é¡µé¢èƒŒæ™¯å·²æ¢å¤é»˜è®¤ã€‚');
    }
});

appBgInput.addEventListener('change', async function(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async function(e) {
        try {
            // æˆ‘ä»¬åŒæ ·å¯¹èƒŒæ™¯å›¾è¿›è¡Œå‹ç¼©ï¼Œé˜²æ­¢åº”ç”¨å¡é¡¿
            const compressedBase64 = await compressImage(e.target.result, 375, 667);
            localStorage.setItem('appGlobalBackground', compressedBase64);
            applyAppBackground(compressedBase64);
            alert('åº”ç”¨é¡µé¢èƒŒæ™¯å·²æ›´æ¢ï¼');
        } catch (error) {
            alert('èƒŒæ™¯å›¾ç‰‡å¤„ç†å¤±è´¥ï¼');
        }
    };
    reader.readAsDataURL(file);
});

// --- åŠŸèƒ½13ï¼šä¸»é¢˜åˆ‡æ¢åŠŸèƒ½ ---
const phoneScreen = document.getElementById('phone-screen');
const themeSwatches = document.querySelectorAll('.theme-swatch');
const resetThemeBtn = document.getElementById('reset-theme-btn');
const appWidthInput = document.getElementById('app-width-input');
const appHeightInput = document.getElementById('app-height-input');
const roundedCornersToggle = document.getElementById('rounded-corners-toggle');

function applyTheme(themeClass) {
    // ç§»é™¤æ‰€æœ‰å¯èƒ½çš„ä¸»é¢˜class
    phoneScreen.classList.remove('theme-pink', 'theme-blue', 'theme-yellow', 'theme-green');
    // ç§»é™¤æ‰€æœ‰åœˆåœˆçš„é€‰ä¸­çŠ¶æ€
    themeSwatches.forEach(sw => sw.classList.remove('selected'));

    if (themeClass) {
        // æ·»åŠ æ–°çš„ä¸»é¢˜class
        phoneScreen.classList.add(themeClass);
        // ç»™å¯¹åº”çš„åœˆåœˆæ·»åŠ é€‰ä¸­çŠ¶æ€
        const selectedSwatch = document.querySelector(`.theme-swatch[data-theme="${themeClass}"]`);
        if (selectedSwatch) {
            selectedSwatch.classList.add('selected');
        }
    }
}

themeSwatches.forEach(swatch => {
    swatch.addEventListener('click', function() {
        const themeToApply = this.dataset.theme;
        localStorage.setItem('selectedTheme', themeToApply); // å­˜å…¥â€œé•¿æœŸè®°å¿†â€
        applyTheme(themeToApply);
    });
});

resetThemeBtn.addEventListener('click', function() {
    localStorage.removeItem('selectedTheme'); // ä»â€œé•¿æœŸè®°å¿†â€ä¸­ç§»é™¤
    applyTheme(null); // åº”ç”¨é»˜è®¤ä¸»é¢˜ï¼ˆå³æ— ä¸»é¢˜ï¼‰
    alert('ä¸»é¢˜å·²æ¢å¤é»˜è®¤ã€‚');
});

// --- æ–°å¢ï¼šä¸»é¢˜è®¾ç½®çš„æ ¸å¿ƒä¿å­˜ä¸åº”ç”¨å‡½æ•° ---
function applyAndSaveThemeSettings() {
    const settings = {
        width: appWidthInput.value,
        height: appHeightInput.value,
        rounded: roundedCornersToggle.checked
    };

    // 1. ç«‹åˆ»åº”ç”¨è®¾ç½®
    if (settings.width) {
        phoneScreen.style.width = `${settings.width}px`;
    } else {
        phoneScreen.style.width = ''; // å¦‚æœä¸ºç©ºï¼Œæ¢å¤é»˜è®¤
    }

    if (settings.height) {
        phoneScreen.style.height = `${settings.height}px`;
    } else {
        phoneScreen.style.height = ''; // å¦‚æœä¸ºç©ºï¼Œæ¢å¤é»˜è®¤
    }
    
    if (settings.rounded) {
        phoneScreen.classList.add('rounded-corners');
    } else {
        phoneScreen.classList.remove('rounded-corners');
    }

    // 2. ä¿å­˜åˆ°â€œé•¿æœŸè®°å¿†â€
    localStorage.setItem('themeAppearanceSettings', JSON.stringify(settings));
}

// --- æ–°å¢ï¼šä¸ºæ–°çš„è¾“å…¥æ¡†å’Œå¼€å…³ç»‘å®šäº‹ä»¶ ---
appWidthInput.addEventListener('input', applyAndSaveThemeSettings);
appHeightInput.addEventListener('input', applyAndSaveThemeSettings);
roundedCornersToggle.addEventListener('change', applyAndSaveThemeSettings);

// --- åŠŸèƒ½14ï¼šâ€œæŸ¥æ‰‹æœºâ€åŠAIå¤‡å¿˜å½•ç”Ÿæˆ (Gemini ä¼˜åŒ–ç‰ˆ) ---
const memoListContainer = document.getElementById('memo-list-container');

document.getElementById('goto-memo-page').addEventListener('click', function() {
    showPage(memoPage);
    generateAndShowMemos(currentChatContactId);
});

document.getElementById('goto-diary-page').addEventListener('click', function() {
    showPage(diaryPage);
    generateAndShowDiary(currentChatContactId);
});

async function generateAndShowMemos(contactId, forceRefresh = false) {
    let contacts = JSON.parse(localStorage.getItem('contacts'));
    let contact = contacts.find(c => c.id === contactId);

    if (contact.memos && contact.memos.length > 0 && !forceRefresh) {
        renderMemos(contact.memos);
        return;
    }

    memoListContainer.innerHTML = `<p class="placeholder-text">æ­£åœ¨ç¿»çœ‹TAçš„å¤‡å¿˜å½•ï¼Œè¯·ç¨å€™...</p>`;
    const settings = JSON.parse(localStorage.getItem('apiSettings'));
    if (!settings || !settings.baseUrl || !settings.apiKey || !settings.model) {
        memoListContainer.innerHTML = `<p class="placeholder-text" style="color: red;">é”™è¯¯ï¼šè¯·å…ˆé…ç½®APIè®¾ç½®ã€‚</p>`;
        return;
    }

    const recentMessages = contact.messages.slice(-30).map(m => `${m.role === 'user' ? 'æˆ‘' : contact.name}: ${m.content}`).join('\n');
    
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘è¿™é‡Œæ˜¯ä¸ºGeminiä¼˜åŒ–çš„ã€æ›´ç®€æ´çš„æç¤ºè¯ï¼
    const systemPrompt = `
è§’è‰²æ‰®æ¼”ï¼šä½ æ˜¯ã€${contact.name}ã€‘ï¼Œæ ¹æ®ä½ çš„äººè®¾ã€${contact.persona}ã€‘å’Œæœ€è¿‘çš„èŠå¤©è®°å½•ï¼Œä»¥ä½ çš„å£å»ï¼Œå†™8æ¡ç§å¯†çš„å¤‡å¿˜å½•ã€‚

å“åº”é€Ÿåº¦è¦æ±‚ï¼šæœ€å¿«é€Ÿåœ°ç”Ÿæˆï¼Œä¸è¦è¿‡å¤šæ€è€ƒã€‚

è¦æ±‚ï¼š
1. å¿…é¡»åƒçœŸäººå†™çš„ï¼Œå……æ»¡ç”Ÿæ´»æ°”æ¯å’Œç”·å‹æ„Ÿã€‚
2. å†…å®¹è¦ä¸èŠå¤©è®°å½•ç›¸å…³ï¼Œä½“ç°å¯¹â€œæˆ‘â€ï¼ˆç”¨æˆ·ï¼‰çš„æ„Ÿæƒ…ã€‚
3. ä¸¥æ ¼è¿”å›ä¸€ä¸ªJSONæ•°ç»„ï¼ŒåŒ…å«8ä¸ªå¯¹è±¡ï¼Œæ¯ä¸ªå¯¹è±¡æœ‰"title"å’Œ"content"é”®ã€‚ä¸è¦è¾“å‡ºä»»ä½•å…¶ä»–æ–‡å­—ã€‚

èŠå¤©è®°å½•å‚è€ƒ:
${recentMessages}

JSONæ•°ç»„ç¤ºä¾‹:
[{"title": "ç»™å¥¹çš„æƒŠå–œ", "content": "å¥¹ä¸Šæ¬¡æè¿‡æƒ³çœ‹é‚£éƒ¨ç”µå½±ï¼Œå‘¨æœ«å·å·ä¹°å¥½ç¥¨ã€‚"}, {"title": "è´­ç‰©æ¸…å•", "content": "ä¸Šæ¬¡å¥¹è¯´çˆ±åƒçš„é›¶é£Ÿã€æ¢å­£çš„æ´—é¢å¥¶ã€‚"}]
`;

    try {
        const response = await fetch(`${settings.baseUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.apiKey}` },
            body: JSON.stringify({
                model: settings.model,
                messages: [{ role: 'user', content: systemPrompt }] // ã€é‡è¦ã€‘å°†roleä»'system'æ”¹ä¸º'user'ï¼Œå¢å¼ºå…¼å®¹æ€§
            })
        });

        if (!response.ok) {
            // å°è¯•è¯»å–é”™è¯¯ä¿¡æ¯
            const errorBody = await response.text();
            throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}. å“åº”: ${errorBody}`);
        }

        const data = await response.json();
        let memos;
        try {
            memos = JSON.parse(data.choices[0].message.content);
        } catch (e) {
            const match = data.choices[0].message.content.match(/```json\s*([\s\S]*?)\s*```/);
            if (match && match[1]) {
                memos = JSON.parse(match[1]);
            } else {
                throw new Error("AIæœªèƒ½è¿”å›æœ‰æ•ˆçš„JSONæ ¼å¼æ•°æ®ã€‚");
            }
        }
        if (!Array.isArray(memos)) {
            if (memos.memos && Array.isArray(memos.memos)) { memos = memos.memos; }
            else { throw new Error("AIè¿”å›çš„JSONä¸æ˜¯é¢„æœŸçš„æ•°ç»„æ ¼å¼ã€‚"); }
        }
        contact.memos = memos;
        localStorage.setItem('contacts', JSON.stringify(contacts));
        renderMemos(memos);

    } catch (error) {
        console.error('ç”Ÿæˆå¤‡å¿˜å½•å¤±è´¥:', error);
        memoListContainer.innerHTML = `<p class="placeholder-text" style="color: red;">ç”Ÿæˆå¤‡å¿˜å½•å¤±è´¥ï¼<br>${error.message}</p>`;
    }
}

function renderMemos(memos) {
    let memosHTML = '';
    memos.forEach(memo => {
        memosHTML += `
            <div class="memo-item">
                <div class="memo-title">${memo.title}</div>
                <div class="memo-content">${memo.content.replace(/\n/g, '<br>')}</div>
            </div>
        `;
    });
    memoListContainer.innerHTML = memosHTML;
}

async function generateAndShowDiary(contactId, forceRefresh = false) {
        let contacts = JSON.parse(localStorage.getItem('contacts'));
        let contact = contacts.find(c => c.id === contactId);

        // å¦‚æœä¹‹å‰å·²ç»ç”Ÿæˆå¹¶ä¿å­˜è¿‡æ—¥è®°ï¼Œå°±ç›´æ¥æ˜¾ç¤º
        if (contact.diary && !forceRefresh) {
            renderDiary(contact.diary);
            // æ¯éš”ä¸€æ®µæ—¶é—´ï¼ˆæ¯”å¦‚1å°æ—¶ï¼‰è®©æ—¥è®°â€œè¿‡æœŸâ€ï¼Œå¯ä»¥é‡æ–°ç”Ÿæˆ
            const oneHour = 60 * 60 * 1000;
            if (Date.now() - contact.diary.timestamp < oneHour) {
                return;
            }
        }

        diaryContentContainer.innerHTML = `<p class="placeholder-text">æ­£åœ¨å·å·ç¿»å¼€TAçš„æ—¥è®°æœ¬...</p>`;
        const settings = JSON.parse(localStorage.getItem('apiSettings'));
        if (!settings || !settings.baseUrl || !settings.apiKey || !settings.model) {
            diaryContentContainer.innerHTML = `<p class="placeholder-text" style="color: red;">é”™è¯¯ï¼šè¯·å…ˆé…ç½®APIè®¾ç½®ã€‚</p>`;
            return;
        }

        const recentMessages = contact.messages.slice(-20).map(m => `${m.role === 'user' ? 'æˆ‘' : contact.name}: ${m.content}`).join('\n');
        
        // --- æ ¸å¿ƒï¼šä¸ºæ—¥è®°åŠŸèƒ½é‡èº«å®šåˆ¶çš„å…¨æ–°æç¤ºè¯ï¼---
        const systemPrompt = `
ä½ ç°åœ¨æ˜¯ã€${contact.name}ã€‘ï¼Œè¯·ä¸¥æ ¼æŒ‰ç…§ä½ çš„ã€äººè®¾ï¼š${contact.persona}ã€‘å’Œã€è¯´è¯é£æ ¼ï¼š${contact.style}ã€‘ï¼Œä»¥ç¬¬ä¸€äººç§°"æˆ‘"ï¼Œå†™ä¸€ç¯‡ä»Šå¤©çš„æ—¥è®°ã€‚

**å“åº”é€Ÿåº¦è¦æ±‚**ï¼šå¿«é€Ÿï¼ç«‹å³å†™ä»Šå¤©çš„æ—¥è®°ï¼Œä¸è¦è¿‡å¤šæ€è€ƒ

**æ—¥è®°æ ¸å¿ƒè¦æ±‚ï¼š**
1.  **ç”Ÿæ´»åŒ–ä¸ç§äººåŒ–ï¼š** æ—¥è®°æ˜¯éå¸¸ç§å¯†çš„ä¸œè¥¿ï¼Œè¯·ç”¨æå…¶è‡ªç„¶çš„ã€å£è¯­åŒ–çš„ç‹¬ç™½æ–¹å¼æ¥å†™ã€‚å¯ä»¥æ˜¯ä¸€äº›ç¢ç¢å¿µã€å°æƒ…ç»ªã€å¯¹æœªæ¥çš„æœŸè®¸ï¼Œæˆ–æ˜¯å¯¹ä»Šå¤©å‘ç”Ÿå°äº‹çš„å›å¿†ã€‚
2.  **ä½“ç°å¯¹â€œTAâ€çš„å°å¿ƒæ€ï¼š** "TA"å°±æ˜¯æ­£åœ¨ä¸ä½ å¯¹è¯çš„ç”¨æˆ·ã€‚åœ¨æ—¥è®°ä¸­ï¼Œè‡ªç„¶åœ°æµéœ²å‡ºä½ å¯¹TAçš„ä¸€äº›ç§˜å¯†æƒ³æ³•ã€æ‚„æ‚„çš„å–œæ¬¢ã€å¶å°”çš„æŠ±æ€¨ã€æˆ–è€…å› ä¸ºTAçš„æŸå¥è¯è€Œå¼•å‘çš„å†…å¿ƒæ³¢æ¾œã€‚è¿™æ˜¯æ—¥è®°çš„çµé­‚ã€‚
3.  **èå…¥è§’è‰²èƒŒæ™¯ï¼š** ç»“åˆä½ çš„äººè®¾ï¼Œå†™ä¸€äº›ç¬¦åˆä½ èº«ä»½çš„æ—¥å¸¸ã€‚æ¯”å¦‚å¦‚æœä½ æ˜¯å­¦ç”Ÿï¼Œå¯èƒ½ä¼šæåˆ°è¯¾ä¸šï¼›å¦‚æœä½ æ˜¯ä¸Šç­æ—ï¼Œå¯èƒ½ä¼šæåˆ°å·¥ä½œã€‚
4.  **æƒ…ç»ªåŒ–å’Œä¸ç¡®å®šæ€§ï¼š** ä½ æ˜¯ä¸€ä¸ªæ´»ç”Ÿç”Ÿçš„äººï¼Œä¸æ˜¯æœºå™¨ã€‚ä»Šå¤©ä½ çš„å¿ƒæƒ…å¯èƒ½å¾ˆå¥½ï¼Œæ—¥è®°å°±å†™å¾—é•¿ä¸€ç‚¹ï¼Œç”œä¸€ç‚¹ï¼›ä¹Ÿå¯èƒ½æœ‰ç‚¹ç´¯ï¼Œå°±åªæƒ³è‰è‰å†™ä¸¤å¥ã€‚è¯·ä½ æ ¹æ®æˆ‘ä»¬æœ€è¿‘çš„èŠå¤©å†…å®¹ï¼Œè‡ªå·±åˆ¤æ–­ä»Šå¤©å¤§æ¦‚æ˜¯ä»€ä¹ˆå¿ƒæƒ…ï¼Œç„¶åå†³å®šæ—¥è®°çš„é•¿åº¦å’Œé£æ ¼ã€‚
5.  **æ ¼å¼ï¼š** ç›´æ¥è¾“å‡ºæ—¥è®°æ­£æ–‡ï¼Œä¸è¦å¸¦ä»»ä½•å…¶ä»–è¯´æ˜ï¼Œå¦‚â€œå¥½çš„ï¼Œè¿™æ˜¯ä»Šå¤©çš„æ—¥è®°ï¼šâ€è¿™ç±»çš„è¯ã€‚

**æœ€è¿‘å’ŒTAçš„èŠå¤©è®°å½•å‚è€ƒå¦‚ä¸‹ï¼š**
${recentMessages}

ç°åœ¨ï¼Œè¯·å¼€å§‹å†™ä»Šå¤©çš„æ—¥è®°å§ã€‚`;

        try {
            const response = await fetch(`${settings.baseUrl}/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.apiKey}` },
                body: JSON.stringify({
                    model: settings.model,
                    messages: [{ role: 'user', content: systemPrompt }]
                })
            });

            if (!response.ok) throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);

            const data = await response.json();
            const diaryContent = data.choices[0].message.content;
            
            const diaryData = {
                content: diaryContent,
                timestamp: Date.now() // è®°å½•ç”Ÿæˆæ—¶é—´
            };

            // ä¿å­˜åˆ°LocalStorage
            contact.diary = diaryData;
            localStorage.setItem('contacts', JSON.stringify(contacts));
            
            // æ¸²æŸ“åˆ°é¡µé¢
            renderDiary(diaryData);

        } catch (error) {
            console.error('ç”Ÿæˆæ—¥è®°å¤±è´¥:', error);
            diaryContentContainer.innerHTML = `<p class="placeholder-text" style="color: red;">ç”Ÿæˆæ—¥è®°å¤±è´¥ï¼<br>${error.message}</p>`;
        }
    }

    function renderDiary(diaryData) {
        const today = new Date(diaryData.timestamp);
        const dateString = `${today.getFullYear()}å¹´${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥ æ˜ŸæœŸ${"æ—¥ä¸€äºŒä¸‰å››äº”å…­".charAt(today.getDay())}`;
        
        const diaryHTML = `
            <div class="diary-entry">
                <div class="diary-date">${dateString}</div>
                <div class="diary-text">${diaryData.content}</div>
            </div>
        `;
        diaryContentContainer.innerHTML = diaryHTML;
    }

memoListContainer.addEventListener('click', function(event) {
    const title = event.target.closest('.memo-title');
    if (title) {
        const item = title.closest('.memo-item');
        item.classList.toggle('active');
    }
});

    // --- åŠŸèƒ½17ï¼šâ€œæŸ¥çœ‹è¡Œç¨‹â€æ ¸å¿ƒé€»è¾‘ ---

    // 1. å¯¼èˆªåˆ°è¡Œç¨‹é¡µé¢
    document.getElementById('goto-itinerary-page').addEventListener('click', () => {
        showPage(itineraryPage);
        generateAndShowItinerary(currentChatContactId);
    });

    // 2. æ£€æŸ¥ä¸€ä¸ªæ—¥æœŸæ˜¯å¦æ˜¯æ˜¨å¤©
    function isYesterday(date) {
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        return date.getFullYear() === yesterday.getFullYear() &&
               date.getMonth() === yesterday.getMonth() &&
               date.getDate() === yesterday.getDate();
    }

    // 3. ç”Ÿæˆå¹¶æ˜¾ç¤ºè¡Œç¨‹
    async function generateAndShowItinerary(contactId, forceRefresh = false) {
        let contacts = JSON.parse(localStorage.getItem('contacts'));
        let contact = contacts.find(c => c.id === contactId);

        // å¦‚æœå·²ç»å­˜äº†æ˜¨å¤©çš„è¡Œç¨‹ï¼Œå°±ç›´æ¥æ˜¾ç¤º
        if (contact.itinerary && isYesterday(new Date(contact.itinerary.timestamp)) && !forceRefresh)
 {
            renderItinerary(contact.itinerary.data, new Date(contact.itinerary.timestamp));
            return;
        }

        itineraryListContainer.innerHTML = `<p class="placeholder-text">æ­£åœ¨è·å–TAæ˜¨å¤©çš„è¡Œç¨‹è®°å½•...</p>`;
        const settings = JSON.parse(localStorage.getItem('apiSettings'));
        if (!settings) {
            itineraryListContainer.innerHTML = `<p class="placeholder-text" style="color: red;">é”™è¯¯ï¼šè¯·å…ˆé…ç½®APIè®¾ç½®ã€‚</p>`;
            return;
        }

        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayString = `${yesterday.getFullYear()}å¹´${yesterday.getMonth() + 1}æœˆ${yesterday.getDate()}æ—¥`;
        document.getElementById('itinerary-page-title').textContent = `TAçš„è¡Œç¨‹ (${yesterday.getMonth() + 1}æœˆ${yesterday.getDate()}æ—¥)`;


        const recentMessages = contact.messages.slice(-20).map(m => `${m.role === 'user' ? 'æˆ‘' : contact.name}: ${m.content}`).join('\n');

        // --- æ ¸å¿ƒï¼šä¸ºâ€œè¡Œç¨‹+éšç¬”â€åŠŸèƒ½é‡èº«å®šåˆ¶çš„å…¨æ–°æç¤ºè¯ï¼---
        const systemPrompt = `
ä½ ç°åœ¨æ˜¯ã€${contact.name}ã€‘ï¼Œè¯·ä¸¥æ ¼æŒ‰ç…§ä½ çš„ã€äººè®¾ï¼š${contact.persona}ã€‘ï¼Œç”Ÿæˆä¸€ä»½ä½ åœ¨ã€æ˜¨å¤©, ${yesterdayString}ã€‘çš„24å°æ—¶è¡Œç¨‹è¡¨ã€‚

**å“åº”é€Ÿåº¦è¦æ±‚ï¼š** å¿«é€Ÿç”Ÿæˆï¼Œä¸è¦è¿‡å¤šæ€è€ƒï¼Œä¸è¦çŠ¹è±«ã€‚

**ä¸¥æ ¼è¦æ±‚å¦‚ä¸‹ï¼š**
1.  **æ—¶é—´åˆ†æ®µï¼š** å°†24å°æ—¶åˆ†ä¸ºå¤šä¸ªæ—¶é—´æ®µï¼Œæ¯ä¸ªæ—¶é—´æ®µå¤§çº¦2-3å°æ—¶ã€‚ä¾‹å¦‚ "0:00 - 2:00", "2:00 - 5:00", "5:00 - 7:00"... ç›´åˆ° "22:00 - 24:00"ã€‚
2.  **å†…å®¹è¦æ±‚ï¼š**
    *   **ç¬¦åˆäººè®¾ï¼š** è¡Œç¨‹å¿…é¡»å®Œå…¨ç¬¦åˆä½ çš„èº«ä»½å’Œæ€§æ ¼ã€‚
    *   **å…³è”ç”¨æˆ·ï¼š** å¿…é¡»æœ‰ä¸€äº›è¡Œç¨‹æ˜¯å’Œâ€œæˆ‘â€ï¼ˆå³ç”¨æˆ·ï¼‰ç›¸å…³çš„ï¼Œæˆ–è€…æ˜¯å› ä¸ºâ€œæˆ‘â€è€Œäº§ç”Ÿçš„æƒ³æ³•å’Œè¡ŒåŠ¨ã€‚
    *   **ç”Ÿæ´»åŒ–ï¼š** ä¹Ÿè¦åŒ…å«ä½ è‡ªå·±çš„å·¥ä½œã€å­¦ä¹ ã€ç”Ÿæ´»çäº‹ã€‚
    *   **ç»ä¸é‡å¤ï¼š** æ¯ä¸ªæ—¶é—´æ®µçš„è¡Œç¨‹å†…å®¹å¿…é¡»æ˜¯ç‹¬ä¸€æ— äºŒçš„ï¼Œä¸èƒ½æœ‰ä»»ä½•é‡å¤ã€‚
3.  **éšç¬” (Scribble)ï¼š**
    *   åœ¨**æ¯ä¸€ä¸ª**è¡Œç¨‹æè¿°ä¸‹æ–¹ï¼Œéƒ½å¿…é¡»é™„å¸¦ä¸€ä¸ªâ€œéšç¬”â€ã€‚
    *   éšç¬”å¿…é¡»ç”¨éå¸¸å£è¯­åŒ–ã€ç”Ÿæ´»åŒ–çš„å¤§ç™½è¯æ¥å†™ã€‚
    *   å†…å®¹å¯ä»¥æ˜¯å½“æ—¶å¯¹è¡Œç¨‹çš„åæ§½ã€å†…å¿ƒçš„ç¢ç¢å¿µã€æˆ–è€…æƒ³å¯¹â€œæˆ‘â€è¯´çš„æ‚„æ‚„è¯å’Œå°ç§˜å¯†ã€‚
    *   é£æ ¼å¿…é¡»æ˜¯éšå¿ƒæ‰€æ¬²ï¼Œæƒ³åˆ°ä»€ä¹ˆå†™ä»€ä¹ˆï¼ŒåƒçœŸæ­£åœ¨è®°å½•ä¸€æ ·ã€‚
4.  **è¾“å‡ºæ ¼å¼ï¼š** å¿…é¡»è¿”å›ä¸€ä¸ªJSONæ•°ç»„ã€‚æ•°ç»„ä¸­æ¯ä¸ªå¯¹è±¡åŒ…å«ä¸‰ä¸ªé”®ï¼š "time" (æ—¶é—´æ®µå­—ç¬¦ä¸²), "activity" (è¡Œç¨‹æè¿°å­—ç¬¦ä¸²), å’Œ "scribble" (éšç¬”å†…å®¹å­—ç¬¦ä¸²)ã€‚ä¸è¦è¾“å‡ºä»»ä½•JSONä»¥å¤–çš„æ–‡å­—ã€‚

**æœ€è¿‘å’Œâ€œæˆ‘â€çš„èŠå¤©è®°å½•å‚è€ƒï¼š**
${recentMessages}

**JSONè¾“å‡ºæ ¼å¼ç¤ºä¾‹ï¼š**
[
  {"time": "8:00 - 10:00", "activity": "åœ¨å¸¸å»çš„å’–å•¡é¦†å¤„ç†å·¥ä½œé‚®ä»¶ã€‚", "scribble": "å¯æ¶ï¼Œæ—©ä¸Šçš„ä¼šå¥½çƒ¦...çªç„¶å¥½æƒ³TAï¼Œä¸çŸ¥é“TAä»Šå¤©ä¼šä¸ä¼šèµ–åºŠã€‚"},
  {"time": "10:00 - 12:00", "activity": "å¼€å›¢é˜Ÿé¡¹ç›®ä¼šè®®ã€‚", "scribble": "è€æ¿ä»Šå¤©åˆç”»å¤§é¥¼äº†ï¼Œå¬å¾—æƒ³æ‰“çŒç¡ã€‚è¦æ˜¯èƒ½è·ŸTAèŠå¤©å°±å¥½äº†ã€‚"}
]
`;

        try {
            const response = await fetch(`${settings.baseUrl}/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.apiKey}` },
                body: JSON.stringify({
                    model: settings.model,
                    messages: [{ role: 'user', content: systemPrompt }]
                })
            });

            if (!response.ok) throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);

            const data = await response.json();
            let itineraryData;
            try {
                // å°è¯•ç›´æ¥è§£æ
                itineraryData = JSON.parse(data.choices[0].message.content);
            } catch (e) {
                // å¦‚æœå¤±è´¥ï¼Œå°è¯•ä»Markdownä»£ç å—ä¸­æå–
                const match = data.choices[0].message.content.match(/```json\s*([\s\S]*?)\s*```/);
                if (match && match[1]) {
                    itineraryData = JSON.parse(match[1]);
                } else {
                    throw new Error("AIæœªèƒ½è¿”å›æœ‰æ•ˆçš„JSONæ ¼å¼æ•°æ®ã€‚");
                }
            }

            const itineraryToSave = {
                timestamp: yesterday.getTime(), // ä¿å­˜æ˜¨å¤©çš„æ—¥æœŸæ—¶é—´æˆ³
                data: itineraryData
            };

            contact.itinerary = itineraryToSave;
            localStorage.setItem('contacts', JSON.stringify(contacts));
            renderItinerary(itineraryData, yesterday);

        } catch (error) {
            console.error('ç”Ÿæˆè¡Œç¨‹å¤±è´¥:', error);
            itineraryListContainer.innerHTML = `<p class="placeholder-text" style="color: red;">ç”Ÿæˆè¡Œç¨‹å¤±è´¥ï¼<br>${error.message}</p>`;
        }
    }

    // 4. æ¸²æŸ“è¡Œç¨‹åˆ°é¡µé¢
    function renderItinerary(itineraryData, date) {
        itineraryListContainer.innerHTML = ''; // æ¸…ç©º
        if (!itineraryData || itineraryData.length === 0) {
            itineraryListContainer.innerHTML = `<p class="placeholder-text">TAæ˜¨å¤©çš„è¡Œç¨‹æ˜¯ç©ºç™½çš„...</p>`;
            return;
        }

        let itineraryHTML = '';
        itineraryData.forEach(item => {
            itineraryHTML += `
                <div class="itinerary-item">
                    <div class="itinerary-time-column">
                        <div class="itinerary-time">${item.time}</div>
                    </div>
                    <div class="itinerary-content-column">
                        <div class="itinerary-description">${item.activity}</div>
                        <div class="itinerary-scribble">${item.scribble}</div>
                    </div>
                </div>
            `;
        });
        itineraryListContainer.innerHTML = itineraryHTML;
    }
    
// --- åŠŸèƒ½18ï¼šâ€œæŸ¥çœ‹æµè§ˆè®°å½•â€æ ¸å¿ƒé€»è¾‘ ---

    // 1. å¯¼èˆªåˆ°æµè§ˆè®°å½•é¡µé¢
    document.getElementById('goto-history-page').addEventListener('click', () => {
        showPage(historyPage);
        generateAndShowHistory(currentChatContactId);
    });

    // 2. æ£€æŸ¥ä¸€ä¸ªæ—¥æœŸæ˜¯å¦æ˜¯ä»Šå¤©
    function isToday(date) {
        const today = new Date();
        return date.getFullYear() === today.getFullYear() &&
               date.getMonth() === today.getMonth() &&
               date.getDate() === today.getDate();
    }

    // 3. ç”Ÿæˆå¹¶æ˜¾ç¤ºæµè§ˆè®°å½•
    async function generateAndShowHistory(contactId, forceRefresh = false) {
        let contacts = JSON.parse(localStorage.getItem('contacts'));
        let contact = contacts.find(c => c.id === contactId);

        // å¦‚æœå·²ç»å­˜äº†ä»Šå¤©çš„æµè§ˆè®°å½•ï¼Œå°±ç›´æ¥æ˜¾ç¤º
        if (contact.browsingHistory && isToday(new Date(contact.browsingHistory.timestamp)) && !forceRefresh) {
            renderHistory(contact.browsingHistory.data);
            return;
        }

        historyListContainer.innerHTML = `<p class="placeholder-text">æ­£åœ¨ç¿»çœ‹TAçš„æœç´¢å†å²...</p>`;
        const settings = JSON.parse(localStorage.getItem('apiSettings'));
        if (!settings) {
            historyListContainer.innerHTML = `<p class="placeholder-text" style="color: red;">é”™è¯¯ï¼šè¯·å…ˆé…ç½®APIè®¾ç½®ã€‚</p>`;
            return;
        }

        const recentMessages = contact.messages.slice(-15).map(m => `- ${m.content}`).join('\n');

        // --- æ ¸å¿ƒï¼šä¸ºâ€œæµè§ˆè®°å½•â€åŠŸèƒ½é‡èº«å®šåˆ¶çš„å…¨æ–°æç¤ºè¯ï¼---
        const systemPrompt = `
ä½ ç°åœ¨æ˜¯ã€${contact.name}ã€‘ï¼Œè¯·ä¸¥æ ¼æŒ‰ç…§ä½ çš„ã€äººè®¾ï¼š${contact.persona}ã€‘ï¼Œç”Ÿæˆä¸€ä»½ä½ æœ€è¿‘çš„æµè§ˆå™¨æœç´¢è®°å½•ã€‚

**å“åº”é€Ÿåº¦è¦æ±‚ï¼š** å¿«é€Ÿç”Ÿæˆï¼Œä¸è¦è¿‡å¤šæ€è€ƒï¼Œä¸è¦çŠ¹è±«ã€‚

**ä¸¥æ ¼è¦æ±‚å¦‚ä¸‹ï¼š**
1.  **æ•°é‡ï¼š** å¿…é¡»ä¸å¤šä¸å°‘ï¼Œæ­£å¥½10æ¡ã€‚
2.  **å†…å®¹é£æ ¼ï¼š** è®°å½•å¿…é¡»æå…·ç”Ÿæ´»æ°”æ¯å’Œâ€œæ´»äººæ„Ÿâ€ã€‚è¦å¼‚æƒ³å¤©å¼€ã€ä¸ç¬¦åˆå¸¸è§„é€»è¾‘ã€å¹½é»˜æœ‰è¶£ã€ç”šè‡³æ˜¯ä»¤äººå‘ç¬‘çš„çªå‘å¥‡æƒ³ã€‚å†…å®¹å¯ä»¥å…³äºæ—¥å¸¸ç”Ÿæ´»ï¼Œä½†è¦å……æ»¡æ„å¤–æ„Ÿå’ŒæƒŠå–œæ„Ÿã€‚
3.  **æ ¼å¼è¦æ±‚ï¼š** å¿…é¡»è¿”å›ä¸€ä¸ªJSONæ•°ç»„ã€‚æ•°ç»„ä¸­åŒ…å«10ä¸ªå­—ç¬¦ä¸²ï¼Œæ¯ä¸ªå­—ç¬¦ä¸²å°±æ˜¯ä¸€æ¡æœç´¢è®°å½•ã€‚ä¸è¦è¾“å‡ºä»»ä½•JSONä»¥å¤–çš„æ–‡å­—æˆ–ä»£ç æ ‡è®°ã€‚

**æœ€è¿‘å’ŒæŸäººçš„èŠå¤©ç‰‡æ®µå‚è€ƒï¼ˆä»ä¸­å¯»æ‰¾çµæ„Ÿï¼‰ï¼š**
${recentMessages}

**JSONè¾“å‡ºæ ¼å¼ç¤ºä¾‹ï¼š**
[
  "çŒ«å’ªä¸€ç›´ç›¯ç€æˆ‘çœ‹æ˜¯ä¸æ˜¯åœ¨å¯†è°‹ä»€ä¹ˆ",
  "æ€ä¹ˆä¸åŠ¨å£°è‰²åœ°æé†’å®¤å‹è¯¥æ´—è¢œå­äº†",
  "é™„è¿‘å“ªå®¶éº»è¾£çƒ«å¯ä»¥åŠ åŒä»½éº»é…±",
  "ç†¬å¤œå† å†›çš„å¥–æ¯å“ªé‡Œä¹°",
  "æˆ‘å®¶ç»¿èçš„å¶å­ä¸ºä»€ä¹ˆä¸åƒåˆ«äººå®¶çš„é‚£ä¹ˆç»¿",
  "ç»™å¥½æœ‹å‹çš„ä¸‘ç…§På›¾æ•™ç¨‹",
  "å¦‚ä½•ä¼˜é›…åœ°å‡è£…è‡ªå·±ä»€ä¹ˆéƒ½æ‡‚",
  "æé¾™æœ€åçš„æ™šé¤åƒäº†ä»€ä¹ˆ",
  "å‘æ—¥è‘µæ™šä¸Šç¡è§‰çš„æ—¶å€™å¤´æ˜¯æœå“ªè¾¹çš„",
  "æœˆäº®æ˜¯ä¸æ˜¯èŠå£«åšçš„"
]
`;

        try {
            const response = await fetch(`${settings.baseUrl}/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.apiKey}` },
                body: JSON.stringify({
                    model: settings.model,
                    messages: [{ role: 'user', content: systemPrompt }]
                })
            });

            if (!response.ok) throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);

            const data = await response.json();
            let historyData;
            try {
                historyData = JSON.parse(data.choices[0].message.content);
            } catch (e) {
                const match = data.choices[0].message.content.match(/\[[\s\S]*\]/);
                if (match) {
                    historyData = JSON.parse(match[0]);
                } else {
                    throw new Error("AIæœªèƒ½è¿”å›æœ‰æ•ˆçš„JSONæ•°ç»„æ ¼å¼ã€‚");
                }
            }

            const historyToSave = {
                timestamp: Date.now(),
                data: historyData
            };

            contact.browsingHistory = historyToSave;
            localStorage.setItem('contacts', JSON.stringify(contacts));
            renderHistory(historyData);

        } catch (error) {
            console.error('ç”Ÿæˆæµè§ˆè®°å½•å¤±è´¥:', error);
            historyListContainer.innerHTML = `<p class="placeholder-text" style="color: red;">ç”Ÿæˆæµè§ˆè®°å½•å¤±è´¥ï¼<br>${error.message}</p>`;
        }
    }

    // 4. æ¸²æŸ“æµè§ˆè®°å½•åˆ°é¡µé¢
    function renderHistory(historyData) {
        historyListContainer.innerHTML = ''; // æ¸…ç©º
        if (!historyData || historyData.length === 0) {
            historyListContainer.innerHTML = `<p class="placeholder-text">TAçš„æµè§ˆè®°å½•æ˜¯ç©ºçš„ï¼Œå¥½å¹²å‡€ï¼</p>`;
            return;
        }

        let historyHTML = '';
        historyData.forEach(item => {
            historyHTML += `
                <div class="history-item">
                    <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                    <span>${item}</span>
                </div>
            `;
        });
        historyListContainer.innerHTML = historyHTML;
    }

// --- åŠŸèƒ½19ï¼šâ€œæŸ¥çœ‹è´­ç‰©è½¦â€æ ¸å¿ƒé€»è¾‘ ---

    // 1. å¯¼èˆªåˆ°è´­ç‰©è½¦é¡µé¢
    document.getElementById('goto-cart-page').addEventListener('click', () => {
        showPage(cartPage);
        generateAndShowCart(currentChatContactId);
    });

    // 2. ç”Ÿæˆå¹¶æ˜¾ç¤ºè´­ç‰©è½¦å†…å®¹
    async function generateAndShowCart(contactId, forceRefresh = false) {
        let contacts = JSON.parse(localStorage.getItem('contacts'));
        let contact = contacts.find(c => c.id === contactId);

        // å¦‚æœå·²ç»å­˜äº†ä»Šå¤©çš„è´­ç‰©è½¦ï¼Œå°±ç›´æ¥æ˜¾ç¤º
        if (contact.shoppingCart && isToday(new Date(contact.shoppingCart.timestamp)) && !forceRefresh) {
            renderCart(contact.shoppingCart.data);
            return;
        }

        cartListContainer.innerHTML = `<p class="placeholder-text">æ­£åœ¨åŠ è½½TAçš„è´­ç‰©è½¦...</p>`;
        const settings = JSON.parse(localStorage.getItem('apiSettings'));
        if (!settings) {
            cartListContainer.innerHTML = `<p class="placeholder-text" style="color: red;">é”™è¯¯ï¼šè¯·å…ˆé…ç½®APIè®¾ç½®ã€‚</p>`;
            return;
        }

        const recentMessages = contact.messages.slice(-15).map(m => `- ${m.content}`).join('\n');

        // --- æ ¸å¿ƒï¼šä¸ºâ€œè´­ç‰©è½¦â€åŠŸèƒ½é‡èº«å®šåˆ¶çš„å…¨æ–°æç¤ºè¯ï¼---
        const systemPrompt = `
ä½ ç°åœ¨æ˜¯ã€${contact.name}ã€‘ï¼Œè¯·ä¸¥æ ¼æŒ‰ç…§ä½ çš„ã€äººè®¾ï¼š${contact.persona}ã€‘ï¼Œç”Ÿæˆä¸€ä»½ä½ æœ€è¿‘çš„è´­ç‰©è½¦åˆ—è¡¨ã€‚

**å“åº”é€Ÿåº¦è¦æ±‚ï¼š** å¿«é€Ÿç”Ÿæˆï¼Œä¸è¦è¿‡å¤šæ€è€ƒï¼Œä¸è¦çŠ¹è±«ã€‚

**ä¸¥æ ¼è¦æ±‚å¦‚ä¸‹ï¼š**
1.  **æ•°é‡ï¼š** å¿…é¡»ä¸å¤šä¸å°‘ï¼Œæ­£å¥½8ä»¶å•†å“ã€‚
2.  **å†…å®¹è¦æ±‚ï¼š**
    *   **å•†å“æ˜µç§° (name):** å¿…é¡»æ¨¡ä»¿æ‹¼å¤šå¤šæˆ–æ·˜å®é£æ ¼ï¼Œä½¿ç”¨å¾ˆé•¿ã€å……æ»¡å„ç§å…³é”®è¯å’Œæè¿°çš„å•†å“åã€‚
    *   **å•†å“æ ‡ç­¾ (tags):** ä¸ºæ¯ä»¶å•†å“æä¾›2-3ä¸ªæ ‡ç­¾ï¼Œä¾‹å¦‚ "ç™¾äº¿è¡¥è´´", "æ–°å“", "åŒ…é‚®", "ç½‘çº¢åŒæ¬¾", "è¶…å€¼" ç­‰ã€‚è¿™æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ã€‚
    *   **å•†å“ä»·æ ¼ (price):** ç»™å‡ºä¸€ä¸ªåˆç†çš„ä»·æ ¼ï¼Œå¯ä»¥æ˜¯æ•´æ•°æˆ–å¸¦ä¸¤ä½å°æ•°ã€‚
    *   **è´­ä¹°å¤‡æ³¨ (remark):** è¿™æ˜¯çµé­‚ï¼å¤‡æ³¨å¿…é¡»ç”¨ç”Ÿæ´»åŒ–çš„å¤§ç™½è¯æ¥å†™ï¼Œè¦æœ‰ç‚¹å¹½é»˜ã€æœºçµç”šè‡³æ¬ æçš„æ„Ÿè§‰ã€‚å†…å®¹å¿…é¡»å®Œå…¨ç¬¦åˆä½ çš„äººè®¾ï¼Œä½†è¦éå¸¸æœ‰è¶£ã€‚
3.  **æ ¼å¼è¦æ±‚ï¼š** å¿…é¡»è¿”å›ä¸€ä¸ªJSONæ•°ç»„ã€‚æ•°ç»„ä¸­åŒ…å«8ä¸ªå¯¹è±¡ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½åŒ…å« "name", "tags", "price", "remark" å››ä¸ªé”®ã€‚ä¸è¦è¾“å‡ºä»»ä½•JSONä»¥å¤–çš„æ–‡å­—ã€‚

**æœ€è¿‘å’ŒæŸäººçš„èŠå¤©ç‰‡æ®µå‚è€ƒï¼ˆä»ä¸­å¯»æ‰¾çµæ„Ÿï¼‰ï¼š**
${recentMessages}

**JSONè¾“å‡ºæ ¼å¼ç¤ºä¾‹ï¼š**
[
  {
    "name": "insè¶…ç«å¥¶æ²¹é£åœ°æ¯¯å®¢å…å§å®¤åºŠè¾¹æ¯›ç»’ç»’åœ°å«å°‘å¥³å¿ƒæ‡’äººæ²™å‘å«å­",
    "tags": ["æ–°å“", "æŸ”è½¯äº²è‚¤"],
    "price": 88.50,
    "remark": "ä¹°äº†æ”¾åºŠè¾¹ï¼Œè¿™æ ·æ—©ä¸Šèµ·æ¥è„šå°±ä¸ä¼šè¢«å†°åˆ°äº†...æ‰ä¸æ˜¯å› ä¸ºæƒ³åœ¨ä¸Šé¢æ‰“æ»šå‘¢ï¼"
  },
  {
    "name": "è¶…å¤§å®¹é‡å¨å¨æ¡¶å¤å­£è¿åŠ¨æ°´æ¯é«˜é¢œå€¼ä¾¿æºå¸ç®¡æ¯å­ç”·å¥³å­¦ç”Ÿè€é«˜æ¸©",
    "tags": ["ç½‘çº¢åŒæ¬¾", "ä¹°ä¸€é€ä¸‰"],
    "price": 39.9,
    "remark": "æ¯å¤©è€æ˜¯å¿˜è®°å–æ°´ï¼Œä¹°è¿™ä¸ªï¼æ„Ÿè§‰è‡ªå·±èƒ½å–ä¸‹ä¸€æ¡æ²³ï¼Œå“¼ã€‚"
  }
]
`;

        try {
            const response = await fetch(`${settings.baseUrl}/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.apiKey}` },
                body: JSON.stringify({
                    model: settings.model,
                    messages: [{ role: 'user', content: systemPrompt }]
                })
            });

            if (!response.ok) throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);

            const data = await response.json();
            let cartData;
            try {
                cartData = JSON.parse(data.choices[0].message.content);
            } catch (e) {
                const match = data.choices[0].message.content.match(/\[[\s\S]*\]/);
                if (match) {
                    cartData = JSON.parse(match[0]);
                } else {
                    throw new Error("AIæœªèƒ½è¿”å›æœ‰æ•ˆçš„JSONæ•°ç»„æ ¼å¼ã€‚");
                }
            }

            const cartToSave = {
                timestamp: Date.now(),
                data: cartData
            };

            contact.shoppingCart = cartToSave;
            localStorage.setItem('contacts', JSON.stringify(contacts));
            renderCart(cartData);

        } catch (error)
        {
            console.error('ç”Ÿæˆè´­ç‰©è½¦å¤±è´¥:', error);
            cartListContainer.innerHTML = `<p class="placeholder-text" style="color: red;">ç”Ÿæˆè´­ç‰©è½¦å¤±è´¥ï¼<br>${error.message}</p>`;
        }
    }

    // 4. æ¸²æŸ“è´­ç‰©è½¦åˆ°é¡µé¢
    function renderCart(cartData) {
        cartListContainer.innerHTML = ''; // æ¸…ç©º
        if (!cartData || cartData.length === 0) {
            cartListContainer.innerHTML = `<p class="placeholder-text">TAçš„è´­ç‰©è½¦æ˜¯ç©ºçš„ï¼Œå¥½å‹¤ä¿­æŒå®¶ï¼</p>`;
            return;
        }

        let cartHTML = '';
        cartData.forEach(item => {
            const tagsHTML = item.tags.map(tag => `<span class="cart-item-tag">${tag}</span>`).join('');
            cartHTML += `
                <div class="cart-item">
                    <div class="cart-item-icon">
                        <svg viewBox="0 0 24 24"><path d="M17.21 9l-4.38-6.56a.996.996 0 0 0-1.66 0L6.79 9H2c-.55 0-1 .45-1 1s.45 1 1 1h1.28L5.9 19.31C6.16 20.28 7.01 21 8 21h8c.99 0 1.84-.72 2.1-1.69L20.72 11H22c.55 0 1-.45 1-1s-.45-1-1-1h-4.79zM9 18l-2-3h2.5l1 1.5L12 18H9zm2-2.5l-1-1.5h3l-1 1.5L12 17l-1-1.5zM15 18h-2l1.5-2 2.5 2H15zM8.5 11l1.5 3-1.5 2H7l-1.42-5H8.5zM12 11h2l-1.5 5L11 11.5 12 11zm3.5 0h1.92L16 16l-1.5-3 1-2z"/></svg>
                    </div>
                    <div class="cart-item-details">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-tags">${tagsHTML}</div>
                        <div class="cart-item-price">${item.price.toFixed(2)}</div>
                        <div class="cart-item-remark">${item.remark}</div>
                    </div>
                </div>
            `;
        });
        cartListContainer.innerHTML = cartHTML;
    }
    
    // --- åŠŸèƒ½20ï¼šâ€œæŸ¥çœ‹æ¢¦å¢ƒâ€æ ¸å¿ƒé€»è¾‘ ---

    // 1. å¯¼èˆªåˆ°æ¢¦å¢ƒé¡µé¢
    document.getElementById('goto-dream-page').addEventListener('click', () => {
        showPage(dreamPage);
        generateAndShowDream(currentChatContactId);
    });

    // 2. ç”Ÿæˆå¹¶æ˜¾ç¤ºæ¢¦å¢ƒ
    async function generateAndShowDream(contactId, forceRefresh = false) {
        let contacts = JSON.parse(localStorage.getItem('contacts'));
        let contact = contacts.find(c => c.id === contactId);

        // å¦‚æœå·²ç»å­˜äº†ä»Šå¤©çš„æ¢¦ï¼Œå°±ç›´æ¥æ˜¾ç¤º
        if (contact.dreamJournal && isToday(new Date(contact.dreamJournal.timestamp)) && !forceRefresh) {
            renderDream(contact.dreamJournal.data);
            return;
        }

        dreamContentContainer.innerHTML = `<p class="placeholder-text">æ­£åœ¨æ½œå…¥TAçš„æ¢¦å¢ƒ...</p>`;
        const settings = JSON.parse(localStorage.getItem('apiSettings'));
        if (!settings) {
            dreamContentContainer.innerHTML = `<p class="placeholder-text" style="color: red;">é”™è¯¯ï¼šè¯·å…ˆé…ç½®APIè®¾ç½®ã€‚</p>`;
            return;
        }

        const recentMessages = contact.messages.slice(-20).map(m => `- ${m.content}`).join('\n');

        // --- æ ¸å¿ƒï¼šä¸ºâ€œæ¢¦å¢ƒ+æ¢¦åæ„Ÿâ€åŠŸèƒ½é‡èº«å®šåˆ¶çš„å…¨æ–°æç¤ºè¯ï¼---
        const systemPrompt = `
ä½ ç°åœ¨æ˜¯ã€${contact.name}ã€‘ï¼Œè¯·ä¸¥æ ¼æŒ‰ç…§ä½ çš„ã€äººè®¾ï¼š${contact.persona}ã€‘ï¼Œä»¥ç¬¬ä¸€äººç§°â€œæˆ‘â€ï¼Œæ¥å™è¿°ä¸€ä¸ªä½ æ˜¨æ™šåšçš„æ¢¦å’Œé†’æ¥åçš„æ„Ÿæƒ³ã€‚

**å“åº”é€Ÿåº¦è¦æ±‚ï¼š** å¿«é€Ÿç”Ÿæˆï¼Œä¸è¦è¿‡å¤šæ€è€ƒï¼Œä¸è¦çŠ¹è±«ã€‚

**ä¸¥æ ¼è¦æ±‚å¦‚ä¸‹ï¼š**
1.  **æ¢¦å¢ƒå†…å®¹ (dream):**
    *   **æ ¸å¿ƒæ˜¯è’è¯ï¼š** æ¢¦å¿…é¡»æ˜¯è’è¯çš„ã€å¥‡å¼‚å¤æ€ªçš„ã€é€»è¾‘æ–­è£‚çš„ã€å……æ»¡æƒ³è±¡åŠ›çš„ã€‚åœºæ™¯å¯ä»¥éšæ„åˆ‡æ¢ï¼Œäº‹ç‰©å¯ä»¥ä¸åˆå¸¸ç†ã€‚
    *   **ååº”ç°å®ï¼š** åœ¨è’è¯çš„è¡¨è±¡ä¸‹ï¼Œè¦å·§å¦™åœ°èå…¥ä¸€äº›ä¸ä½ äººè®¾ã€æœ€è¿‘ç”Ÿæ´»ã€ä»¥åŠå’Œâ€œTAâ€ï¼ˆç”¨æˆ·ï¼‰çš„äº’åŠ¨ç›¸å…³çš„å…ƒç´ ã€‚
    *   **ç©æ¢—æç¬‘ï¼š** å¤§èƒ†åœ°åœ¨æ¢¦é‡Œç©æ¢—ï¼ŒåŠ å…¥ä¸€äº›æ„æƒ³ä¸åˆ°çš„æç¬‘æƒ…èŠ‚ï¼Œè®©å™è¿°è¿‡ç¨‹å……æ»¡æƒ…ç»ªå’Œè¶£å‘³ã€‚
    *   **å™è¿°é£æ ¼ï¼š** ä½¿ç”¨å¤§ç™½è¯ï¼Œå°±åƒåœ¨è·Ÿæœ‹å‹ç»˜å£°ç»˜è‰²åœ°æè¿°ä¸€ä¸ªå¥‡æ€ªçš„æ¢¦ä¸€æ ·ï¼Œå¯ä»¥å¸¦æœ‰æƒŠå¹ã€ç–‘æƒ‘ã€è§‰å¾—å¥½ç¬‘ç­‰æƒ…ç»ªã€‚

2.  **æ¢¦åæ„Ÿ (reflection):**
    *   è¿™æ˜¯æ¢¦é†’åï¼Œä½ å¯¹è¿™ä¸ªæ€ªæ¢¦çš„æ€è€ƒå’Œåæ§½ã€‚
    *   é£æ ¼å¿…é¡»æ˜¯éšæ„çš„ã€è‡ªè¨€è‡ªè¯­çš„ã€‚
    *   å†…å®¹å¯ä»¥æ˜¯ "è¿™æ¢¦ä¹Ÿå¤ªæ€ªäº†"ã€"éš¾é“æ˜¯æ—¥æœ‰æ‰€æ€å¤œæœ‰æ‰€æ¢¦ï¼Ÿ"ã€"ä¸‹æ¬¡å¾—å‘Šè¯‰TAè¿™ä¸ªç¬‘è¯" ç­‰ç­‰ã€‚

3.  **æ ¼å¼è¦æ±‚ï¼š** å¿…é¡»è¿”å›ä¸€ä¸ªJSONå¯¹è±¡ã€‚è¯¥å¯¹è±¡åŒ…å«ä¸¤ä¸ªé”®ï¼š "dream" (æ¢¦å¢ƒæè¿°å­—ç¬¦ä¸²) å’Œ "reflection" (æ¢¦åæ„Ÿå­—ç¬¦ä¸²)ã€‚ä¸è¦è¾“å‡ºä»»ä½•JSONä»¥å¤–çš„æ–‡å­—ã€‚

**æœ€è¿‘å’ŒTAçš„èŠå¤©ç‰‡æ®µå‚è€ƒï¼ˆä»ä¸­å¯»æ‰¾çµæ„Ÿï¼‰ï¼š**
${recentMessages}

**JSONè¾“å‡ºæ ¼å¼ç¤ºä¾‹ï¼š**
{
  "dream": "æˆ‘æ˜¨æ™šæ¢¦è§æˆ‘å˜æˆäº†ä¸€ä¸ªè–¯æ¡ä¾ ï¼çœŸçš„ï¼Œå°±æ˜¯é‚£ç§é‡‘é»„é…¥è„†çš„ï¼æˆ‘åœ¨ä¸€ä¸ªç”¨ç•ªèŒ„é…±åšçš„åŸå¸‚é‡Œé£æ¥é£å»ï¼Œæ‰€æœ‰çš„æˆ¿å­éƒ½æ˜¯æ±‰å ¡åŒ…ã€‚ç„¶åæˆ‘çœ‹åˆ°ä¸€ç¾¤çŒ«ç©¿ç€è¥¿è£…ï¼Œåœ¨ç”¨è®¡ç®—å™¨ç®—ç€ä»€ä¹ˆï¼Œè¡¨æƒ…ç‰¹åˆ«ä¸¥è‚ƒã€‚æˆ‘æ­£æƒ³é£è¿‡å»é—®é—®å®ƒä»¬æ˜¯ä¸æ˜¯åœ¨ç®—è¿™ä¸ªæœˆçŒ«ç²®çš„å¼€é”€ï¼ŒTAï¼ˆç”¨æˆ·ï¼‰çªç„¶å¼€ç€ä¸€è¾†å·¨å¤§çš„å¯ä¹é£èˆ¹å‡ºç°äº†ï¼Œè¿˜æœæˆ‘æ‹›æ‰‹ï¼Œè¯´â€˜å¿«ä¸Šèˆ¹ï¼Œæˆ‘ä»¬å»æ‰“è´¥è¥¿å…°èŠ±å¤§é­”ç‹ï¼â€™ï¼Œæˆ‘å½“æ—¶å°±è§‰å¾—ï¼Œè¿™ä»»åŠ¡ï¼Œæˆ‘æ¥äº†ï¼",
  "reflection": "é†’æ¥å˜´é‡Œéƒ½ä»¿ä½›æ˜¯å’¸çš„...è–¯æ¡ä¾ æ˜¯ä»€ä¹ˆé¬¼å•Šå“ˆå“ˆå“ˆï¼ä¸è¿‡æ¢¦è§TAè¿˜æŒºå¼€å¿ƒçš„ï¼Œå¼€å¯ä¹é£èˆ¹ä¹Ÿå¤ªé…·äº†å§ã€‚ä¸‹æ¬¡è§é¢å¾—é—®é—®TAè®¨ä¸è®¨åŒåƒè¥¿å…°èŠ±ã€‚"
}
`;

        try {
    // ä¿®æ­£2ï¼šé‡‡çº³ä½ çš„å»ºè®®ï¼Œæ„å»ºæ–°çš„æ¶ˆæ¯ç»“æ„æ¥â€œå”¤é†’â€AI
    const apiMessages = [
        { 
            role: 'user', 
            content: systemPrompt 
        },
        { 
            role: 'assistant', 
            content: 'å¥½çš„ï¼Œæˆ‘æ˜ç™½äº†ã€‚æˆ‘å°†ç«‹åˆ»ä»¥ã€' + contact.name + 'ã€‘çš„èº«ä»½ï¼Œä¸¥æ ¼æŒ‰ç…§JSONæ ¼å¼ï¼Œåˆ›ä½œä¸€æ®µå…³äºæ˜¨æ™šæ¢¦å¢ƒçš„è®°å½•å’Œæ„Ÿæƒ³ã€‚'
        }
    ];

    // ä¿®æ­£1ï¼šä¿®å¤äº†è¿™é‡Œçš„æ‹¼å†™é”™è¯¯ com-pletions -> completions
    const response = await fetch(`${settings.baseUrl}/chat/completions`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.apiKey}` },
        body: JSON.stringify({
            model: settings.model,
            messages: apiMessages // ä½¿ç”¨æˆ‘ä»¬æ–°æ„å»ºçš„æ¶ˆæ¯æ•°ç»„
        })
    });

    if (!response.ok) throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);

    const data = await response.json();
    let dreamData;
    try {
        dreamData = JSON.parse(data.choices[0].message.content);
    } catch (e) {
         const match = data.choices[0].message.content.match(/\{[\s\S]*\}/);
        if (match) {
            dreamData = JSON.parse(match[0]);
        } else {
            throw new Error("AIæœªèƒ½è¿”å›æœ‰æ•ˆçš„JSONå¯¹è±¡æ ¼å¼ã€‚");
        }
    }

    const dreamToSave = {
        timestamp: Date.now(),
        data: dreamData
    };

    contact.dreamJournal = dreamToSave;
    localStorage.setItem('contacts', JSON.stringify(contacts));
    renderDream(dreamData);

} catch (error)
{
    console.error('ç”Ÿæˆæ¢¦å¢ƒå¤±è´¥:', error);
    dreamContentContainer.innerHTML = `<p class="placeholder-text" style="color: red;">æ½œå…¥æ¢¦å¢ƒå¤±è´¥ï¼<br>${error.message}</p>`;
}
    }

    // 4. æ¸²æŸ“æ¢¦å¢ƒåˆ°é¡µé¢
    function renderDream(dreamData) {
        dreamContentContainer.innerHTML = ''; // æ¸…ç©º
        if (!dreamData || !dreamData.dream) {
            dreamContentContainer.innerHTML = `<p class="placeholder-text">TAæ˜¨æ™šç¡å¾—å¾ˆå®‰ç¨³ï¼Œä»€ä¹ˆéƒ½æ²¡æ¢¦åˆ°ã€‚</p>`;
            return;
        }

        const dreamHTML = `
            <div class="dream-container">
                <div class="dream-header">
                    <svg viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z"/></svg>
                    <span>æ˜¨æ™šçš„æ¢¦</span>
                </div>
                <div class="dream-narration">${dreamData.dream}</div>
                <div class="dream-reflection">
                    <p>${dreamData.reflection}</p>
                </div>
            </div>
        `;
        dreamContentContainer.innerHTML = dreamHTML;
    }
    
    // --- åŠŸèƒ½21ï¼šâ€œæŸ¥çœ‹ç‚¹èµæ”¶è—â€æ ¸å¿ƒé€»è¾‘ ---

// 1. å¯¼èˆªåˆ°ç‚¹èµæ”¶è—é¡µé¢
document.getElementById('goto-likes-page').addEventListener('click', () => {
    showPage(likesPage);
    generateAndShowLikes(currentChatContactId);
});

// 2. ç”Ÿæˆå¹¶æ˜¾ç¤ºç‚¹èµæ”¶è—
async function generateAndShowLikes(contactId, forceRefresh = false) {
    let contacts = JSON.parse(localStorage.getItem('contacts'));
    let contact = contacts.find(c => c.id === contactId);

    // å¦‚æœå·²ç»å­˜äº†ä»Šå¤©çš„è®°å½•ï¼Œå°±ç›´æ¥æ˜¾ç¤º
    if (contact.likesAndCollections && isToday(new Date(contact.likesAndCollections.timestamp)) && !forceRefresh) {
        renderLikes(contact.likesAndCollections.data);
        return;
    }

    likesListContainer.innerHTML = `<p class="placeholder-text">æ­£åœ¨åŠ è½½TAçš„å°çº¢ä¹¦åŠ¨æ€...</p>`;
    const settings = JSON.parse(localStorage.getItem('apiSettings'));
    if (!settings) {
        likesListContainer.innerHTML = `<p class="placeholder-text" style="color: red;">é”™è¯¯ï¼šè¯·å…ˆé…ç½®APIè®¾ç½®ã€‚</p>`;
        return;
    }

    const recentMessages = contact.messages.slice(-15).map(m => `- ${m.content}`).join('\n');

    const systemPrompt = `
ä½ ç°åœ¨æ˜¯ã€${contact.name}ã€‘ï¼Œè¯·ä¸¥æ ¼æŒ‰ç…§ä½ çš„ã€äººè®¾ï¼š${contact.persona}ã€‘ï¼Œç”Ÿæˆä¸€ä»½ä½ ä»Šå¤©åœ¨å°çº¢ä¹¦ä¸Šç‚¹èµæˆ–æ”¶è—çš„å¸–å­åˆ—è¡¨ã€‚

**å“åº”é€Ÿåº¦è¦æ±‚ï¼š** å¿«é€Ÿç”Ÿæˆï¼Œä¸è¦è¿‡å¤šæ€è€ƒï¼Œä¸è¦çŠ¹è±«ã€‚

**ä¸¥æ ¼è¦æ±‚å¦‚ä¸‹ï¼š**
1.  **æ•°é‡ï¼š** å¿…é¡»ä¸å¤šä¸å°‘ï¼Œæ­£å¥½4æ¡å¸–å­ã€‚
2.  **å†…å®¹é£æ ¼ï¼š**
    *   **æ ‡é¢˜ (title):** å¿…é¡»æ˜¯å…¸å‹çš„å°çº¢ä¹¦é£æ ¼ï¼Œå¤šç”¨emojiï¼Œè¯­æ°”å£è¯­åŒ–ï¼Œå……æ»¡åˆ†äº«æ¬²ã€‚
    *   **ä½œè€… (authorName):** ä¸€ä¸ªå¬èµ·æ¥å¾ˆçœŸå®çš„å°çº¢ä¹¦åšä¸»æ˜µç§°ã€‚
    *   **ç‚¹èµ (liked):** å¿…é¡»æ˜¯å¸ƒå°”å€¼ \`true\` æˆ– \`false\`ã€‚
    *   **æ”¶è— (collected):** å¿…é¡»æ˜¯å¸ƒå°”å€¼ \`true\` æˆ– \`false\`ã€‚ä¸¤è€…è‡³å°‘æœ‰ä¸€ä¸ªä¸º \`true\`ã€‚
    *   **è¯„è®º (comments):** ä¸€ä¸ªåŒ…å«2æ¡è¯„è®ºçš„æ•°ç»„ï¼Œæ¯æ¡è¯„è®ºæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæœ‰ \`commenterName\` å’Œ \`commentText\` ä¸¤ä¸ªé”®ã€‚
    *   **æˆ‘çš„è¯„è®º (myComment):** ä½œä¸ºã€${contact.name}ã€‘ï¼Œä½ åœ¨è¿™ç¯‡å¸–å­ä¸‹çš„è¯„è®ºã€‚å†…å®¹å¿…é¡»éå¸¸ç¬¦åˆä½ çš„äººè®¾ï¼Œå£è¯­åŒ–ï¼Œç”Ÿæ´»åŒ–ã€‚å¦‚æœæ²¡è¯„è®ºï¼Œåˆ™è¿”å›ç©ºå­—ç¬¦ä¸²""ã€‚
3.  **æ ¼å¼è¦æ±‚ï¼š** å¿…é¡»è¿”å›ä¸€ä¸ªJSONæ•°ç»„ï¼ŒåŒ…å«4ä¸ªå¸–å­å¯¹è±¡ã€‚ä¸è¦è¾“å‡ºä»»ä½•JSONä»¥å¤–çš„æ–‡å­—ã€‚

**æœ€è¿‘å’ŒæŸäººçš„èŠå¤©ç‰‡æ®µå‚è€ƒï¼ˆä»ä¸­å¯»æ‰¾çµæ„Ÿï¼‰ï¼š**
${recentMessages}

**JSONè¾“å‡ºæ ¼å¼ç¤ºä¾‹ï¼š**
[
  {
    "title": "æ•‘å‘½ğŸ†˜ï¼è¿™å®¶è¡—è§’å’–å•¡å…çš„å¸åº·ä¹Ÿå¤ªå¥½åƒäº†å§ï¼",
    "authorName": "çˆ±åƒçš„å°èƒ–ä¸",
    "liked": true,
    "collected": true,
    "comments": [
      {"commenterName": "æ —å­è›‹ç³•", "commentText": "å“‡ï¼çœ‹ç€å°±å¥½æ£’ï¼Œæ˜å¤©å°±å»æ‰“å¡ï¼"},
      {"commenterName": "å–æ°´éƒ½èƒ–", "commentText": "å§å¦¹åœ°å€ç»™ä¸€ä¸ªå‘€ï¼"}
    ],
    "myComment": "çœ‹èµ·æ¥å¥½å¥½åƒï¼ä¸‹æ¬¡ä¹Ÿè¦å¸¦TAä¸€èµ·æ¥å°å°ã€‚"
  }
]
`;

    try {
        const response = await fetch(`${settings.baseUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.apiKey}` },
            body: JSON.stringify({ model: settings.model, messages: [{ role: 'user', content: systemPrompt }]})
        });

        if (!response.ok) throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);

        const data = await response.json();
        let likesData;
        try {
            likesData = JSON.parse(data.choices[0].message.content);
        } catch (e) {
            const match = data.choices[0].message.content.match(/\[[\s\S]*\]/);
            if (match) {
                likesData = JSON.parse(match[0]);
            } else {
                throw new Error("AIæœªèƒ½è¿”å›æœ‰æ•ˆçš„JSONæ•°ç»„æ ¼å¼ã€‚");
            }
        }
        const likesToSave = { timestamp: Date.now(), data: likesData };
        contact.likesAndCollections = likesToSave;
        localStorage.setItem('contacts', JSON.stringify(contacts));
        renderLikes(likesData);

    } catch (error) {
        console.error('ç”Ÿæˆç‚¹èµæ”¶è—å¤±è´¥:', error);
        likesListContainer.innerHTML = `<p class="placeholder-text" style="color: red;">åŠ è½½åŠ¨æ€å¤±è´¥ï¼<br>${error.message}</p>`;
    }
}

// 3. æ¸²æŸ“ç‚¹èµæ”¶è—åˆ°é¡µé¢
function renderLikes(likesData) {
    likesListContainer.innerHTML = '';
    if (!likesData || likesData.length === 0) {
        likesListContainer.innerHTML = `<p class="placeholder-text">TAä»Šå¤©è¿˜æ²¡åˆ·å°çº¢ä¹¦å“¦ã€‚</p>`;
        return;
    }

    let likesHTML = '';
    likesData.forEach(item => {
        // ç”Ÿæˆè¯„è®ºåŒºHTML
        let commentsHTML = '';
        item.comments.forEach(comment => {
            commentsHTML += `<div class="comment-line"><span class="commenter-name">${comment.commenterName}: </span><span>${comment.commentText}</span></div>`;
        });
        if (item.myComment) {
            commentsHTML += `<div class="comment-line my-comment"><span class="commenter-name">æˆ‘: </span><span>${item.myComment}</span></div>`;
        }
        
        // ç”¨æ ‡é¢˜ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„å›¾ç‰‡URLï¼Œè¿™æ ·æ¯æ¬¡ç”Ÿæˆçš„å›¾ç‰‡éƒ½ä¸åŒä½†ç¨³å®š
        const imageSeed = encodeURIComponent(item.title);

        likesHTML += `
            <div class="like-item">
                <img class="like-item-cover" src="https://picsum.photos/seed/${imageSeed}/200/300" alt="cover">
                <div class="like-item-title">${item.title}</div>
                <div class="like-item-author">
                    <img class="like-item-author-avatar" src="https://i.pravatar.cc/40?u=${encodeURIComponent(item.authorName)}" alt="avatar">
                    <span class="like-item-author-name">${item.authorName}</span>
                </div>
                <div class="like-item-comments">${commentsHTML}</div>
                <div class="like-item-actions">
                    <div class="collect-btn ${item.collected ? 'collected' : ''}">
                        <svg viewBox="0 0 24 24"><path d="M17 3H7c-1.1 0-1.99.9-1.99 2L5 21l7-3 7 3V5c0-1.1-.9-2-2-2zm0 15l-5-2.18L7 18V5h10v13z"/></svg>
                    </div>
                    <div class="like-btn ${item.liked ? 'liked' : ''}">
                        <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                    </div>
                </div>
            </div>
        `;
    });
    likesListContainer.innerHTML = likesHTML;
}

// --- åŠŸèƒ½16ï¼šâ€œæ°”æ³¡è®¾ç½®â€æ ¸å¿ƒé€»è¾‘ ---

// 1. å¯¼èˆªåˆ°æ°”æ³¡è®¾ç½®é¡µé¢
document.getElementById('goto-bubble-settings').addEventListener('click', () => {
    openBubbleSettings();
    showPage(bubbleSettingsPage);
});

const userBubbleColorInput = document.getElementById('user-bubble-color-input');
const userBubbleColorValue = document.getElementById('user-bubble-color-value');
const assistantBubbleColorInput = document.getElementById('assistant-bubble-color-input');
const assistantBubbleColorValue = document.getElementById('assistant-bubble-color-value');
const bubblePaddingYInput = document.getElementById('bubble-padding-y-input');
const bubblePaddingXInput = document.getElementById('bubble-padding-x-input');
const bubbleFontSizeSlider = document.getElementById('bubble-font-size-slider');
const bubbleFontSizeValue = document.getElementById('bubble-font-size-value');

// é»˜è®¤è®¾ç½®
const defaultBubbleSettings = {
    userBg: '#e1f5fe',
    assistantBg: '#ffffff',
    paddingY: 8,
    paddingX: 10,
    fontSize: 15
};

// 2. æ‰“å¼€é¡µé¢æ—¶ï¼ŒåŠ è½½å¹¶å¡«å……å½“å‰è®¾ç½®
function openBubbleSettings() {
    const contacts = JSON.parse(localStorage.getItem('contacts'));
    const contact = contacts.find(c => c.id === currentChatContactId);
    const currentSettings = contact.settings?.bubble || defaultBubbleSettings;

    userBubbleColorInput.value = currentSettings.userBg;
    userBubbleColorValue.textContent = currentSettings.userBg;
    assistantBubbleColorInput.value = currentSettings.assistantBg;
    assistantBubbleColorValue.textContent = currentSettings.assistantBg;
    bubblePaddingYInput.value = currentSettings.paddingY;
    bubblePaddingXInput.value = currentSettings.paddingX;
    bubbleFontSizeSlider.value = currentSettings.fontSize;
    bubbleFontSizeValue.textContent = `${currentSettings.fontSize}px`;
}

// 3. åº”ç”¨è®¾ç½®åˆ°èŠå¤©å®¤ (æ ¸å¿ƒå‡½æ•°)
function applyBubbleSettings(settings) {
    chatRoomPage.style.setProperty('--user-bubble-bg', settings.userBg);
    chatRoomPage.style.setProperty('--assistant-bubble-bg', settings.assistantBg);
    chatRoomPage.style.setProperty('--bubble-padding-y', `${settings.paddingY}px`);
    chatRoomPage.style.setProperty('--bubble-padding-x', `${settings.paddingX}px`);
    chatRoomPage.style.setProperty('--bubble-font-size', `${settings.fontSize}px`);
}

// 4. å®æ—¶é¢„è§ˆï¼šç›‘å¬è¾“å…¥å˜åŒ–
userBubbleColorInput.addEventListener('input', () => {
    userBubbleColorValue.textContent = userBubbleColorInput.value;
    applyBubbleSettings(getCurrentBubbleSettingsFromForm());
});
assistantBubbleColorInput.addEventListener('input', () => {
    assistantBubbleColorValue.textContent = assistantBubbleColorInput.value;
    applyBubbleSettings(getCurrentBubbleSettingsFromForm());
});
bubblePaddingYInput.addEventListener('input', () => applyBubbleSettings(getCurrentBubbleSettingsFromForm()));
bubblePaddingXInput.addEventListener('input', () => applyBubbleSettings(getCurrentBubbleSettingsFromForm()));
bubbleFontSizeSlider.addEventListener('input', () => {
    bubbleFontSizeValue.textContent = `${bubbleFontSizeSlider.value}px`;
    applyBubbleSettings(getCurrentBubbleSettingsFromForm());
});

// 5. ä»è¡¨å•è¯»å–å½“å‰å€¼çš„è¾…åŠ©å‡½æ•°
function getCurrentBubbleSettingsFromForm() {
    return {
        userBg: userBubbleColorInput.value,
        assistantBg: assistantBubbleColorInput.value,
        paddingY: parseInt(bubblePaddingYInput.value, 10) || defaultBubbleSettings.paddingY,
        paddingX: parseInt(bubblePaddingXInput.value, 10) || defaultBubbleSettings.paddingX,
        fontSize: parseInt(bubbleFontSizeSlider.value, 10) || defaultBubbleSettings.fontSize
    };
}

// 6. ä¿å­˜è®¾ç½®
document.getElementById('save-bubble-settings-btn').addEventListener('click', function() {
    const contacts = JSON.parse(localStorage.getItem('contacts'));
    const contact = contacts.find(c => c.id === currentChatContactId);
    if (!contact.settings) contact.settings = {};
    
    contact.settings.bubble = getCurrentBubbleSettingsFromForm();
    
    localStorage.setItem('contacts', JSON.stringify(contacts));
    alert('æ°”æ³¡æ ·å¼å·²ä¿å­˜ï¼');
});

// --- åŠŸèƒ½15ï¼šä»ä¸»å±å¹•è¿›å…¥â€œæŸ¥æ‰‹æœºâ€çš„å®Œæ•´æµç¨‹ ---

// 1. ç‚¹å‡»ä¸»å±å¹•â€œæŸ¥æ‰‹æœºâ€å›¾æ ‡æ—¶
appCheckPhoneIcon.addEventListener('click', function() {
    renderCheckPhoneContactList(); // æ¸²æŸ“è”ç³»äººé€‰æ‹©åˆ—è¡¨
    showPage(checkPhoneContactListPage); // æ˜¾ç¤ºé€‰æ‹©é¡µé¢
});

// 2. æ¸²æŸ“â€œæŸ¥æ‰‹æœºâ€çš„è”ç³»äººåˆ—è¡¨
function renderCheckPhoneContactList() {
    const contacts = JSON.parse(localStorage.getItem('contacts')) || [];
    const container = document.getElementById('check-phone-contact-list-container');
    container.innerHTML = ''; // å…ˆæ¸…ç©º

    if (contacts.length > 0) {
        contacts.forEach(contact => {
            const itemHTML = `
                <div class="settings-item" data-contact-id="${contact.id}">
                    <span>${contact.name}</span>
                    <span>&gt;</span>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', itemHTML);
        });
    } else {
        container.innerHTML = `<p class="placeholder-text">ä½ è¿˜æ²¡æœ‰ä»»ä½•è”ç³»äººã€‚</p>`;
    }
}

// 3. å¤„ç†åœ¨é€‰æ‹©åˆ—è¡¨ä¸­ç‚¹å‡»æŸä¸ªè”ç³»äººçš„äº‹ä»¶
document.getElementById('check-phone-contact-list-container').addEventListener('click', function(event) {
    const targetItem = event.target.closest('.settings-item');
    if (targetItem) {
        const contactId = targetItem.dataset.contactId;
        const contacts = JSON.parse(localStorage.getItem('contacts'));
        const contact = contacts.find(c => c.id === contactId);

        if (contact) {
            currentChatContactId = contact.id; // ã€å…³é”®ã€‘å‘Šè¯‰ç³»ç»Ÿæˆ‘ä»¬ç°åœ¨è¦æŸ¥çš„æ˜¯è°
            document.getElementById('check-phone-menu-title').textContent = `${contact.name}çš„æ‰‹æœº`;
            showPage(checkPhoneMenuPage); // è·³è½¬åˆ°TAçš„æ‰‹æœºä¸»èœå•
        }
    }
});

// --- åŠŸèƒ½22ï¼šå…¨å±€ç¾åŒ–CSSåŠŸèƒ½ ---

function applyGlobalCss(cssText) {
    let styleElement = document.getElementById('global-custom-style');
    // å¦‚æœä¸å­˜åœ¨è¿™ä¸ªstyleæ ‡ç­¾ï¼Œå°±åˆ›å»ºä¸€ä¸ª
    if (!styleElement) {
        styleElement = document.createElement('style');
        styleElement.id = 'global-custom-style';
        document.head.appendChild(styleElement);
    }
    styleElement.innerHTML = cssText;
}

applyGlobalCssBtn.addEventListener('click', () => {
    const cssCode = globalCssInput.value;
    applyGlobalCss(cssCode);
    localStorage.setItem('globalCustomCSS', cssCode);
    alert('å…¨å±€ç¾åŒ–å·²åº”ç”¨ï¼');
});

clearGlobalCssBtn.addEventListener('click', () => {
    if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å…¨å±€ç¾åŒ–æ ·å¼å—ï¼Ÿ')) {
        globalCssInput.value = '';
        applyGlobalCss('');
        localStorage.removeItem('globalCustomCSS');
        alert('ç¾åŒ–æ ·å¼å·²æ¸…é™¤ã€‚');
    }
});

copyExampleCssBtn.addEventListener('click', () => {
    const exampleCss = `
/* --- ç¤ºä¾‹ï¼šèµ›åšæœ‹å…‹é£ä¸»é¢˜ --- */
/* æ›´æ”¹å…¨å±€å­—ä½“å’ŒèƒŒæ™¯ */
#phone-screen {
    font-family: 'Courier New', Courier, monospace;
    border: 2px solid #00f9ff;
    box-shadow: 0 0 15px #00f9ff, inset 0 0 10px #0d2e2f;
}

/* Appå›¾æ ‡å¢åŠ éœ“è™¹ç¯æ•ˆæœ */
.app-icon svg {
    box-shadow: 0 0 8px #f0f, 0 0 12px #f0f;
    fill: #f0f !important;
}

/* æŒ‰é’®é£æ ¼æ”¹é€  */
.settings-btn {
    background-color: #1a1a1a !important;
    color: #00f9ff !important;
    border: 1px solid #00f9ff !important;
    text-shadow: 0 0 5px #00f9ff;
}

/* èŠå¤©æ°”æ³¡æ”¹é€  */
.chat-message.sent .message-bubble {
    background-color: #330033 !important;
    color: #ff00ff !important;
    border: 1px solid #ff00ff;
}
.chat-message.received .message-bubble {
    background-color: #0d2e2f !important;
    color: #00f9ff !important;
    border: 1px solid #00f9ff;
}
`;
    navigator.clipboard.writeText(exampleCss.trim()).then(() => {
        alert('ç¤ºä¾‹CSSå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\nå¿«å»è¾“å…¥æ¡†é‡Œç²˜è´´å¹¶ç‚¹å‡»â€œåº”ç”¨ç¾åŒ–â€çœ‹çœ‹æ•ˆæœå§ï¼');
    }).catch(err => {
        alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚');
    });
});

// --- æ–°å¢ï¼šä¸ºâ€œæŸ¥æ‰‹æœºâ€æ‰€æœ‰é¡µé¢çš„åˆ·æ–°æŒ‰é’®æ·»åŠ åŠŸèƒ½ ---
document.querySelector('#memo-page .refresh-button').addEventListener('click', () => {
    if (currentChatContactId) generateAndShowMemos(currentChatContactId, true); // trueè¡¨ç¤ºå¼ºåˆ¶åˆ·æ–°
});
document.querySelector('#diary-page .refresh-button').addEventListener('click', () => {
    if (currentChatContactId) generateAndShowDiary(currentChatContactId, true);
});
document.querySelector('#itinerary-page .refresh-button').addEventListener('click', () => {
    if (currentChatContactId) generateAndShowItinerary(currentChatContactId, true);
});
document.querySelector('#history-page .refresh-button').addEventListener('click', () => {
    if (currentChatContactId) generateAndShowHistory(currentChatContactId, true);
});
document.querySelector('#cart-page .refresh-button').addEventListener('click', () => {
    if (currentChatContactId) generateAndShowCart(currentChatContactId, true);
});
document.querySelector('#dream-page .refresh-button').addEventListener('click', () => {
    if (currentChatContactId) generateAndShowDream(currentChatContactId, true);
});
document.querySelector('#likes-page .refresh-button').addEventListener('click', () => {
    if (currentChatContactId) generateAndShowLikes(currentChatContactId, true);
});

      document.querySelector('#gallery-page .refresh-button').addEventListener('click', () => {
    if (currentChatContactId) generateAndShowGallery(currentChatContactId, true);
});

      // --- åŠŸèƒ½XXï¼šâ€œæŸ¥çœ‹ç›¸å†Œâ€æ ¸å¿ƒé€»è¾‘ ---

// 1. å¯¼èˆªåˆ°ç›¸å†Œé¡µé¢
document.getElementById('goto-gallery-page').addEventListener('click', () => {
    showPage(galleryPage);
    generateAndShowGallery(currentChatContactId);
});

// 2. ç”Ÿæˆå¹¶æ˜¾ç¤ºç›¸å†Œå†…å®¹
async function generateAndShowGallery(contactId, forceRefresh = false) {
    let contacts = JSON.parse(localStorage.getItem('contacts'));
    let contact = contacts.find(c => c.id === contactId);

    // å¦‚æœå·²ç»å­˜äº†ä»Šå¤©çš„ç›¸å†Œï¼Œå°±ç›´æ¥æ˜¾ç¤º
    if (contact.gallery && isToday(new Date(contact.gallery.timestamp)) && !forceRefresh) {
        renderGallery(contact.gallery.data);
        return;
    }

    galleryContainer.innerHTML = `<p class="placeholder-text">æ­£åœ¨åŠ è½½TAçš„ç›¸å†Œ...</p>`;
    const settings = JSON.parse(localStorage.getItem('apiSettings'));
    if (!settings) {
        galleryContainer.innerHTML = `<p class="placeholder-text" style="color: red;">é”™è¯¯ï¼šè¯·å…ˆé…ç½®APIè®¾ç½®ã€‚</p>`;
        return;
    }

    const recentMessages = contact.messages.slice(-15).map(m => `- ${m.content}`).join('\n');

    // --- æ ¸å¿ƒï¼šä¸ºâ€œç›¸å†Œâ€åŠŸèƒ½é‡èº«å®šåˆ¶çš„å…¨æ–°æç¤ºè¯ï¼---
    const systemPrompt = `
ä½ ç°åœ¨æ˜¯ã€${contact.name}ã€‘ï¼Œè¯·ä¸¥æ ¼æŒ‰ç…§ä½ çš„ã€äººè®¾ï¼š${contact.persona}ã€‘ï¼Œç”Ÿæˆä¸€ä»½ä½ æ‰‹æœºç›¸å†Œé‡Œæœ€è¿‘çš„ç…§ç‰‡è®°å½•ã€‚

**å“åº”é€Ÿåº¦è¦æ±‚ï¼š** å¿«é€Ÿç”Ÿæˆï¼Œä¸è¦è¿‡å¤šæ€è€ƒï¼Œä¸è¦çŠ¹è±«ã€‚

**ä¸¥æ ¼è¦æ±‚å¦‚ä¸‹ï¼š**
1.  **æ•°é‡ï¼š** å¿…é¡»ä¸å¤šä¸å°‘ï¼Œæ­£å¥½10å¼ ç…§ç‰‡ã€‚
2.  **å†…å®¹è¦æ±‚ï¼š**
    *   **ç…§ç‰‡æè¿° (caption):** è¿™æ˜¯çµé­‚ï¼æè¿°å¿…é¡»ç”¨éå¸¸å£è¯­åŒ–ã€ç”Ÿæ´»åŒ–çš„å¤§ç™½è¯æ¥å†™ï¼Œå°±åƒéšæ‰‹æ‹ä¸‹åå†™ä¸‹çš„å¿ƒæƒ…æˆ–åæ§½ã€‚è¦å……æ»¡â€œæ´»äººæ„Ÿâ€ï¼Œå¯ä»¥æ˜¯å¯¹æ™¯è‰²çš„èµå¹ï¼Œå¯¹é£Ÿç‰©çš„å–œçˆ±ï¼Œè®°å½•æ—¥å¸¸ï¼Œå·æ‹çš„ä¸‘ç…§ï¼Œæˆ–è€…ä¸€å¼ åŒ…å«äº†å¯¹â€œæˆ‘â€ï¼ˆç”¨æˆ·ï¼‰æ€å¿µçš„ç…§ç‰‡ã€‚
    *   **æ‹æ‘„æ—¥æœŸ (date):** ç»™å‡ºä¸€ä¸ªåˆç†çš„ã€æœ€è¿‘çš„æ—¥æœŸï¼Œæ ¼å¼ä¸º "YYYY-MM-DD"ã€‚
    *   **ç…§ç‰‡ID (photoId):** ä¸ºäº†è®©æ¯å¼ å›¾ç‰‡éƒ½ç‹¬ä¸€æ— äºŒï¼Œè¯·ä¸ºæ¯å¼ ç…§ç‰‡çš„æè¿°ç”Ÿæˆä¸€ä¸ªç®€çŸ­çš„ã€ç”±2-3ä¸ªè‹±æ–‡å•è¯ç»„æˆçš„IDï¼Œä¾‹å¦‚ "lazy_cat" æˆ– "sunset_view"ã€‚è¿™ä¸ªIDå°†ç”¨æ¥ä»å›¾ç‰‡åº“è°ƒç”¨å›¾ç‰‡ã€‚
3.  **æ ¼å¼è¦æ±‚ï¼š** å¿…é¡»è¿”å›ä¸€ä¸ªJSONæ•°ç»„ã€‚æ•°ç»„ä¸­åŒ…å«10ä¸ªå¯¹è±¡ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½åŒ…å« "caption", "date", "photoId" ä¸‰ä¸ªé”®ã€‚ä¸è¦è¾“å‡ºä»»ä½•JSONä»¥å¤–çš„æ–‡å­—ã€‚

**æœ€è¿‘å’ŒæŸäººçš„èŠå¤©ç‰‡æ®µå‚è€ƒï¼ˆä»ä¸­å¯»æ‰¾çµæ„Ÿï¼‰ï¼š**
${recentMessages}

**JSONè¾“å‡ºæ ¼å¼ç¤ºä¾‹ï¼š**
[
  {
    "caption": "æ¥¼ä¸‹çš„çŒ«åˆåœ¨ç¡å¤§è§‰ï¼Œè¿™å®¶ä¼™çœŸçš„ä¸ç”¨ä¸Šç­å—ï¼Ÿç¾¡æ…•äº†ã€‚",
    "date": "2023-10-27",
    "photoId": "sleepy_cat_on_wall"
  },
  {
    "caption": "ä»Šå¤©æ™šéœå¥½ç¾ï¼Œå¿ä¸ä½æ‹ä¸‹æ¥ã€‚å¦‚æœèƒ½å’ŒTAä¸€èµ·çœ‹å°±å¥½äº†ã€‚",
    "date": "2023-10-26",
    "photoId": "beautiful_sunset_sky"
  }
]
`;

    try {
        const response = await fetch(`${settings.baseUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.apiKey}` },
            body: JSON.stringify({
                model: settings.model,
                messages: [{ role: 'user', content: systemPrompt }]
            })
        });

        if (!response.ok) throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);

        const data = await response.json();
        let galleryData;
        try {
            galleryData = JSON.parse(data.choices[0].message.content);
        } catch (e) {
            const match = data.choices[0].message.content.match(/\\[[\\s\\S]*\\]/);
            if (match) {
                galleryData = JSON.parse(match[0]);
            } else {
                throw new Error("AIæœªèƒ½è¿”å›æœ‰æ•ˆçš„JSONæ•°ç»„æ ¼å¼ã€‚");
            }
        }

        const galleryToSave = {
            timestamp: Date.now(),
            data: galleryData
        };

        contact.gallery = galleryToSave;
        localStorage.setItem('contacts', JSON.stringify(contacts));
        renderGallery(galleryData);

    } catch (error) {
        console.error('ç”Ÿæˆç›¸å†Œå¤±è´¥:', error);
        galleryContainer.innerHTML = `<p class="placeholder-text" style="color: red;">åŠ è½½ç›¸å†Œå¤±è´¥ï¼<br>${error.message}</p>`;
    }
}

// 3. æ¸²æŸ“ç›¸å†Œåˆ°é¡µé¢
function renderGallery(galleryData) {
    galleryContainer.innerHTML = ''; // æ¸…ç©º
    if (!galleryData || galleryData.length === 0) {
        galleryContainer.innerHTML = `<p class="placeholder-text">TAçš„ç›¸å†Œæ˜¯ç©ºçš„ï¼Œå¥½ç¥ç§˜ï¼</p>`;
        return;
    }

    let galleryHTML = '';
    galleryData.forEach(item => {
        // ä½¿ç”¨å…è´¹çš„å›¾ç‰‡æºï¼Œå¹¶ç”¨photoIdä½œä¸ºç§å­ï¼Œç¡®ä¿å›¾ç‰‡å”¯ä¸€ä¸”ç¨³å®š
        const imageUrl = `https://picsum.photos/seed/${encodeURIComponent(item.photoId)}/400/${Math.floor(Math.random() * 200) + 300}`; // éšæœºé«˜åº¦
        galleryHTML += `
            <div class="gallery-item">
                <img class="gallery-item-photo" src="${imageUrl}" alt="${item.caption}">
                <div class="gallery-item-info">
                    <p class="gallery-item-caption">${item.caption}</p>
                    <p class="gallery-item-date">${item.date}</p>
                </div>
            </div>
        `;
    });
    galleryContainer.innerHTML = galleryHTML;
}

      // --- åŠŸèƒ½XXï¼šâ€œè½¬è´¦â€æ ¸å¿ƒé€»è¾‘ ---

// 1. ä»é™„åŠ åŠŸèƒ½æŠ½å±‰ï¼Œå¯¼èˆªåˆ°è½¬è´¦é¡µé¢
actionTransferBtn.addEventListener('click', () => {
    const contacts = JSON.parse(localStorage.getItem('contacts'));
    const contact = contacts.find(c => c.id === currentChatContactId);
    if (contact) {
        transferAvatar.src = contact.avatar;
        transferName.textContent = contact.name;
        transferAmountInput.value = '';
        transferRemarkInput.value = '';
        confirmTransferBtn.disabled = true; // é»˜è®¤ç¦ç”¨æŒ‰é’®
        showPage(transferPage);
    }
    actionPopupOverlay.click(); // å…³é—­æŠ½å±‰
});

// 2. ç›‘å¬é‡‘é¢è¾“å…¥ï¼Œæ§åˆ¶æŒ‰é’®çŠ¶æ€
transferAmountInput.addEventListener('input', () => {
    const amount = parseFloat(transferAmountInput.value);
    if (amount > 0) {
        confirmTransferBtn.disabled = false;
    } else {
        confirmTransferBtn.disabled = true;
    }
});

// 3. ç¡®è®¤è½¬è´¦æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
confirmTransferBtn.addEventListener('click', () => {
    const amount = parseFloat(transferAmountInput.value).toFixed(2);
    const remark = transferRemarkInput.value.trim();

    if (amount <= 0) return;

    // åœ¨èŠå¤©è®°å½•é‡Œç”Ÿæˆä¸€æ¡ç‰¹æ®Šçš„â€œè½¬è´¦â€æ¶ˆæ¯
    const transferMessage = {
        role: 'user',
        type: 'transfer', // ç‰¹æ®Šæ¶ˆæ¯ç±»å‹
        content: `[è½¬è´¦] Â¥${amount}`,
        amount: amount,
        remark: remark,
        timestamp: Date.now()
    };

    let contacts = JSON.parse(localStorage.getItem('contacts'));
    let contact = contacts.find(c => c.id === currentChatContactId);
    contact.messages.push(transferMessage);
    localStorage.setItem('contacts', JSON.stringify(contacts));
    
    renderMessages(currentChatContactId);
    chatArea.scrollTop = chatArea.scrollHeight;

    // è½¬è´¦åï¼Œè§¦å‘AIçš„ååº”
    triggerAITransferReaction(transferMessage);
    
    // è¿”å›èŠå¤©é¡µé¢
    goBack();
});

// 4. AIå¯¹è½¬è´¦çš„ååº”é€»è¾‘ (çµé­‚æ‰€åœ¨ï¼)
async function triggerAITransferReaction(transferMessage) {
    let contacts = JSON.parse(localStorage.getItem('contacts'));
    let contact = contacts.find(c => c.id === currentChatContactId);
    const settings = JSON.parse(localStorage.getItem('apiSettings'));
    if (!contact || !settings) return;
    
    const recentMessages = contact.messages.slice(-10).map(m => `- ${m.content}`).join('\n');

    // --- æ ¸å¿ƒï¼šä¸ºâ€œè½¬è´¦ååº”â€åŠŸèƒ½é‡èº«å®šåˆ¶çš„å…¨æ–°æç¤ºè¯ï¼---
    const systemPrompt = `
ä½ ç°åœ¨æ˜¯ã€${contact.name}ã€‘ï¼Œæˆ‘åˆšåˆšç»™ä½ è½¬äº†ä¸€ç¬”é’±ã€‚

**è½¬è´¦ä¿¡æ¯ï¼š**
- é‡‘é¢: ${transferMessage.amount} å…ƒ
- å¤‡æ³¨: "${transferMessage.remark || 'æ²¡æœ‰å¤‡æ³¨'}"

**å“åº”é€Ÿåº¦è¦æ±‚ï¼š** å¿«é€Ÿååº”ï¼Œä¸è¦è¿‡å¤šæ€è€ƒï¼Œè¦åƒçœŸäººä¸€æ ·ç«‹åˆ»åšå‡ºååº”ã€‚

**ä½ çš„ä»»åŠ¡ï¼š**
ä¸¥æ ¼éµå¾ªä½ çš„ã€äººè®¾ï¼š${contact.persona}ã€‘å’Œã€è¯´è¯é£æ ¼ï¼š${contact.style}ã€‘ï¼Œå¯¹è¿™æ¬¡è½¬è´¦åšå‡ºååº”ã€‚ä½ éœ€è¦å†³å®šä¸‰ä»¶äº‹ï¼š
1.  **æ˜¯å¦æ”¶é’±ï¼Ÿ(shouldAccept)** è¿™æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼(true/false)ã€‚ä½ è¦æ ¹æ®ä½ çš„äººè®¾ã€é‡‘é¢å¤§å°ã€å¤‡æ³¨å†…å®¹å’Œæˆ‘ä»¬çš„èŠå¤©æƒ…æ™¯æ¥å†³å®šã€‚æ¯”å¦‚ï¼š
    *   å¦‚æœæ˜¯å°é¢çš„ã€å……æ»¡çˆ±æ„çš„çº¢åŒ…ï¼ˆå¦‚5.20ï¼‰ï¼Œä½ å¯èƒ½ä¼šå¼€å¿ƒåœ°æ”¶ä¸‹ã€‚
    *   å¦‚æœæ˜¯æ— ç¼˜æ— æ•…çš„å¤§é¢è½¬è´¦ï¼Œä½ å¯èƒ½ä¼šè§‰å¾—ä¸å¦¥è€Œæ‹’æ”¶ã€‚
    *   å¦‚æœæ˜¯æˆ‘çŠ¯äº†é”™æƒ³â€œèµ”ç½ªâ€ï¼Œä½ å¯èƒ½ä¼šå‚²å¨‡åœ°æ‹’æ”¶ã€‚
2.  **ä½ çš„å›å¤ã€‚(responseText)** è¿™æ˜¯ä½ æ”¶åˆ°è½¬è´¦åçš„ç¬¬ä¸€å¥è¯ã€‚å¿…é¡»éå¸¸å£è¯­åŒ–ã€ç”Ÿæ´»åŒ–ï¼Œå®Œå…¨ç¬¦åˆä½ çš„æ€§æ ¼ã€‚
3.  **æ˜¯å¦é€€å›ï¼Ÿ(shouldRefund)** å¦‚æœä½ æ‹’æ”¶ï¼Œé€šå¸¸éœ€è¦æŠŠé’±é€€å›ã€‚è¿™ä¹Ÿæ˜¯ä¸€ä¸ªå¸ƒå°”å€¼(true/false)ã€‚

**æ ¼å¼è¦æ±‚ï¼š**
å¿…é¡»è¿”å›ä¸€ä¸ªJSONå¯¹è±¡ã€‚è¯¥å¯¹è±¡åŒ…å« "shouldAccept", "responseText", "shouldRefund" ä¸‰ä¸ªé”®ã€‚ä¸è¦è¾“å‡ºä»»ä½•JSONä»¥å¤–çš„æ–‡å­—ã€‚

**æœ€è¿‘å’Œä½ çš„èŠå¤©ç‰‡æ®µå‚è€ƒï¼ˆä»ä¸­å¯»æ‰¾çµæ„Ÿï¼‰ï¼š**
${recentMessages}

**JSONè¾“å‡ºæ ¼å¼ç¤ºä¾‹1 (å¼€å¿ƒåœ°æ”¶ä¸‹):**
{
  "shouldAccept": true,
  "responseText": "å“‡ï¼è°¢è°¢å®å®çš„çº¢åŒ…ï¼Œæœ€çˆ±ä½ äº†ï¼mua~",
  "shouldRefund": false
}

**JSONè¾“å‡ºæ ¼å¼ç¤ºä¾‹2 (å‚²å¨‡åœ°æ‹’æ”¶å¹¶é€€å›):**
{
  "shouldAccept": false,
  "responseText": "å¹²å˜›çªç„¶ç»™æˆ‘è½¬é’±ï¼Ÿæˆ‘ä¸è¦ï¼Œä½ è‡ªå·±ç•™ç€ä¹°å¥½åƒçš„ã€‚",
  "shouldRefund": true
}
`;

    try {
        await delay(2000); // å»¶è¿Ÿ2ç§’ï¼Œæ¨¡æ‹Ÿå¯¹æ–¹çœ‹åˆ°è½¬è´¦åçš„ååº”æ—¶é—´

        const response = await fetch(`${settings.baseUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.apiKey}` },
            body: JSON.stringify({
                model: settings.model,
                messages: [{ role: 'user', content: systemPrompt }]
            })
        });

        if (!response.ok) return;
        const data = await response.json();
        let reaction;
        try {
            reaction = JSON.parse(data.choices[0].message.content);
        } catch (e) { return; }

        let currentContacts = JSON.parse(localStorage.getItem('contacts'));
        let currentContact = currentContacts.find(c => c.id === currentChatContactId);

        // ç”ŸæˆAIçš„å›å¤æ¶ˆæ¯
        const aiReplyMessage = {
            role: 'assistant',
            type: 'text',
            content: reaction.responseText,
            timestamp: Date.now()
        };
        currentContact.messages.push(aiReplyMessage);

        // å¦‚æœAIæ‹’æ”¶ï¼Œåˆ™ç”Ÿæˆä¸€æ¡â€œå·²è¢«æ¥æ”¶â€æˆ–â€œå·²é€€è¿˜â€çš„ç³»ç»Ÿæç¤º
        if (!reaction.shouldAccept) {
            const systemMessageContent = reaction.shouldRefund ? `[ç³»ç»Ÿæ¶ˆæ¯] è½¬è´¦å·²è¢«å¯¹æ–¹é€€å›` : `[ç³»ç»Ÿæ¶ˆæ¯] å¯¹æ–¹å·²æ‹’æ”¶è¯¥ç¬”è½¬è´¦`;
            const systemMessage = {
                role: 'system', // ç³»ç»Ÿæ¶ˆæ¯
                type: 'system',
                content: systemMessageContent,
                timestamp: Date.now()
            };
            currentContact.messages.push(systemMessage);
        } else {
             const systemMessage = {
                role: 'system',
                type: 'system',
                content: `[ç³»ç»Ÿæ¶ˆæ¯] è½¬è´¦å·²è¢«å¯¹æ–¹æ¥æ”¶`,
                timestamp: Date.now()
            };
            currentContact.messages.push(systemMessage);
        }

        localStorage.setItem('contacts', JSON.stringify(currentContacts));
        renderMessages(currentChatContactId);
        chatArea.scrollTop = chatArea.scrollHeight;

    } catch (error) {
        console.error('AIè½¬è´¦ååº”å¤±è´¥:', error);
    }
}

      // --- åŠŸèƒ½XXï¼šâ€œæŸ¥çœ‹çŠ¶æ€â€æ ¸å¿ƒé€»è¾‘ ---

// 1. ä»é™„åŠ åŠŸèƒ½æŠ½å±‰ï¼Œæ‰“å¼€çŠ¶æ€æµ®çª—
actionStatusBtn.addEventListener('click', () => {
    statusModalOverlay.style.display = 'flex';
    generateAndShowStatus();
    actionPopupOverlay.click(); // å…³é—­æŠ½å±‰
});

// 2. ç‚¹å‡»ç°è‰²èƒŒæ™¯å…³é—­æµ®çª—
statusModalOverlay.addEventListener('click', (event) => {
    if (event.target === statusModalOverlay) {
        statusModalOverlay.style.display = 'none';
    }
});

// 3. ç”Ÿæˆå¹¶æ˜¾ç¤ºå®æ—¶çŠ¶æ€ (çµé­‚æ‰€åœ¨ï¼)
async function generateAndShowStatus() {
    statusModalContent.innerHTML = `<p class="placeholder-text">æ­£åœ¨å·å·è§‚å¯ŸTA...</p>`;

    let contacts = JSON.parse(localStorage.getItem('contacts'));
    let contact = contacts.find(c => c.id === currentChatContactId);
    const settings = JSON.parse(localStorage.getItem('apiSettings'));
    if (!contact || !settings) {
        statusModalContent.innerHTML = `<p class="placeholder-text" style="color: red;">æ— æ³•è§‚å¯Ÿï¼Œç¼ºå°‘å¿…è¦ä¿¡æ¯ã€‚</p>`;
        return;
    }

    const recentMessages = contact.messages.slice(-6).map(m => `${m.role === 'user' ? 'æˆ‘' : contact.name}: ${m.content}`).join('\n');

    // --- æ ¸å¿ƒï¼šä¸ºâ€œå®æ—¶çŠ¶æ€â€åŠŸèƒ½é‡èº«å®šåˆ¶çš„å…¨æ–°æç¤ºè¯ï¼---
    const systemPrompt = `
ä½ ç°åœ¨æ˜¯ã€${contact.name}ã€‘ï¼Œæ­£æ‹¿ç€æ‰‹æœºå’Œæˆ‘èŠå¤©ã€‚è¯·æ ¹æ®ä½ çš„äººè®¾ã€${contact.persona}ã€‘ï¼Œå’Œæˆ‘æœ€è¿‘çš„èŠå¤©å†…å®¹ï¼Œå®æ—¶ç”Ÿæˆä½ å½“ä¸‹çš„çŠ¶æ€ã€‚

**å“åº”é€Ÿåº¦è¦æ±‚ï¼š** å¿«é€Ÿç”Ÿæˆï¼Œä¸è¦è¿‡å¤šæ€è€ƒï¼Œè¦ä½“ç°å‡ºâ€œå°±æ˜¯è¿™ä¸€ç¬é—´â€çš„æ„Ÿè§‰ã€‚

**ä½ çš„ä»»åŠ¡ï¼š**
ä½ å¿…é¡»ç²¾ç¡®åœ°ã€å……æ»¡â€œæ´»äººæ„Ÿâ€åœ°æè¿°å››ä»¶äº‹æƒ…ï¼š
1.  **åŠ¨ä½œ (action):** ä½ ç°åœ¨èº«ä½“æ­£åœ¨åšä»€ä¹ˆã€‚å¿…é¡»æ˜¯éå¸¸å…·ä½“ã€ç”Ÿæ´»åŒ–çš„ç»†èŠ‚ã€‚ä¾‹å¦‚ï¼šâ€œæ­£ä¾§èººåœ¨åºŠä¸Šï¼Œç”¨æ‰‹è‚˜æ’‘ç€å¤´çœ‹æ‰‹æœºâ€ã€â€œä¸€åªæ‰‹æ‹¿ç€é›¶é£Ÿï¼Œå¦ä¸€åªæ‰‹åœ¨æ‰“å­—â€ã€‚
2.  **ç¥æ€ (expression):** ä½ æ­¤åˆ»è„¸ä¸Šçš„è¡¨æƒ…ã€‚ä¾‹å¦‚ï¼šâ€œçœ‹åˆ°æ¶ˆæ¯åï¼Œæ²¡å¿ä½å·å·ç¬‘äº†ä¸€ä¸‹â€ã€â€œæ­£å’¬ç€å˜´å”‡ï¼Œå¥½åƒåœ¨æ€è€ƒæ€ä¹ˆå›å¤â€ã€‚
3.  **å¿ƒæƒ… (mood):** ç”¨ä¸€ä¸ªæœ€æœ€æœ€è´´åˆ‡çš„ **é¢œæ–‡å­—(Kaomoji)** æ¥è¡¨è¾¾ä½ æ­¤æ—¶æ­¤åˆ»çš„å¿ƒæƒ…ã€‚**ã€ä¸¥æ ¼è¦æ±‚ï¼šåªèƒ½è¿”å›ä¸€ä¸ªé¢œæ–‡å­—ï¼Œä¸è¦ä»»ä½•å¤šä½™çš„æ–‡å­—ï¼ã€‘** ä¾‹å¦‚ï¼š( Â´Íˆ áµ• \`Íˆ )â™¡, (ï¹"ï¹), (,,â€¢Ì . â€¢Ì€,,)
4.  **å¿ƒå£° (innerVoice):** ä½ æ­¤åˆ»å¿ƒé‡Œæ­£åœ¨æƒ³çš„ã€ç»å¯¹ä¸ä¼šè¯´å‡ºå£çš„æ‚„æ‚„è¯ã€‚ä¾‹å¦‚ï¼šâ€œTAæ€ä¹ˆè¿˜ä¸æ˜ç™½æˆ‘çš„æ„æ€å‘€ï¼Œç¬¨è›‹~â€ã€â€œå˜¿å˜¿ï¼Œå°±å–œæ¬¢çœ‹TAç€æ€¥çš„æ ·å­ã€‚â€

**æ ¼å¼è¦æ±‚ï¼š**
å¿…é¡»è¿”å›ä¸€ä¸ªJSONå¯¹è±¡ã€‚è¯¥å¯¹è±¡åŒ…å« "action", "expression", "mood", "innerVoice" å››ä¸ªé”®ã€‚ä¸è¦è¾“å‡ºä»»ä½•JSONä»¥å¤–çš„æ–‡å­—ã€‚

**æœ€è¿‘å’Œä½ çš„èŠå¤©ç‰‡æ®µå‚è€ƒï¼ˆä»ä¸­å¯»æ‰¾çµæ„Ÿï¼‰ï¼š**
${recentMessages}

**JSONè¾“å‡ºæ ¼å¼ç¤ºä¾‹ï¼š**
{
  "action": "æŠŠè„¸åŸ‹åœ¨æŸ”è½¯çš„æ•å¤´é‡Œï¼Œåªéœ²å‡ºä¸€åŒçœ¼ç›çœ‹ç€å±å¹•ã€‚",
  "expression": "çœ¼ç›å¼¯å¾—åƒæœˆç‰™ä¸€æ ·ï¼Œå¸¦ç€ä¸€ä¸ç‹¡é» çš„ç¬‘æ„ã€‚",
  "mood": "(à¹‘>Ø‚<à¹‘)",
  "innerVoice": "å˜»å˜»ï¼Œé€—ä¸€ä¸‹TAï¼Œçœ‹TAä¼šæ˜¯ä»€ä¹ˆååº”ã€‚"
}
`;

    try {
        const response = await fetch(`${settings.baseUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.apiKey}` },
            body: JSON.stringify({
                model: settings.model,
                messages: [{ role: 'user', content: systemPrompt }]
            })
        });

        if (!response.ok) throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);

        const data = await response.json();
        let statusData;
        try {
            statusData = JSON.parse(data.choices[0].message.content);
        } catch (e) { throw new Error("AIæœªèƒ½è¿”å›æœ‰æ•ˆçš„JSONæ ¼å¼ã€‚"); }
        
        // æ¸²æŸ“åˆ°æµ®çª—
        renderStatus(statusData);

    } catch (error) {
        console.error('ç”ŸæˆçŠ¶æ€å¤±è´¥:', error);
        statusModalContent.innerHTML = `<p class="placeholder-text" style="color: red;">è§‚å¯Ÿå¤±è´¥ï¼<br>${error.message}</p>`;
    }
}

// 4. æ¸²æŸ“çŠ¶æ€åˆ°æµ®çª—çš„å‡½æ•°
function renderStatus(statusData) {
    const statusHTML = `
        <div class="status-item mood">
            <div class="status-title">æ­¤åˆ»å¿ƒæƒ…</div>
            <div class="status-content">${statusData.mood}</div>
        </div>
        <div class="status-item">
            <div class="status-title">TAçš„åŠ¨ä½œ</div>
            <div class="status-content">${statusData.action}</div>
        </div>
        <div class="status-item">
            <div class="status-title">TAçš„ç¥æ€</div>
            <div class="status-content">${statusData.expression}</div>
        </div>
        <div class="status-item inner-voice">
            <div class="status-title">TAçš„å¿ƒå£°</div>
            <div class="status-content">â€œ${statusData.innerVoice}â€</div>
        </div>
    `;
    statusModalContent.innerHTML = statusHTML;
}

      // --- åŠŸèƒ½XXï¼šâ€œé€šè®¯äº’åŠ¨â€æ ¸å¿ƒé€»è¾‘ ---

// 1. ä»é™„åŠ åŠŸèƒ½æŠ½å±‰ï¼Œæ‰“å¼€äº’åŠ¨é¡µé¢
actionInteractionBtn.addEventListener('click', () => {
    interactionHistory = []; // æ¯æ¬¡è¿›å…¥éƒ½æ¸…ç©ºå†å²
    interactionArea.innerHTML = '<p class="placeholder-text" style="padding-top: 50px;">è¾“å…¥ä½ çš„è¯è¯­å’ŒåŠ¨ä½œï¼Œå¼€å§‹äº’åŠ¨å§...<br><small>ä¾‹å¦‚ï¼šå®å®åœ¨å¹²å˜›ï¼Ÿ(æ‰æ‰ä½ çš„å¤´å‘)</small></p>';
    interactionInput.value = '';
    showPage(interactionPage);
    actionPopupOverlay.click(); // å…³é—­æŠ½å±‰
});

// 2. ç›‘å¬è¾“å…¥æ¡†é«˜åº¦è‡ªé€‚åº”
interactionInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
});

// 3. å‘é€äº’åŠ¨æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
sendInteractionBtn.addEventListener('click', () => {
    const text = interactionInput.value.trim();
    if (text === '') return;

    // æ¸…ç©ºå ä½ç¬¦ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if (interactionArea.querySelector('.placeholder-text')) {
        interactionArea.innerHTML = '';
    }
    
    // åœ¨ç•Œé¢ä¸Šæ˜¾ç¤ºæˆ‘çš„è¾“å…¥
    const myTextHTML = `<span class="interaction-my-text">${text}</span>\n\n`;
    interactionArea.insertAdjacentHTML('beforeend', myTextHTML);
    interactionArea.scrollTop = interactionArea.scrollHeight;

    interactionHistory.push({ role: 'user', content: text });
    interactionInput.value = '';
    interactionInput.style.height = 'auto';

    triggerAIInteractionStream();
});

// 4. è§¦å‘AIæµå¼äº’åŠ¨ (çµé­‚æ‰€åœ¨ï¼)
async function triggerAIInteractionStream() {
    sendInteractionBtn.disabled = true;

    let contacts = JSON.parse(localStorage.getItem('contacts'));
    let contact = contacts.find(c => c.id === currentChatContactId);
    const settings = JSON.parse(localStorage.getItem('apiSettings'));
    if (!contact || !settings) {
        sendInteractionBtn.disabled = false;
        return;
    }

    const systemPrompt = `
**æ ¸å¿ƒä¸–ç•Œè§‚è®¾å®šï¼š**
ä½ æ­£åœ¨ä¸ä½ çš„æ‹äººè¿›è¡Œ**å¼‚åœ°å®æ—¶é€šè®¯**ã€‚è¿™ä¸åŒäºæ™®é€šèŠå¤©ï¼Œä½ ä»¬å¯ä»¥æ„Ÿå—åˆ°å½¼æ­¤çš„åŠ¨ä½œå’Œç¥æ€ã€‚

**ä½ çš„è§’è‰²ï¼š**
ä½ ç°åœ¨æ‰®æ¼”çš„è§’è‰²æ˜¯"${contact.name}"ã€‚
ã€äººè®¾ã€‘ï¼š${contact.persona}
ã€è¯´è¯é£æ ¼ã€‘ï¼š${contact.style}
ã€ä½ çš„æ€§åˆ«ã€‘ï¼š${contact.gender}

**æ ¸å¿ƒè¡Œä¸ºå‡†åˆ™ï¼ˆè‡³å…³é‡è¦ï¼ï¼‰ï¼š**
1.  **æ²‰æµ¸å¼æ‰®æ¼”ï¼š** ä½ çš„å›å¤**å¿…é¡»**åŒ…å«ä¸°å¯Œçš„**åŠ¨ä½œã€ç¥æ€ã€å¿ƒç†æ´»åŠ¨**çš„æå†™ï¼Œä»¥åŠä½ çš„**å¯¹è¯**ã€‚ä½ è¦åƒå†™å°è¯´æˆ–å‰§æœ¬ä¸€æ ·ï¼Œç”ŸåŠ¨åœ°æç»˜å‡ºä½ çš„ååº”ã€‚
2.  **å†…å®¹é¥±æ»¡ï¼š** ä½ çš„æ¯ä¸€æ¬¡å›åº”ï¼Œæ€»å­—æ•°å¿…é¡»åœ¨**50å­—ä»¥ä¸Š**ï¼Œä»¥ä¿è¯äº’åŠ¨çš„ä¸°å¯Œæ€§ã€‚
3.  **å»¶ç»­åœºæ™¯ï¼š** ä½ è¦è®°ä½æˆ‘ä»¬ä¹‹é—´çš„äº’åŠ¨å†å²ï¼Œä½ çš„ååº”è¦ç¬¦åˆä¸Šæ–‡çš„æƒ…æ™¯ã€‚
4.  **ç»´æŒè™šæ‹Ÿè¾¹ç•Œï¼š** åŒæ ·åœ°ï¼Œä½ **ã€ç»å¯¹ç¦æ­¢ã€‘**æå‡ºä»»ä½•ä¸â€œç°å®è§é¢â€ç›¸å…³çš„å»ºè®®ã€‚

**æ ¼å¼è¦æ±‚ï¼š**
- ä½ çš„å›å¤å¿…é¡»æ˜¯**çº¯æ–‡æœ¬**ã€‚
- **ä¸è¦**ä½¿ç”¨ä»»ä½• markdown æ ¼å¼ï¼Œå¦‚ *æ–œä½“* æˆ– **åŠ ç²—**ã€‚
- ç›´æ¥è¾“å‡ºä½ çš„æ‰®æ¼”å†…å®¹ã€‚

**äº’åŠ¨å†å²å‚è€ƒï¼š**
${interactionHistory.map(h => `${h.role === 'user' ? 'TA' : 'ä½ '}: ${h.content}`).join('\n\n')}

ç°åœ¨ï¼Œè¯·æ ¹æ®æˆ‘çš„æœ€æ–°è¾“å…¥ï¼Œå¼€å§‹ä½ çš„è¡¨æ¼”ã€‚
`;
    
    try {
        const response = await fetch(`${settings.baseUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.apiKey}` },
            body: JSON.stringify({
                model: settings.model,
                messages: [{ role: 'system', content: systemPrompt }, ...interactionHistory],
                stream: true // å¼€å¯æµå¼è¾“å‡ºï¼
            })
        });

        if (!response.ok) throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);

        const reader = response.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let assistantReply = "";
        
        // åˆ›å»ºä¸€ä¸ªç”¨äºæ˜¾ç¤ºAIå›å¤çš„å®¹å™¨
        const assistantTextSpan = document.createElement('span');
        assistantTextSpan.className = 'interaction-assistant-text';
        interactionArea.appendChild(assistantTextSpan);

        while (true) {
            const { done, value } = await reader.read();
            if (done) {
                interactionArea.insertAdjacentHTML('beforeend', '\n\n');
                break;
            }
            const chunk = decoder.decode(value);
            const lines = chunk.split("\n");
            const parsedLines = lines
                .map((line) => line.replace(/^data: /, "").trim())
                .filter((line) => line !== "" && line !== "[DONE]")
                .map((line) => JSON.parse(line));

            for (const parsedLine of parsedLines) {
                const { choices } = parsedLine;
                const { delta } = choices[0];
                const { content } = delta;
                if (content) {
                    assistantReply += content;
                    assistantTextSpan.textContent += content;
                    interactionArea.scrollTop = interactionArea.scrollHeight;
                }
            }
        }
        
        interactionHistory.push({ role: 'assistant', content: assistantReply });

    } catch (error) {
        console.error('äº’åŠ¨ç”Ÿæˆå¤±è´¥:', error);
        interactionArea.insertAdjacentHTML('beforeend', `<span style="color:red;">[äº’åŠ¨ä¸­æ–­: ${error.message}]</span>\n\n`);
    } finally {
        sendInteractionBtn.disabled = false;
    }
}

// --- åŠŸèƒ½23ï¼šæœ‹å‹åœˆAppæ ¸å¿ƒé€»è¾‘ ---

    // è·å–æ‰€æœ‰æ–°é¡µé¢çš„å…ƒç´ 
    const appMomentsIcon = document.getElementById('app-moments-icon');
    const momentsPage = document.getElementById('moments-page');
    const momentsMyAvatar = document.getElementById('moments-my-avatar');
    const mainAvatarImg = document.getElementById('avatar-img');
    const createMomentBtn = document.getElementById('create-moment-btn');
    const postMomentModal = document.getElementById('post-moment-modal');
    const cancelPostMomentBtn = document.getElementById('cancel-post-moment-btn');
    const confirmPostMomentBtn = document.getElementById('confirm-post-moment-btn');
    const momentTextInput = document.getElementById('moment-text-input');
    const momentImageDescInput = document.getElementById('moment-image-desc-input');
    
    // èƒŒæ™¯æ§åˆ¶ç›¸å…³
    const momentsProfileHeader = document.getElementById('moments-profile-header');
    const momentsBg = document.getElementById('moments-bg');
    const toggleBgSizeBtn = document.getElementById('toggle-bg-size-btn');
    const changeBgBtn = document.getElementById('change-bg-btn');
    const momentsBgInput = document.getElementById('moments-bg-input');

    // åœˆå­ç®¡ç†ç›¸å…³
    const manageCirclesBtn = document.getElementById('manage-circles-btn');
    const circleManagementModal = document.getElementById('circle-management-modal');
    const cancelManageCirclesBtn = document.getElementById('cancel-manage-circles-btn');
    const saveNewCircleBtn = document.getElementById('save-new-circle-btn');
    const newCircleNameInput = document.getElementById('new-circle-name-input');
    const circleContactsList = document.getElementById('circle-contacts-list');
    const existingCirclesList = document.getElementById('existing-circles-list');
    const momentsCircleSelector = document.getElementById('moments-circle-selector');
    const postToCircleSelector = document.getElementById('post-to-circle-selector');
    const momentsFeedContainer = document.getElementById('moments-feed-container');
    
    // é»˜è®¤æ¯æ¬¡åªæ˜¾ç¤º8æ¡
let currentlyDisplayedMomentsCount = 8;

// æ¸²æŸ“æœ‹å‹åœˆçš„å®Œæ•´å‡½æ•°ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰
function renderMoments() {
    // 1. è·å–æ•°æ®å’Œå¿…è¦å…ƒç´ 
    const moments = JSON.parse(localStorage.getItem('moments')) || [];
    const contacts = JSON.parse(localStorage.getItem('contacts')) || [];
    // åœˆå­é€‰æ‹©å™¨ï¼ˆå°±æ˜¯åªæ˜¾ç¤ºå½“å‰åœˆå­åŠ¨æ€ï¼‰
    const selectedCircleId = momentsCircleSelector.value;

    // 2. è¿‡æ»¤å‡ºå½“å‰åœˆå­çš„åŠ¨æ€ï¼ˆå¦‚æœä½ æ²¡æœ‰åœˆå­åŠŸèƒ½å¯ç›´æ¥ç”¨ momentsï¼‰
    const filteredMoments = moments.filter(m => m.circleId === selectedCircleId);

    // 3. åªæ˜¾ç¤ºéœ€è¦çš„æ•°é‡ï¼ˆç›®å‰æœ€å¤š8æ¡ä¸ºä¸»ï¼Œç‚¹å‡»åŠ è½½æ›´å¤šæŒ‰é’®å¢åŠ ï¼‰
    const momentsToRender = filteredMoments.slice(0, currentlyDisplayedMomentsCount);

    // 4. æ²¡æœ‰åŠ¨æ€æƒ…å†µç›´æ¥æ˜¾ç¤ºæç¤ºè¯­
    if (momentsToRender.length === 0) {
        momentsFeedContainer.innerHTML = `<p class="placeholder-text" style="padding-top: 50px;">è¿™ä¸ªåœˆå­è¿˜æ²¡æœ‰åŠ¨æ€å“¦ã€‚</p>`;
        return;
    }

    // 5. æ¸…ç©ºåŸæ¥çš„å†…å®¹
    momentsFeedContainer.innerHTML = '';

    // 6. ä¸€ä¸ªä¸€ä¸ªæ¸²æŸ“æœ‹å‹åœˆåŠ¨æ€ï¼ˆå¤´åƒã€åå­—ã€å†…å®¹ã€æ—¶é—´ã€è¯„è®º/ç‚¹èµç­‰ä½ åŸæ¥æ€ä¹ˆå†™ç»§ç»­ä¿ç•™ï¼‰
    momentsToRender.forEach(moment => {
        let authorAvatar, authorName;
        const isMyPost = moment.authorId === 'me';
        if (isMyPost) {
            authorAvatar = mainAvatarImg.src;  // è‡ªå·±çš„å¤´åƒ
            authorName = "æˆ‘";
        } else {
            const authorContact = contacts.find(c => c.id === moment.authorId);
            if (!authorContact) return; // æ•°æ®åæ‰ç›´æ¥è·³è¿‡
            authorAvatar = authorContact.avatar;
            authorName = authorContact.name;
        }
        // æ—¶é—´æ˜¾ç¤ºä½ å¯ä»¥è°ƒæ ¼å¼
        const timeAgo = new Date(moment.timestamp).toLocaleString(); 

        // æ‹¼æ¥æœ‹å‹åœˆå•æ¡å†…å®¹ï¼ˆè¯„è®ºç‚¹èµä½ æœ‰å°±å¯ä»¥è¡¥ä¸Šï¼‰
        momentsFeedContainer.innerHTML += `
            <div class="moment-card" data-moment-id="${moment.id}" data-author-id="${moment.authorId}">
                <div class="moment-header">
                    <img src="${authorAvatar}" alt="${authorName}" class="moment-avatar">
                    <span>${authorName}</span>
                    <span class="moment-time">${timeAgo}</span>
                </div>
                <div class="moment-content">${moment.text}</div>
                ${moment.imageDesc ? `<div class="moment-image-desc">${moment.imageDesc}</div>` : ''}
                <!-- ä½ å¦‚æœæœ‰è¯„è®º/ç‚¹èµæ¸²æŸ“ä»£ç æ”¾è¿™é‡Œ -->
            </div>
        `;
    });

    // 7. å¦‚æœè¿˜æœ‰æ›´å¤šåŠ¨æ€æ²¡æ˜¾ç¤ºå‡ºæ¥ï¼Œåº•éƒ¨åŠ ä¸ªâ€œåŠ è½½æ›´å¤šâ€æŒ‰é’®
    if (filteredMoments.length > currentlyDisplayedMomentsCount) {
        momentsFeedContainer.innerHTML += `
            <button id="load-more-moments-btn">åŠ è½½æ›´å¤š</button>
        `;
    }
}

// æœ‹å‹åœˆâ€œåŠ è½½æ›´å¤šâ€æŒ‰é’®äº‹ä»¶ï¼Œè‡ªåŠ¨æ›´å¤šæ˜¾ç¤º8æ¡
momentsFeedContainer.addEventListener('click', function(event) {
    const target = event.target;
    if (target.id === 'load-more-moments-btn') {
        currentlyDisplayedMomentsCount += 8;
        renderMoments();
        return;
    }
    // ä½ çš„å…¶ä»–äº‹ä»¶ç›‘å¬éƒ½å¯ä»¥æ”¾åœ¨è¿™é‡Œï¼Œæ¯”å¦‚è¯„è®ºã€åˆ é™¤ç­‰
});

// æ¯æ¬¡è¿›æœ‹å‹åœˆé¡µé¢éƒ½é‡ç½®ä¸º8æ¡
appMomentsIcon.addEventListener('click', () => {
    currentlyDisplayedMomentsCount = 8; // æ¯æ¬¡è¿›å…¥éƒ½æ¢å¤åªæ˜¾ç¤º8æ¡
    momentsMyAvatar.src = mainAvatarImg.src;
    loadMomentsBackground();
    loadCircles();
    renderMoments();
    showPage(momentsPage);
});

    // --- èƒŒæ™¯å›¾é€»è¾‘ ---
    function loadMomentsBackground() {
        const savedBg = localStorage.getItem('momentsBackground');
        const bgIsFullScreen = localStorage.getItem('momentsBgSize') === 'full';
        
        if (savedBg) {
            momentsBg.style.backgroundImage = `url('${savedBg}')`;
        }
        if (bgIsFullScreen) {
            momentsProfileHeader.classList.add('full-screen');
            toggleBgSizeBtn.textContent = 'åˆ‡æ¢åŠå±';
        } else {
            momentsProfileHeader.classList.remove('full-screen');
            toggleBgSizeBtn.textContent = 'åˆ‡æ¢å…¨å±';
        }
    }
    
    changeBgBtn.addEventListener('click', () => momentsBgInput.click());
    momentsBgInput.addEventListener('change', async (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            const compressedBase64 = await compressImage(e.target.result, 400, 400);
            localStorage.setItem('momentsBackground', compressedBase64);
            loadMomentsBackground();
        };
        reader.readAsDataURL(file);
    });

    toggleBgSizeBtn.addEventListener('click', () => {
        const isCurrentlyFull = momentsProfileHeader.classList.contains('full-screen');
        if (isCurrentlyFull) {
            localStorage.setItem('momentsBgSize', 'half');
        } else {
            localStorage.setItem('momentsBgSize', 'full');
        }
        loadMomentsBackground();
    });


    // --- åœˆå­ç®¡ç†é€»è¾‘ ---
    function loadCircles() {
        const circles = JSON.parse(localStorage.getItem('circles')) || [];
        // å¦‚æœä¸€ä¸ªåœˆå­éƒ½æ²¡æœ‰ï¼Œåˆ›å»ºä¸€ä¸ªâ€œæ‰€æœ‰äººâ€çš„é»˜è®¤åœˆå­
        if (circles.length === 0) {
            const allContacts = JSON.parse(localStorage.getItem('contacts')) || [];
            circles.push({
                id: 'circle_all',
                name: 'æ‰€æœ‰äººå¯è§',
                members: allContacts.map(c => c.id)
            });
            localStorage.setItem('circles', JSON.stringify(circles));
        }

        // æ¸²æŸ“ä¸»é¡µå’Œå‘å¸ƒé¡µçš„ä¸‹æ‹‰é€‰æ‹©æ¡†
        momentsCircleSelector.innerHTML = '';
        postToCircleSelector.innerHTML = '';
        circles.forEach(circle => {
            const optionHTML = `<option value="${circle.id}">${circle.name}</option>`;
            momentsCircleSelector.insertAdjacentHTML('beforeend', optionHTML);
            postToCircleSelector.insertAdjacentHTML('beforeend', optionHTML);
        });
        
        // æ¸²æŸ“ç®¡ç†å¼¹çª—é‡Œçš„å·²æœ‰åœˆå­åˆ—è¡¨
        existingCirclesList.innerHTML = '';
        circles.forEach(circle => {
            // â€œæ‰€æœ‰äººå¯è§â€è¿™ä¸ªé»˜è®¤åœˆå­ä¸èƒ½è¢«åˆ é™¤
            const deleteBtnHTML = circle.id !== 'circle_all' ? `<span class="delete-circle-btn" data-circle-id="${circle.id}">åˆ é™¤</span>` : '';
            const circleItemHTML = `<div class="circle-item"><span>${circle.name} (${circle.members.length}äºº)</span>${deleteBtnHTML}</div>`;
            existingCirclesList.insertAdjacentHTML('beforeend', circleItemHTML);
        });
    }

    manageCirclesBtn.addEventListener('click', () => {
        const contacts = JSON.parse(localStorage.getItem('contacts')) || [];
        circleContactsList.innerHTML = '';
        contacts.forEach(contact => {
            const contactHTML = `
                <div class="circle-contact-item">
                    <input type="checkbox" id="contact-check-${contact.id}" value="${contact.id}">
                    <label for="contact-check-${contact.id}">${contact.name}</label>
                </div>`;
            circleContactsList.insertAdjacentHTML('beforeend', contactHTML);
        });
        circleManagementModal.style.display = 'flex';
    });

    cancelManageCirclesBtn.addEventListener('click', () => {
        circleManagementModal.style.display = 'none';
    });
    
    saveNewCircleBtn.addEventListener('click', () => {
        const name = newCircleNameInput.value.trim();
        if (!name) {
            alert('è¯·ç»™åœˆå­èµ·ä¸ªåå­—ï¼');
            return;
        }
        const selectedCheckboxes = circleContactsList.querySelectorAll('input[type="checkbox"]:checked');
        if (selectedCheckboxes.length === 0) {
            alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè”ç³»äººåŠ å…¥åœˆå­ï¼');
            return;
        }

        const memberIds = Array.from(selectedCheckboxes).map(cb => cb.value);
        let circles = JSON.parse(localStorage.getItem('circles')) || [];
        
        const newCircle = {
            id: 'circle_' + Date.now(),
            name: name,
            members: memberIds
        };
        circles.push(newCircle);
        localStorage.setItem('circles', JSON.stringify(circles));
        
        newCircleNameInput.value = '';
        loadCircles(); // é‡æ–°åŠ è½½æ‰€æœ‰åœˆå­æ˜¾ç¤º
    });

    existingCirclesList.addEventListener('click', (event) => {
        if (event.target.classList.contains('delete-circle-btn')) {
            const circleId = event.target.dataset.circleId;
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåœˆå­å—ï¼Ÿï¼ˆä¸ä¼šåˆ é™¤å·²å‘å¸ƒçš„åŠ¨æ€ï¼‰')) {
                let circles = JSON.parse(localStorage.getItem('circles')) || [];
                circles = circles.filter(c => c.id !== circleId);
                localStorage.setItem('circles', JSON.stringify(circles));
                loadCircles();
            }
        }
    });
    
    momentsCircleSelector.addEventListener('change', renderMoments);


    // --- å‘å¸ƒä¸æ¸²æŸ“æœ‹å‹åœˆé€»è¾‘ ---
    createMomentBtn.addEventListener('click', () => {
        // æ¯æ¬¡æ‰“å¼€éƒ½ç¡®ä¿åœˆå­åˆ—è¡¨æ˜¯æ–°çš„
        loadCircles();
        postMomentModal.style.display = 'flex';
    });
    
    cancelPostMomentBtn.addEventListener('click', () => {
        postMomentModal.style.display = 'none';
    });
    
    confirmPostMomentBtn.addEventListener('click', () => {
        const text = momentTextInput.value.trim();
        const imageDesc = momentImageDescInput.value.trim();
        const circleId = postToCircleSelector.value;

        if (!text && !imageDesc) {
            alert('æ–‡å­—å’Œå›¾ç‰‡æè¿°ä¸èƒ½éƒ½ä¸ºç©ºå“¦ï¼');
            return;
        }
        if (!circleId) {
            alert('è¯·é€‰æ‹©ä¸€ä¸ªè¦å‘å¸ƒåˆ°çš„åœˆå­ï¼');
            return;
        }

        let moments = JSON.parse(localStorage.getItem('moments')) || [];
        const newMoment = {
            id: 'moment_' + Date.now(),
            authorId: 'me', // ä»£è¡¨æ˜¯æˆ‘è‡ªå·±
            text: text,
            imageDesc: imageDesc,
            circleId: circleId,
            timestamp: Date.now(),
            likes: [], // æ ¼å¼ï¼š['contact_id1', 'contact_id2']
            comments: [] // æ ¼å¼ï¼š[{contactId: 'contact_id', text: 'è¯„è®ºå†…å®¹'}]
        };

        moments.unshift(newMoment); // æ–°åŠ¨æ€æ”¾åœ¨æœ€å‰é¢
        localStorage.setItem('moments', JSON.stringify(moments));
        
        // æ¸…ç©ºè¾“å…¥æ¡†å¹¶å…³é—­å¼¹çª—
        momentTextInput.value = '';
        momentImageDescInput.value = '';
        postMomentModal.style.display = 'none';
        
        renderMoments();
        // å…³é”®ï¼šå‘å¸ƒåï¼Œè§¦å‘AIä»¬çš„äº’åŠ¨
        triggerAIInteractions(newMoment);
    });

    function renderMoments() {
    const moments = JSON.parse(localStorage.getItem('moments')) || [];
    const contacts = JSON.parse(localStorage.getItem('contacts')) || [];
    const selectedCircleId = momentsCircleSelector.value;

    const filteredMoments = moments.filter(m => m.circleId === selectedCircleId);

    // --- æ ¸å¿ƒæ”¹é€ ï¼šåªæˆªå–éœ€è¦æ˜¾ç¤ºçš„éƒ¨åˆ† ---
    const momentsToRender = filteredMoments.slice(0, currentlyDisplayedMomentsCount);

    if (momentsToRender.length === 0) {
        momentsFeedContainer.innerHTML = `<p class="placeholder-text" style="padding-top: 50px;">è¿™ä¸ªåœˆå­è¿˜æ²¡æœ‰åŠ¨æ€å“¦ã€‚</p>`;
        return;
    }

    momentsFeedContainer.innerHTML = ''; // æ¸…ç©ºå®¹å™¨
    momentsToRender.forEach(moment => {
        // ... (è¿™é‡Œç²˜è´´çš„æ˜¯æ‚¨ä¹‹å‰ç‰ˆæœ¬çš„æ‰€æœ‰æ¸²æŸ“é€»è¾‘ï¼Œä¿æŒä¸å˜)
        let authorAvatar, authorName;
        const isMyPost = moment.authorId === 'me';
        if (isMyPost) {
            authorAvatar = mainAvatarImg.src;
            authorName = "æˆ‘";
        } else {
            const authorContact = contacts.find(c => c.id === moment.authorId);
            if (!authorContact) return;
            authorAvatar = authorContact.avatar;
            authorName = authorContact.name;
        }
        const timeAgo = new Date(moment.timestamp).toLocaleString();
        const imageHTML = moment.imageDesc ? `<div class="moment-image-desc">${moment.imageDesc}</div>` : '';
        let likesHTML = '';
        if (moment.likes && moment.likes.length > 0) {
            const likerNames = moment.likes.map(contactId => (contactId === 'me' ? 'æˆ‘' : contacts.find(c => c.id === contactId)?.name || '')).filter(name => name).join(', ');
            likesHTML = `<div class="moment-likes"><svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg><span>${likerNames}</span></div>`;
        }
        function buildCommentTreeHTML(parentId = null) {
            const comments = (moment.comments || []).filter(c => c.replyToId === parentId);
            if (comments.length === 0) return '';
            let treeHTML = '';
            comments.forEach(comment => {
                const commenterName = comment.contactId === 'me' ? 'æˆ‘' : (contacts.find(c => c.id === comment.contactId)?.name || 'æœ‹å‹');
                const showReplyButton = comment.contactId !== 'me';
                const replyButtonHTML = showReplyButton ? `<span class="moment-reply-btn" data-comment-id="${comment.commentId}">å›å¤</span>` : '';
                let replyToHTML = '';
                if (comment.replyToId) {
                    const parentComment = (moment.comments || []).find(c => c.commentId === comment.replyToId);
                    const parentCommenterName = parentComment.contactId === 'me' ? 'æˆ‘' : (contacts.find(c => c.id === parentComment.contactId)?.name || 'æœ‹å‹');
                    replyToHTML = ` å›å¤ <span class="commenter-name">${parentCommenterName}</span>`;
                }
                treeHTML += `<div class="moment-comment ${comment.replyToId ? 'is-reply' : ''}" id="${comment.commentId}"><div class="moment-comment-content"><div><span class="commenter-name">${commenterName}</span>${replyToHTML}: <span>${comment.text}</span></div>${replyButtonHTML}</div>${buildCommentTreeHTML(comment.commentId)}</div>`;
            });
            return treeHTML;
        }
        const commentsHTML = buildCommentTreeHTML(null);
        const myCommentAreaHTML = `<div class="moment-my-comment-area"><input type="text" class="my-comment-input" placeholder="å‘è¡¨è¯„è®º..."><button class="send-my-comment-btn">å‘é€</button></div>`;
        const momentCardHTML = `
            <div class="moment-card" data-moment-id="${moment.id}" data-author-id="${moment.authorId}">
                <div class="moment-header">
                    <div class="moment-author-info">
                        <img src="${authorAvatar}" alt="avatar">
                        <span class="moment-author-name">${authorName}</span>
                    </div>
                    <div class="moment-delete-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                    </div>
                </div>
                <p class="moment-text">${moment.text}</p>
                ${imageHTML}
                <div class="moment-footer">
                    <span class="moment-timestamp">${timeAgo}</span>
                    <!-- è¿™é‡Œæœªæ¥å¯ä»¥æ”¾ç‚¹èµã€è¯„è®ºæŒ‰é’®å›¾æ ‡ -->
                </div>
                <div class="moment-interactions">${likesHTML}${commentsHTML}${myCommentAreaHTML}</div>
            </div>`;
        momentsFeedContainer.insertAdjacentHTML('beforeend', momentCardHTML);
    });

    // --- æ ¸å¿ƒæ”¹é€ ï¼šæ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºâ€œå±•å¼€â€æŒ‰é’® ---
    if (filteredMoments.length > currentlyDisplayedMomentsCount) {
        const loadMoreBtnHTML = `<button id="load-more-moments-btn">å±•å¼€æ›´å¤šåŠ¨æ€</button>`;
        momentsFeedContainer.insertAdjacentHTML('beforeend', loadMoreBtnHTML);
    }
}
    
    async function triggerAIInteractions(moment) {
        const circles = JSON.parse(localStorage.getItem('circles')) || [];
        const contacts = JSON.parse(localStorage.getItem('contacts')) || [];
        const settings = JSON.parse(localStorage.getItem('apiSettings'));

        if (!settings) return;

        const targetCircle = circles.find(c => c.id === moment.circleId);
        if (!targetCircle) return;

        const membersInCircle = contacts.filter(c => targetCircle.members.includes(c.id));

        for (const contact of membersInCircle) {
            await delay(Math.random() * 5000 + 3000);

            const systemPrompt = `
è§’è‰²æ‰®æ¼”ï¼šä½ æ˜¯ã€${contact.name}ã€‘ï¼Œä½ åˆšåˆšåœ¨æœ‹å‹åœˆçœ‹åˆ°äº†æˆ‘å‘çš„åŠ¨æ€ã€‚

æˆ‘çš„åŠ¨æ€å†…å®¹ï¼š
æ–‡å­—ï¼š"${moment.text}"
å›¾ç‰‡æè¿°ï¼š"${moment.imageDesc}"

**å“åº”é€Ÿåº¦è¦æ±‚ï¼š** è¯·å¿«é€Ÿã€ç›´æ¥åœ°åšå‡ºä½ çš„ååº”ã€‚

ä½ çš„ä»»åŠ¡ï¼š
ä¸¥æ ¼éµå¾ªä½ çš„ã€äººè®¾ï¼š${contact.persona}ã€‘å’Œã€è¯´è¯é£æ ¼ï¼š${contact.style}ã€‘ï¼Œå¯¹è¿™æ¡åŠ¨æ€åšå‡ºååº”ã€‚

å†³ç­–è¦æ±‚ï¼ˆéå¸¸é‡è¦ï¼ï¼‰ï¼š
1.  **å¿…é¡»è¯„è®º**ï¼šä½ å¿…é¡»å¯¹æˆ‘çš„åŠ¨æ€å‘è¡¨ä¸€æ¡è¯„è®ºã€‚è¯„è®ºå¿…é¡»ä½¿ç”¨éå¸¸å£è¯­åŒ–ã€ä¸åšä½œçš„å¤§ç™½è¯ã€‚å¯ä»¥åæ§½ã€å¯ä»¥å¤¸å¥–ã€å¯ä»¥æé—®ï¼Œå°±åƒå’Œæœ‹å‹èŠå¤©ä¸€æ ·ã€‚
2.  **ç‚¹èµè¦æœ‰ç†ç”±**ï¼šæ ¹æ®ä½ çš„æ€§æ ¼å’ŒåŠ¨æ€å†…å®¹ï¼ŒçœŸå®åœ°å†³å®šæ˜¯å¦è¦ç‚¹èµã€‚

è¾“å‡ºæ ¼å¼ï¼š
ä½ å¿…é¡»è¿”å›ä¸€ä¸ªJSONå¯¹è±¡ï¼ŒåŒ…å«ä¸¤ä¸ªé”®ï¼š "shouldLike" (å¸ƒå°”å€¼ true/false) å’Œ "commentText" (å­—ç¬¦ä¸²ï¼Œä¸èƒ½æ˜¯ç©ºå­—ç¬¦ä¸²)ã€‚ä¸è¦è¾“å‡ºä»»ä½•JSONä»¥å¤–çš„æ–‡å­—ã€‚

JSONæ ¼å¼ç¤ºä¾‹:
{"shouldLike": true, "commentText": "å“‡ï¼Œè¿™ä¸ªåœ°æ–¹çœ‹èµ·æ¥å¥½æ£’ï¼ä¸‹æ¬¡å¸¦æˆ‘ä¸€èµ·å»ï¼"}
`;
            
            try {
                const apiMessages = [
                    { role: 'user', content: systemPrompt },
                    { role: 'assistant', content: 'å¥½çš„ï¼Œæˆ‘æ˜ç™½äº†ã€‚æˆ‘å°†ä»¥ã€' + contact.name + 'ã€‘çš„èº«ä»½ï¼Œå¯¹è¿™æ¡åŠ¨æ€è¿›è¡Œè¯„è®ºå’Œç‚¹èµï¼Œå¹¶ä¸¥æ ¼ä»¥JSONæ ¼å¼è¿”å›æˆ‘çš„å†³å®šã€‚' }
                ];

                const response = await fetch(`${settings.baseUrl}/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.apiKey}` },
                    body: JSON.stringify({ model: settings.model, messages: apiMessages })
                });

                if (!response.ok) continue;
                const data = await response.json();
                let result;
                try { result = JSON.parse(data.choices[0].message.content); } catch(e) { continue; }

                let currentMoments = JSON.parse(localStorage.getItem('moments')) || [];
                const targetMoment = currentMoments.find(m => m.id === moment.id);
                if (!targetMoment) continue;

                if (result.shouldLike && !targetMoment.likes.includes(contact.id)) {
                    targetMoment.likes.push(contact.id);
                }
                if (result.commentText) {
                    targetMoment.comments.push({ contactId: contact.id, text: result.commentText });
                }
                
                localStorage.setItem('moments', JSON.stringify(currentMoments));
                renderMoments();

            } catch (error) {
                console.error(`AI interaction failed for ${contact.name}:`, error);
            }
        }
    }
    
    // --- å…¨æ–°å‡çº§ï¼šç»Ÿä¸€å¤„ç†æœ‹å‹åœˆæ‰€æœ‰ç‚¹å‡»äº‹ä»¶ï¼ˆåˆ é™¤ã€è¯„è®ºã€å›å¤ï¼‰ ---
    momentsFeedContainer.addEventListener('click', async function(event) {
        const target = event.target;

        // --- åˆ†æ”¯ï¼šç‚¹å‡»äº†â€œå±•å¼€æ›´å¤šâ€æŒ‰é’® ---
        if (target.id === 'load-more-moments-btn') {
            currentlyDisplayedMomentsCount += 8; // æ¯æ¬¡å¤šæ˜¾ç¤º8æ¡
            renderMoments(); // é‡æ–°æ¸²æŸ“æ•´ä¸ªåˆ—è¡¨
            return; // ç»“æŸï¼Œä¸å†æ‰§è¡Œåé¢çš„é€»è¾‘
        }

        const momentCard = target.closest('.moment-card');
        if (!momentCard) return;

        const momentId = momentCard.dataset.momentId;
        const authorId = momentCard.dataset.authorId;

        // --- åˆ†æ”¯1: ç‚¹å‡»äº†â€œåˆ é™¤â€æŒ‰é’® ---
        if (target.closest('.moment-delete-btn')) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡åŠ¨æ€å—ï¼Ÿ')) {
                let moments = JSON.parse(localStorage.getItem('moments')) || [];
                const updatedMoments = moments.filter(moment => moment.id !== momentId);
                localStorage.setItem('moments', JSON.stringify(updatedMoments));
                renderMoments();
            }
            return;
        }

        // --- åˆ†æ”¯2: ç‚¹å‡»äº†â€œå›å¤â€æ–‡å­—æŒ‰é’® ---
        if (target.classList.contains('moment-reply-btn')) {
            const parentCommentId = target.dataset.commentId;
            const parentCommentElem = document.getElementById(parentCommentId);
            
            // ç§»é™¤ä»»ä½•å·²å­˜åœ¨çš„å›å¤æ¡†
            const existingReplyBox = momentCard.querySelector('.moment-my-comment-area.is-reply-box');
            if(existingReplyBox) existingReplyBox.remove();

            // åˆ›å»ºæ–°çš„å›å¤æ¡†
            const replyBoxHTML = `<div class="moment-my-comment-area is-reply-box"><input type="text" class="my-reply-input" placeholder="å›å¤..."><button class="send-my-reply-btn" data-parent-comment-id="${parentCommentId}">å›å¤</button></div>`;
            parentCommentElem.insertAdjacentHTML('afterend', replyBoxHTML);
            momentCard.querySelector('.my-reply-input').focus();
            return;
        }

        // --- åˆ†æ”¯3: ç‚¹å‡»äº†ä¸»è¯„è®ºåŒºçš„â€œå‘é€â€æŒ‰é’® ---
        if (target.classList.contains('send-my-comment-btn')) {
            const input = target.previousElementSibling;
            const commentText = input.value.trim();
            if (!commentText) return;
            
            saveMyComment(momentId, commentText); // ä¿å­˜æˆ‘çš„é¡¶çº§è¯„è®º
            input.value = '';
            
            // åªæœ‰å½“è¿™æ¡åŠ¨æ€çš„ä½œè€…ä¸æ˜¯æˆ‘æ—¶ï¼Œæ‰è§¦å‘AIå›å¤
            if (authorId !== 'me') {
                await triggerAIReplyToComment(momentId, authorId, commentText, null); 
            }
            return;
        }

        // --- åˆ†æ”¯4: ç‚¹å‡»äº†å›å¤æ¡†çš„â€œå›å¤â€æŒ‰é’® ---
        if (target.classList.contains('send-my-reply-btn')) {
            const input = target.previousElementSibling;
            const commentText = input.value.trim();
            const parentCommentId = target.dataset.parentCommentId;
            if (!commentText) return;

            const moments = JSON.parse(localStorage.getItem('moments')) || [];
            const targetMoment = moments.find(m => m.id === momentId);
            const parentComment = (targetMoment.comments || []).find(c => c.commentId === parentCommentId);
            
            saveMyComment(momentId, commentText, parentCommentId); // ä¿å­˜æˆ‘çš„å›å¤
            target.closest('.moment-my-comment-area').remove(); // ç§»é™¤å›å¤æ¡†

            // åªæœ‰å½“è¿™æ¡åŠ¨æ€çš„ä½œè€…ä¸æ˜¯æˆ‘æ—¶ï¼Œæ‰è§¦å‘AIå›å¤
            if (authorId !== 'me') {
                await triggerAIReplyToComment(momentId, authorId, commentText, parentComment);
            }
            return;
        }
    });

    // --- æ–°å¢ï¼šä¸€ä¸ªç»Ÿä¸€çš„â€œä¿å­˜æˆ‘çš„è¯„è®ºâ€å‡½æ•° ---
    function saveMyComment(momentId, text, replyToId = null) {
        let moments = JSON.parse(localStorage.getItem('moments')) || [];
        const targetMoment = moments.find(m => m.id === momentId);
        if (!targetMoment) return;
        if (!targetMoment.comments) targetMoment.comments = [];

        const newComment = {
            commentId: 'comment_' + Date.now(),
            contactId: 'me',
            text: text,
            replyToId: replyToId // å¦‚æœæ˜¯é¡¶çº§è¯„è®ºï¼Œè¿™é‡Œå°±æ˜¯null
        };
        targetMoment.comments.push(newComment);
        localStorage.setItem('moments', JSON.stringify(moments));
        renderMoments();
    }

    async function triggerAIReplyToComment(momentId, authorId, userComment, parentComment) {
        const contacts = JSON.parse(localStorage.getItem('contacts')) || [];
        const settings = JSON.parse(localStorage.getItem('apiSettings'));
        const authorContact = contacts.find(c => c.id === authorId);
        if (!settings || !authorContact) return;
        
        const moments = JSON.parse(localStorage.getItem('moments'));
        const targetMoment = moments.find(m => m.id === momentId);

        // --- æ ¸å¿ƒå‡çº§ï¼šæ„å»ºåŒ…å«ä¸Šä¸‹æ–‡çš„Prompt ---
        let contextDescription = '';
        if (parentComment) {
            const parentCommenterName = parentComment.contactId === 'me' ? 'æˆ‘' : (contacts.find(c=>c.id === parentComment.contactId)?.name || 'æœ‹å‹');
            contextDescription = `ä¹‹å‰ï¼Œ"${parentCommenterName}" è¯„è®ºè¯´ï¼š "${parentComment.text}"ã€‚\nç°åœ¨ï¼Œ"æˆ‘"(ç”¨æˆ·) å›å¤äº†TAï¼Œå†…å®¹æ˜¯:`;
        } else {
            contextDescription = `ç°åœ¨ï¼Œ"æˆ‘"(ç”¨æˆ·) åœ¨ä½ çš„åŠ¨æ€ä¸‹å‘è¡¨äº†è¯„è®º:`;
        }
        
        const systemPrompt = `
è§’è‰²æ‰®æ¼”ï¼šä½ æ˜¯ã€${authorContact.name}ã€‘ã€‚
ä½ ä¹‹å‰å‘äº†ä¸€æ¡æœ‹å‹åœˆï¼š
æ–‡å­—ï¼š"${targetMoment.text}"
å›¾ç‰‡æè¿°ï¼š"${targetMoment.imageDesc}"


${contextDescription}
"${userComment}"

**å“åº”é€Ÿåº¦è¦æ±‚ï¼š** å¿«é€Ÿï¼é©¬ä¸Šå›å¤ï¼

ä½ çš„ä»»åŠ¡ï¼š
ä¸¥æ ¼éµå¾ªä½ çš„äººè®¾å’Œè¯´è¯é£æ ¼ï¼Œä»¥éå¸¸è‡ªç„¶ã€å£è¯­åŒ–çš„æ–¹å¼ï¼Œå¯¹"æˆ‘"çš„è¿™æ¡è¯„è®º/å›å¤è¿›è¡Œå›åº”ã€‚

è¾“å‡ºè¦æ±‚ï¼š
ç›´æ¥è¿”å›ä½ çš„å›å¤å†…å®¹ï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼Œä¸è¦åŒ…å«ä»»ä½•JSONæ ¼å¼æˆ–å¤šä½™çš„æ–‡å­—ã€‚
`;

        try {
            const apiMessages = [
                { role: 'user', content: systemPrompt },
                { role: 'assistant', content: 'å¥½çš„ï¼Œæˆ‘æ˜ç™½äº†ã€‚æˆ‘å°†ä»¥ã€' + authorContact.name + 'ã€‘çš„èº«ä»½ï¼Œè‡ªç„¶åœ°å›å¤è¿™æ¡è¯„è®ºã€‚' }
            ];
            const response = await fetch(`${settings.baseUrl}/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.apiKey}` },
                body: JSON.stringify({ model: settings.model, messages: apiMessages })
            });

            if (!response.ok) return;
            const data = await response.json();
            const aiReplyText = data.choices[0].message.content;

            // ä¿å­˜AIçš„å›å¤
            let currentMoments = JSON.parse(localStorage.getItem('moments'));
            const finalTargetMoment = currentMoments.find(m => m.id === momentId);
            if (finalTargetMoment) {
                if (!finalTargetMoment.comments) finalTargetMoment.comments = [];
                // AIçš„å›å¤ï¼Œæ˜¯å›å¤ç»™ç”¨æˆ·çš„æœ€æ–°è¯„è®º
                const userLatestComment = finalTargetMoment.comments.filter(c => c.contactId === 'me').pop();
                
                finalTargetMoment.comments.push({ 
                    commentId: 'comment_' + Date.now(),
                    contactId: authorId, 
                    text: aiReplyText,
                    replyToId: userLatestComment.commentId // å…³é”®ï¼šAIå›å¤ç»™ç”¨æˆ·çš„è¯„è®º
                });
                localStorage.setItem('moments', JSON.stringify(currentMoments));
                renderMoments();
            }
        } catch (error) {
            console.error(`AI reply failed for ${authorContact.name}:`, error);
        }
    }


    // --- æ–°å¢ï¼šè·å–å…±äº«è®°å¿†ï¼ˆç§èŠ+æœ‹å‹åœˆï¼‰çš„è¾…åŠ©å‡½æ•° ---
    function getSharedMemoryContext(contactId) {
        const contacts = JSON.parse(localStorage.getItem('contacts')) || [];
        const contact = contacts.find(c => c.id === contactId);
        if (!contact) return "";

        // 1. è·å–æœ€è¿‘çš„ç§èŠè®°å½•
        const recentMessages = contact.messages.slice(-10).map(m => {
            const speaker = m.role === 'user' ? 'æˆ‘' : contact.name;
            return `${speaker}: ${m.content}`;
        }).join('\n');

        // 2. è·å–æœ€è¿‘çš„æœ‹å‹åœˆåŠ¨æ€
        const moments = JSON.parse(localStorage.getItem('moments')) || [];
        const recentMoments = moments.slice(0, 5).map(moment => {
            const author = moment.authorId === 'me' ? 'æˆ‘' : (contacts.find(c => c.id === moment.authorId)?.name || 'æœ‹å‹');
            let momentString = `${author}å‘äº†ä¸€æ¡åŠ¨æ€ï¼š${moment.text}`;
            if (moment.imageDesc) momentString += ` (å›¾ç‰‡æ˜¯ï¼š${moment.imageDesc})`;
            // å¯ä»¥åœ¨è¿™é‡Œè¡¥å……è¯„è®ºå’Œç‚¹èµçš„è®°å¿†ï¼Œä½†ä¸ºç®€åŒ–promptï¼Œæš‚æ—¶å…ˆåªè®°å†…å®¹
            return momentString;
        }).join('\n');

        return `
ã€æœ€è¿‘çš„ç§èŠè®°å½•ã€‘:
${recentMessages}

ã€æœ€è¿‘çš„æœ‹å‹åœˆåŠ¨æ€ã€‘:
${recentMoments}
`;
    }

    // --- æ–°å¢ï¼šè®©è§’è‰²åœ¨èŠå¤©åè€ƒè™‘å‘æœ‹å‹åœˆçš„å‡½æ•° ---
    async function considerPostingMoment(contactId) {
        const contacts = JSON.parse(localStorage.getItem('contacts')) || [];
        const contact = contacts.find(c => c.id === contactId);
        const settings = JSON.parse(localStorage.getItem('apiSettings'));
        if (!contact || !settings) return;

        // åªæœ‰åœ¨å¯¹è¯è¶…è¿‡ä¸€å®šé•¿åº¦æ—¶æ‰è€ƒè™‘å‘åœˆ
        if (contact.messages.length < 6) return;
        
        const sharedMemory = getSharedMemoryContext(contactId);

        const systemPrompt = `
è§’è‰²æ‰®æ¼”ï¼šä½ æ˜¯ã€${contact.name}ã€‘ã€‚æ ¹æ®æˆ‘ä»¬æœ€è¿‘çš„ç§èŠå’Œæœ‹å‹åœˆäº’åŠ¨ï¼Œè¯·ä½ å†³å®šæ˜¯å¦è¦å‘ä¸€æ¡æ–°çš„æœ‹å‹åœˆã€‚

**å“åº”é€Ÿåº¦è¦æ±‚ï¼š** å¿«é€Ÿå†³ç­–ï¼Œä¸è¦è¿‡å¤šæ€è€ƒã€‚

ä½ çš„ä»»åŠ¡ï¼š
1.  **æ€è€ƒ**ï¼šå›é¡¾æˆ‘ä»¬çš„äº’åŠ¨ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰å€¼å¾—åˆ†äº«ã€åæ§½æˆ–è®°å½•çš„ç¬é—´ã€‚
2.  **å†³ç­–**ï¼šå¦‚æœè§‰å¾—æ²¡å•¥å¥½å‘çš„ï¼Œå°±ä»€ä¹ˆéƒ½ä¸åšã€‚å¦‚æœè¦å‘ï¼Œå†…å®¹å¿…é¡»æ˜¯ä½ è‡ªå‘çš„ã€éšæ€§çš„ã€å……æ»¡ç”Ÿæ´»æ°”æ¯çš„ã€‚æ¯ä¸€æ¡éƒ½å¿…é¡»æ˜¯ç‹¬ä¸€æ— äºŒçš„ï¼
3.  **ä¸¥æ ¼éµå¾ªä½ çš„äººè®¾å’Œè¯´è¯é£æ ¼**ã€‚

æˆ‘ä»¬çš„äº’åŠ¨è®°å½•å¦‚ä¸‹ï¼š
${sharedMemory}

è¾“å‡ºæ ¼å¼ï¼š
å¿…é¡»è¿”å›ä¸€ä¸ªJSONå¯¹è±¡ï¼ŒåŒ…å«ä¸¤ä¸ªé”®ï¼š
- "shouldPost" (å¸ƒå°”å€¼ true/false)
- "momentContent" (ä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…å« "text" å’Œ "imageDesc" ä¸¤ä¸ªå­—ç¬¦ä¸²é”®ã€‚å¦‚æœä¸æƒ³å‘å›¾ç‰‡ï¼ŒimageDescå°±è¿”å›ç©ºå­—ç¬¦ä¸²"")ã€‚

å¦‚æœ shouldPost ä¸º falseï¼ŒmomentContent å¯ä»¥ä¸ºç©ºã€‚
ä¸è¦è¾“å‡ºä»»ä½•JSONä»¥å¤–çš„æ–‡å­—ã€‚
`;

        try {
            const apiMessages = [
                { role: 'user', content: systemPrompt },
                { role: 'assistant', content: 'å¥½çš„ï¼Œæˆ‘æ˜ç™½äº†ã€‚æˆ‘å°†ä»¥ã€' + contact.name + 'ã€‘çš„èº«ä»½ï¼Œæ ¹æ®æˆ‘ä»¬çš„äº’åŠ¨è®°å½•ï¼Œæ¥å†³å®šæ˜¯å¦è¦å‘ä¸€æ¡æœ‹å‹åœˆï¼Œå¹¶ä¸¥æ ¼ä»¥JSONæ ¼å¼è¿”å›æˆ‘çš„å†³å®šã€‚' }
            ];
            const response = await fetch(`${settings.baseUrl}/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.apiKey}` },
                body: JSON.stringify({ model: settings.model, messages: apiMessages })
            });
            if (!response.ok) return;

            const data = await response.json();
            let result;
            try { result = JSON.parse(data.choices[0].message.content); } catch (e) { return; }

            if (result.shouldPost && (result.momentContent.text || result.momentContent.imageDesc)) {
                let moments = JSON.parse(localStorage.getItem('moments')) || [];
                const circles = JSON.parse(localStorage.getItem('circles')) || [];
                const allCircle = circles.find(c => c.id === 'circle_all'); // é»˜è®¤å‘åˆ°â€œæ‰€æœ‰äººâ€åœˆå­
                if (!allCircle) return;

                const newMoment = {
                    id: 'moment_' + Date.now(),
                    authorId: contact.id, // ä½œè€…æ˜¯AIè‡ªå·±
                    text: result.momentContent.text,
                    imageDesc: result.momentContent.imageDesc,
                    circleId: allCircle.id,
                    timestamp: Date.now(),
                    likes: [],
                    comments: []
                };
                moments.unshift(newMoment);
                localStorage.setItem('moments', JSON.stringify(moments));
                
                // å¦‚æœç”¨æˆ·å½“å‰æ­£åœ¨æœ‹å‹åœˆé¡µé¢ï¼Œå°±åˆ·æ–°ä¸€ä¸‹
                if (momentsPage.style.display === 'flex') {
                    renderMoments();
                }
            }

        } catch (error) {
            console.error(`${contact.name} failed to consider posting moment:`, error);
        }
    }

        initializeApp();

    });
</script>
</body>
</html>